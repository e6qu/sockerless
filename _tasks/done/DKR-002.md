# DKR-002: Docker backend all operations passthrough

**Component:** Docker Daemon Backend
**Phase:** 1
**Depends on:** DKR-001
**Estimated effort:** L

---

## Description

Implement all internal API operations in the Docker backend as passthrough calls to the real Docker daemon via the Docker Go SDK. Every internal API endpoint translates to one or more Docker SDK method calls. This includes containers (create, start, inspect, list, stop, kill, remove, wait, logs), exec (create, inspect), images (pull, inspect, load, tag, auth), networks (create, list, inspect, disconnect, remove, prune), and volumes (create, list, inspect, remove).

This is the reference implementation. If the black-box test suite passes against the Docker backend, the API contract is proven correct against a real Docker daemon.

---

## Context

### Docker backend as reference (Spec Section 9.3)

> The Docker backend is the **reference implementation** for testing. Running the test suite against the Docker backend validates that sockerless produces responses identical to a real Docker daemon.

| Docker Concept | Docker SDK Mapping |
|---|---|
| Container create | `client.ContainerCreate(ctx, config, hostConfig, networkingConfig, platform, name)` |
| Container start | `client.ContainerStart(ctx, id, options)` |
| Container inspect | `client.ContainerInspect(ctx, id)` |
| Container list | `client.ContainerList(ctx, options)` |
| Container stop | `client.ContainerStop(ctx, id, options)` |
| Container kill | `client.ContainerKill(ctx, id, signal)` |
| Container remove | `client.ContainerRemove(ctx, id, options)` |
| Container wait | `client.ContainerWait(ctx, id, condition)` |
| Container logs | `client.ContainerLogs(ctx, id, options)` |
| Exec create | `client.ContainerExecCreate(ctx, id, config)` |
| Exec inspect | `client.ContainerExecInspect(ctx, id)` |
| Image pull | `client.ImagePull(ctx, ref, options)` |
| Image inspect | `client.ImageInspectWithRaw(ctx, id)` |
| Image load | `client.ImageLoad(ctx, input, quiet)` |
| Image tag | `client.ImageTag(ctx, source, target)` |
| Auth | `client.RegistryLogin(ctx, auth)` |
| Network create | `client.NetworkCreate(ctx, name, options)` |
| Network list | `client.NetworkList(ctx, options)` |
| Network inspect | `client.NetworkInspectWithRaw(ctx, id, options)` |
| Network disconnect | `client.NetworkDisconnect(ctx, networkID, containerID, force)` |
| Network remove | `client.NetworkRemove(ctx, id)` |
| Network prune | `client.NetworksPrune(ctx, pruneFilters)` |
| Volume create | `client.VolumeCreate(ctx, options)` |
| Volume list | `client.VolumeList(ctx, options)` |
| Volume inspect | `client.VolumeInspectWithRaw(ctx, id)` |
| Volume remove | `client.VolumeRemove(ctx, id, force)` |

### Type mapping

The Docker Go SDK uses its own types (`container.Config`, `container.HostConfig`, `network.NetworkingConfig`, etc.). These must be mapped to/from the internal API types defined in API-001.

### Error mapping (Spec Section 5.4)

Docker SDK errors must be mapped to internal error types:

| Docker SDK Check | Internal Error Type | HTTP Status |
|---|---|---|
| `errdefs.IsNotFound(err)` | `NotFoundError` | 404 |
| `errdefs.IsConflict(err)` | `ConflictError` | 409 |
| `errdefs.IsNotModified(err)` | (304 Not Modified) | 304 |
| `errdefs.IsForbidden(err)` | `ForbiddenError` | 403 |
| `errdefs.IsInvalidParameter(err)` | `BadRequestError` | 400 |
| Other errors | `InternalError` | 500 |

### Streaming operations

Container logs and container wait are streaming/long-lived operations:
- **Logs:** `client.ContainerLogs()` returns an `io.ReadCloser` with the multiplexed stream. For the internal API, this stream is forwarded as-is to the frontend.
- **Wait:** `client.ContainerWait()` returns channels `(<-chan container.WaitResponse, <-chan error)`. The backend blocks until the channel produces a result.

---

## Acceptance Criteria

### Container Operations

1. `POST /internal/v1/containers` calls `client.ContainerCreate` with the full config, hostConfig, and networkingConfig translated from internal types to Docker SDK types. Returns `{"Id": "<id>", "Warnings": [...]}`.
2. `POST /internal/v1/containers/{id}/start` calls `client.ContainerStart`. Returns `204`. Returns `304` if already started.
3. `GET /internal/v1/containers/{id}` calls `client.ContainerInspect` and maps the response to internal types. Returns full container state.
4. `GET /internal/v1/containers` calls `client.ContainerList` with filters translated from internal format. Returns array of container summaries.
5. `POST /internal/v1/containers/{id}/stop` calls `client.ContainerStop` with timeout. Returns `204`.
6. `POST /internal/v1/containers/{id}/kill` calls `client.ContainerKill`. Returns `204`.
7. `DELETE /internal/v1/containers/{id}` calls `client.ContainerRemove` with force and volume removal options. Returns `204`.
8. `WS /internal/v1/containers/{id}/wait` calls `client.ContainerWait` and returns `{"StatusCode": N}` when the container exits.
9. `GET /internal/v1/containers/{id}/logs` calls `client.ContainerLogs` with stdout, stderr, follow, tail, timestamps options. Returns the log stream.

### Exec Operations

10. `POST /internal/v1/containers/{id}/exec` calls `client.ContainerExecCreate` with cmd, env, workdir, tty, attach options. Returns `{"Id": "<exec-id>"}`.
11. `GET /internal/v1/exec/{id}` calls `client.ContainerExecInspect`. Returns exec state with Running, ExitCode.

### Image Operations

12. `POST /internal/v1/images/pull` calls `client.ImagePull` with registry auth. Returns streaming JSON progress.
13. `GET /internal/v1/images/{name}` calls `client.ImageInspectWithRaw`. Returns image metadata.
14. `POST /internal/v1/images/load` calls `client.ImageLoad` with tar input stream. Returns load response.
15. `POST /internal/v1/images/{name}/tag` calls `client.ImageTag`. Returns `201`.
16. `POST /internal/v1/auth` calls `client.RegistryLogin`. Returns `{"Status": "Login Succeeded"}`.

### Network Operations

17. `POST /internal/v1/networks` calls `client.NetworkCreate`. Returns `{"Id": "<id>", "Warning": ""}`.
18. `GET /internal/v1/networks` calls `client.NetworkList` with filters. Returns array.
19. `GET /internal/v1/networks/{id}` calls `client.NetworkInspectWithRaw`. Returns network details.
20. `POST /internal/v1/networks/{id}/disconnect` calls `client.NetworkDisconnect`. Returns `200`.
21. `DELETE /internal/v1/networks/{id}` calls `client.NetworkRemove`. Returns `204`.
22. `POST /internal/v1/networks/prune` calls `client.NetworksPrune`. Returns `{"NetworksDeleted": [...]}`.

### Volume Operations

23. `POST /internal/v1/volumes` calls `client.VolumeCreate`. Returns volume object.
24. `GET /internal/v1/volumes` calls `client.VolumeList`. Returns `{"Volumes": [...], "Warnings": []}`.
25. `GET /internal/v1/volumes/{name}` calls `client.VolumeInspectWithRaw`. Returns volume metadata.
26. `DELETE /internal/v1/volumes/{name}` calls `client.VolumeRemove`. Returns `204`.

### Error Handling

27. Docker SDK `NotFound` errors map to `404` with `{"message": "No such container: <id>"}` (or image/network/volume).
28. Docker SDK `Conflict` errors map to `409` with appropriate message.
29. Docker SDK `NotModified` errors map to `304`.

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] New black-box REST tests written for new/changed behavior (in `tests/` module)
- [ ] Tests run against memory backend by default
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Custom error types used for all domain errors (not bare `errors.New`)
- [ ] Errors wrapped with context: `fmt.Errorf("operation: %w", err)`
- [ ] Zerolog structured logging on all error paths
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` updated

### Integration
- [ ] No breaking changes to the internal API contract
- [ ] Capability model updated if new backend capabilities are added

### Task-Specific
- [ ] Full container lifecycle passes when Docker daemon is running
- [ ] Type mapping covers all fields used by CI runners
- [ ] Error mapping covers NotFound, Conflict, NotModified, InvalidParameter
- [ ] Streaming operations (logs, wait) work correctly

---

## Suggested File Paths

```
backends/docker/
├── containers.go              # Container CRUD: create, inspect, list, start, stop, kill, remove
├── containers_stream.go       # Container streaming: logs, wait
├── exec.go                    # Exec create, inspect
├── images.go                  # Image pull, inspect, load, tag, auth
├── networks.go                # Network create, list, inspect, disconnect, remove, prune
├── volumes.go                 # Volume create, list, inspect, remove
├── types.go                   # Type mapping functions: internal <-> Docker SDK types
└── errors.go                  # (extended) Docker SDK error -> internal error mapping
```

---

## Notes

- Type mapping is the bulk of the work. Create dedicated functions: `toDockerConfig(internal) -> docker`, `fromDockerInspect(docker) -> internal`, etc. Put these in `types.go`.
- For `ContainerCreate`, Docker SDK requires separate `container.Config`, `container.HostConfig`, and `network.NetworkingConfig` arguments. Extract these from the internal `ContainerCreateRequest`.
- Docker SDK's `ContainerList` returns `[]types.Container` (Docker types). Map each to the internal `ContainerListEntry`.
- For log streaming, `client.ContainerLogs()` returns an `io.ReadCloser`. For non-follow mode, read all and return. For follow mode, stream chunks as they arrive (this maps to the WebSocket streaming endpoint).
- For `ContainerWait`, the Docker SDK returns two channels. Select on both and return whichever fires first.
- Image pull returns an `io.ReadCloser` with JSON progress lines. Stream these through to the internal API response.
- The `platform` parameter on `ContainerCreate` can use `ocispec.Platform{OS: "linux", Architecture: "amd64"}` or `nil`.
- Registry auth for image pull comes from the request (via `X-Registry-Auth` in Docker API, translated by frontend). Pass it to `client.ImagePull` as `image.PullOptions{RegistryAuth: encodedAuth}`.
- This task depends on Docker being installed. Mark tests that require Docker with a build tag or skip mechanism: `if os.Getenv("DOCKER_HOST") == "" { t.Skip("Docker not available") }`.
