# FE-017: Registry auth

**Component:** FE (Docker REST API frontend)
**Phase:** 1
**Depends on:** FE-001
**Estimated effort:** S

---

## Description

Implement the registry authentication endpoint (`POST /auth`). This endpoint validates credentials against a container registry and stores them for later use with `POST /images/create` (image pull). GitHub Actions Runner uses this via `docker login` before pulling private images. The credentials are stored in the backend's state and associated with the registry server address for automatic use during subsequent pulls.

---

## Context

### Auth endpoint (Spec Section 4.2)

> `POST /auth` -- Registry Authentication
>
> Validates credentials against a registry. Used by GitHub Actions Runner's `docker login`.
>
> Request body: `{"username":"...","password":"...","serveraddress":"..."}`
> Response: `{"Status": "Login Succeeded"}`
>
> Store credentials for later use with `POST /images/create`.

### GitHub Runner auth usage (Spec Section 13.2.2)

> ```
> | `docker login` | `POST /auth` |
> ```
>
> GitHub Actions Runner shells out to `docker login` before pulling images from authenticated registries.

### GitHub Runner requirements (Spec Section 13.2.5)

> | `POST /auth` (docker login) | P1 | Store credentials for later pull operations |

### X-Registry-Auth header relationship (Spec Section 4.2)

> Headers for POST /images/create:
> - `X-Registry-Auth`: Base64-encoded JSON credentials (`{"username":"...","password":"...","serveraddress":"..."}`)
>
> The credentials stored from `POST /auth` should be automatically used when the `X-Registry-Auth` header is not provided during image pull, matching the registry's server address.

---

## Acceptance Criteria

1. `POST /auth` accepts a JSON body with fields: `username` (string), `password` (string), `serveraddress` (string).
2. The `serveraddress` field may be a full URL (`https://registry.example.com`) or just a hostname (`registry.example.com`).
3. On success, returns `200 OK` with body `{"Status": "Login Succeeded"}`.
4. Credentials are stored in the backend's state, keyed by the normalized server address.
5. Stored credentials are used automatically by `POST /images/create` when pulling from the same registry and no `X-Registry-Auth` header is provided.
6. If `username` or `password` is empty, return `401 Unauthorized` with `{"message": "unauthorized: authentication required"}`.
7. The `email` field is accepted but ignored (legacy Docker field).
8. The `identitytoken` field is accepted as an alternative to `username`/`password` (for token-based auth).
9. Multiple credentials for different registries can be stored simultaneously.
10. Storing credentials for the same server address replaces the previous credentials.
11. Credentials are not logged (security: never log passwords or tokens).

### Example Requests

```bash
# Login to Docker Hub
curl -s -X POST --unix-socket /var/run/sockerless.sock \
  -H "Content-Type: application/json" \
  -d '{
    "username": "myuser",
    "password": "mytoken",
    "serveraddress": "https://index.docker.io/v1/"
  }' \
  http://localhost/v1.44/auth
# Response: 200 OK
# {"Status":"Login Succeeded"}

# Login to a private registry
curl -s -X POST --unix-socket /var/run/sockerless.sock \
  -H "Content-Type: application/json" \
  -d '{
    "username": "deploy",
    "password": "s3cret-tok3n",
    "serveraddress": "https://registry.example.com"
  }' \
  http://localhost/v1.44/auth
# Response: 200 OK
# {"Status":"Login Succeeded"}

# Login to GitHub Container Registry
curl -s -X POST --unix-socket /var/run/sockerless.sock \
  -H "Content-Type: application/json" \
  -d '{
    "username": "github-user",
    "password": "ghp_xxxxxxxxxxxx",
    "serveraddress": "https://ghcr.io"
  }' \
  http://localhost/v1.44/auth
# Response: 200 OK
# {"Status":"Login Succeeded"}

# Login with empty credentials
curl -s -X POST --unix-socket /var/run/sockerless.sock \
  -H "Content-Type: application/json" \
  -d '{
    "username": "",
    "password": "",
    "serveraddress": "https://registry.example.com"
  }' \
  http://localhost/v1.44/auth
# Response: 401 Unauthorized
# {"message":"unauthorized: authentication required"}

# Login with identity token (e.g., AWS ECR, Azure ACR)
curl -s -X POST --unix-socket /var/run/sockerless.sock \
  -H "Content-Type: application/json" \
  -d '{
    "identitytoken": "eyJhbGciOiJSUzI1NiIs...",
    "serveraddress": "https://123456789.dkr.ecr.us-east-1.amazonaws.com"
  }' \
  http://localhost/v1.44/auth
# Response: 200 OK
# {"Status":"Login Succeeded"}
```

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] New black-box REST tests written for: login success, login with empty credentials, login with identity token, credentials replace on same server, credentials used by subsequent pull
- [ ] Tests run against memory backend by default
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Custom error types used for all domain errors
- [ ] Errors wrapped with context: `fmt.Errorf("registry auth: %w", err)`
- [ ] Zerolog structured logging on all error paths (credentials NEVER logged)
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` updated if new public API is added

### Integration
- [ ] No breaking changes to the internal API contract
- [ ] Stored credentials accessible to FE-014 (image pull) for automatic auth

---

## Suggested File Paths

```
frontends/docker/
├── handler_auth.go           # POST /auth handler
├── credentials.go            # Credential storage and lookup by server address
└── routes.go                 # Register new route (update existing)
```

---

## Notes

- Docker's `POST /auth` in practice does NOT actually validate credentials against the registry in many cases. The Docker daemon stores them and returns "Login Succeeded" optimistically. Sockerless can follow the same pattern -- store credentials without remote validation. Actual validation happens during `POST /images/create` when the registry is contacted.
- The `serveraddress` field normalization is important. `https://index.docker.io/v1/`, `https://index.docker.io/v1`, `index.docker.io`, and `docker.io` should all map to Docker Hub credentials.
- Never log `password` or `identitytoken` fields. Log `username` and `serveraddress` at debug level only.
- The credentials store should be thread-safe (accessed concurrently by auth and pull handlers).
- Docker also accepts a `registrytoken` field for OAuth2 tokens. Accept and store it if present.
- The memory backend can store credentials in a simple in-memory map. Cloud backends may want to store credentials in a secret manager (future enhancement, not required for Phase 1).
- GitHub Runner uses `docker login` which sends `POST /auth`. GitLab Runner uses `X-Registry-Auth` header directly on pull requests. Both patterns must work.
