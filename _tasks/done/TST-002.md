# TST-002: System endpoint tests

**Component:** Test Infrastructure and Suites
**Phase:** 1
**Depends on:** TST-001, FE-003
**Estimated effort:** S

---

## Description

Black-box tests for the system endpoints: `GET /_ping`, `HEAD /_ping`, `GET /version`, and `GET /info`. These are the simplest endpoints and serve as the smoke test that the frontend is alive and responding correctly. Tests verify response bodies, HTTP headers, and status codes.

---

## Context

### System endpoints (Spec Section 4.1)

**`GET /_ping` / `HEAD /_ping`**

Returns `OK` (plain text). Headers:
```
API-Version: 1.44
Docker-Experimental: false
Ostype: linux
Builder-Version: 0
```

Used by Docker SDK for API version negotiation. Must respond fast (no backend calls).

**`GET /version`**

```json
{
  "Platform": { "Name": "Sockerless" },
  "Version": "0.1.0",
  "ApiVersion": "1.44",
  "MinAPIVersion": "1.44",
  "Os": "linux",
  "Arch": "amd64",
  "KernelVersion": "",
  "BuildTime": "2026-02-15T00:00:00.000000000+00:00",
  "Components": [
    {
      "Name": "Sockerless",
      "Version": "0.1.0",
      "Details": {
        "Backend": "<configured-backend-name>"
      }
    }
  ]
}
```

**`GET /info`**

Key fields that CI runners read:

| Field | Expected Value |
|-------|---------------|
| `OSType` | `"linux"` |
| `Architecture` | `"x86_64"` |
| `ServerVersion` | `"0.1.0"` |
| `Swarm.LocalNodeState` | `"inactive"` |
| `DefaultRuntime` | `"sockerless"` |

### Testing conventions (CONVENTIONS.md)

- Black-box REST tests only, all in the `tests/` module
- Tests hit the HTTP endpoint via Unix socket or TCP
- Each test creates its own resources and cleans up
- Use `testing.T` with subtests (`t.Run`)
- Default: run against memory backend

---

## Acceptance Criteria

1. `GET /_ping` returns status `200` with body `OK` (plain text, not JSON).
2. `GET /_ping` response includes header `API-Version: 1.44`.
3. `GET /_ping` response includes header `Docker-Experimental: false`.
4. `GET /_ping` response includes header `Ostype: linux`.
5. `HEAD /_ping` returns status `200` with the same headers as GET but an empty body.
6. `GET /version` returns status `200` with valid JSON containing fields: `ApiVersion` (string `"1.44"`), `Os` (string), `Arch` (string), `Version` (string).
7. `GET /version` JSON includes `Platform.Name` set to `"Sockerless"`.
8. `GET /version` JSON includes `Components` array with at least one entry whose `Name` is `"Sockerless"`.
9. `GET /info` returns status `200` with valid JSON.
10. `GET /info` JSON includes `OSType: "linux"`, confirming container OS type for CI runners.
11. `GET /info` JSON includes `Swarm.LocalNodeState: "inactive"`.
12. `GET /info` JSON includes `ServerVersion` as a non-empty string.
13. Versioned paths work: `GET /v1.44/_ping` returns the same response as `GET /_ping`.

### Example Requests

```bash
# GET /_ping
curl --unix-socket /var/run/sockerless.sock http://localhost/_ping -v
# Expected: 200 OK
# < API-Version: 1.44
# < Docker-Experimental: false
# < Ostype: linux
# OK

# HEAD /_ping
curl --unix-socket /var/run/sockerless.sock http://localhost/_ping -I
# Expected: 200
# API-Version: 1.44
# Docker-Experimental: false
# Ostype: linux
# (no body)

# GET /version
curl --unix-socket /var/run/sockerless.sock http://localhost/version | jq .
# Expected: 200
# {
#   "Platform": {"Name": "Sockerless"},
#   "Version": "0.1.0",
#   "ApiVersion": "1.44",
#   "MinAPIVersion": "1.44",
#   "Os": "linux",
#   "Arch": "amd64",
#   ...
# }

# GET /info
curl --unix-socket /var/run/sockerless.sock http://localhost/info | jq '{OSType, ServerVersion, Swarm}'
# Expected: 200
# {
#   "OSType": "linux",
#   "ServerVersion": "0.1.0",
#   "Swarm": { "LocalNodeState": "inactive" }
# }

# Versioned path
curl --unix-socket /var/run/sockerless.sock http://localhost/v1.44/_ping
# Expected: 200 OK
```

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] New black-box REST tests written for new/changed behavior (in `tests/` module)
- [ ] Tests run against memory backend by default
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Custom error types used for all domain errors (not bare `errors.New`)
- [ ] Errors wrapped with context: `fmt.Errorf("operation: %w", err)`
- [ ] Zerolog structured logging on all error paths
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` created or updated (if this task creates or modifies a module)

### Integration
- [ ] No breaking changes to the internal API contract
- [ ] Capability model updated if new backend capabilities are added

### Task-Specific
- [ ] All 13 acceptance criteria pass
- [ ] Tests run in <1 second total
- [ ] Tests pass against both memory and Docker backends

---

## Suggested File Paths

```
tests/
├── system_test.go             # TestPingGET, TestPingHEAD, TestVersion, TestInfo, TestPingVersioned
└── helpers/
    └── client.go              # (from TST-001) HTTP client helper used by these tests
```

---

## Notes

- These tests do not create any resources, so no cleanup is needed.
- The `/_ping` endpoint should NOT require a backend connection (it is handled entirely by the frontend). This makes it a good first smoke test.
- Use `t.Run` for subtests to test each header individually in the ping tests.
- The `Content-Type` for `/_ping` should be `text/plain; charset=utf-8`, not `application/json`.
- For `GET /info`, do not assert every field -- only assert the fields that CI runners rely on. The full response has many fields, most of which are informational.
- Consider adding a test for `GET /v1.99/_ping` returning `400` with the "too new" error message (this tests the version middleware from FE-001).
