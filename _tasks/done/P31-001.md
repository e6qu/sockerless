# P31-001: Fix bash/shell test failures (pwd returning host paths)

**Phase:** 31
**Status:** Done
**Date:** 2026-02-21

## Problem

`$(pwd)` in WASM sandbox returned the host temp directory path (e.g., `/var/folders/.../T/sandbox-123456`) instead of the container-relative path (e.g., `/tmp`). This caused upstream act tests `defaults-run` and `workdir` to fail.

## Root Cause

mvdan.cc/sh v3.12.0 handles `pwd` as a shell builtin that reads the `PWD` environment variable. The shell interpreter sets `PWD` to `r.Dir` (the host path) AFTER options are applied, making `interp.Env()` overrides ineffective. The exec handler `pwd` case was dead code — never reached.

## Fix

In `runShellInDir()`, prepend `PWD=<container-relative-path>` as a shell variable assignment at the start of every command. This overrides the shell's internal PWD before any script code runs.

Added `shellQuote()` helper for safe quoting of the path value.

## Files Changed

- `sandbox/shell.go` — `runShellInDir()`, `shellQuote()`

## Tests Added

- `TestDefaultsRunPwdCheck` — verifies pwd returns container path
- `TestWorkdirPwdBashTest` — verifies `[[ ]]` style pwd check
- `TestPwdInCommandSubstitution` — verifies `$(pwd)` in expressions
- `TestPwdStandaloneWithWorkDir` — verifies standalone pwd command
