# LAM-001: Lambda backend

**Component:** LAM (AWS Lambda backend)
**Phase:** 4
**Depends on:** API-002
**Estimated effort:** L

---

## Description

Build the AWS Lambda backend for Sockerless. This backend translates internal API calls into AWS Lambda operations, running containers as Lambda functions using container image support. Unlike container-based backends (ECS, Cloud Run, ACA), Lambda is a FaaS backend with hard limitations: no exec, no attach, no long-running containers (15-minute maximum), no volumes, no networks, and no health checks. The backend reports these reduced capabilities so the frontend can return `501 Not Implemented` for unsupported operations.

Lambda functions are created from container images stored in ECR, invoked synchronously or asynchronously, and their output is retrieved from CloudWatch Logs. The agent is NOT required -- there is no mechanism for exec or attach in a Lambda execution environment.

This backend is suitable for short-lived, fire-and-forget container workloads such as batch processing, webhooks, and scheduled tasks. It is NOT compatible with CI runners (GitLab Runner, GitHub Actions Runner).

---

## Context

### Lambda backend mapping (Spec Section 9.2)

> | Docker Concept | Lambda Mapping |
> |---|---|
> | Container create + start | Create/update Lambda function + invoke |
> | Container stop/kill | N/A (function exits on its own) |
> | Container logs | CloudWatch Logs |
> | Exec / Attach | **Not supported** (reported via capabilities) |
> | Image pull | Lambda pulls container images from ECR |
> | Max timeout | 15 minutes |
>
> **Capabilities:** `exec: false, attach: false, logs: true, logs_follow: false, max_timeout_seconds: 900, agent_required: false`

### Capability reporting (Spec Section 9.5)

> | Capability | Lambda |
> |---|:---:|
> | Long-running | No (15m) |
> | Exec | **No** |
> | Attach | **No** |
> | Log stream | Yes |
> | Log follow | No |
> | Volumes | No |
> | Networks | No |
> | Health checks | No |
> | Agent needed | No |
> | Startup latency | 1-5s |

### FaaS backend compatibility (Spec Section 13.4)

> FaaS backends (Lambda, Cloud Run Functions, Azure Functions) are NOT compatible with CI runners. This is a hard architectural limitation.
>
> Capability reporting prevents silent failures: FaaS backends report `exec: false, attach: false` in their capabilities. When the frontend receives an exec or attach request, it returns `501 Not Implemented` with `{"message":"This backend (lambda) does not support exec. CI runners require exec-capable backends (ecs, cloudrun, aca, docker)."}`.
>
> FaaS backends ARE useful for: Short-lived, fire-and-forget container workloads that don't need exec or attach -- batch processing, webhooks, scheduled tasks.

### Backend configuration (Spec Section 15.3)

> Configuration follows the standard backend YAML format with Lambda-specific fields:
> ```yaml
> lambda:
>   region: us-east-1
>   role_arn: "arn:aws:iam::..."       # Lambda execution role
>   log_group: /sockerless/lambda       # CloudWatch Logs group
>   memory_size: 1024                   # MB (128-10240)
>   timeout: 900                        # seconds (max 900)
>   subnet_ids: []                      # Optional VPC subnets
>   security_group_ids: []              # Optional VPC security groups
> ```

---

## Acceptance Criteria

1. `sockerless-backend-lambda` binary compiles and runs from `cmd/sockerless-backend-lambda/main.go`.
2. Server listens on a Unix socket (default `/var/run/sockerless-backend.sock`) or TCP address for internal API requests.
3. AWS SDK v2 clients are initialized for: `lambda` and `cloudwatchlogs`.
4. Configuration loads from YAML file, environment variables, and CLI flags (priority: flags > env > file > defaults). Required config: `region`, `role_arn`. Optional: `log_group` (default `/sockerless/lambda`), `memory_size` (default `1024`), `timeout` (default `900`), `subnet_ids`, `security_group_ids`.
5. `GET /internal/v1/capabilities` returns the capability JSON with `backend: "lambda"`, `agent_required: false`, `exec: false`, `attach: false`, `logs: true`, `logs_follow: false`, `volumes: false`, `networks: false`, `health_checks: false`, `max_timeout_seconds: 900`.
6. Container create maps to creating/updating a Lambda function from a container image URI (ECR). The container's `Image` field is used as the Lambda function's image URI. Returns a 64-char hex container ID.
7. Container start maps to invoking the Lambda function (synchronous `RequestResponse` or asynchronous `Event` invocation type). The function begins execution.
8. Container logs retrieves output from CloudWatch Logs using `GetLogEvents` / `FilterLogEvents`. Supports `tail` and `timestamps` parameters. Does NOT support `follow` (returns immediately with available logs).
9. Container wait returns the Lambda function's exit status (0 for success, non-zero for failure/timeout) once invocation completes.
10. Container stop/kill are no-ops -- Lambda functions cannot be stopped mid-execution. Return success (idempotent).
11. Container remove cleans up the Lambda function (`DeleteFunction`) and removes state store entry.
12. Exec create, exec start, and attach requests return `501 Not Implemented` with message: `"This backend (lambda) does not support exec. CI runners require exec-capable backends (ecs, cloudrun, aca, docker)."` (or similar for attach).
13. Image operations: image pull is a no-op (Lambda pulls from ECR natively), image inspect returns stored metadata.
14. Network and volume operations return `501 Not Implemented`.
15. In-memory or SQLite state store maps `container_id -> {function_name, function_arn, log_stream, invocation_status, ...}` and `image_ref -> {config, digest, ...}`.
16. AWS SDK errors are mapped to Docker-compatible HTTP error responses: `{"message": "..."}`.
17. Graceful shutdown on SIGTERM/SIGINT: drain in-flight requests, clean exit.
18. All requests logged via zerolog with method, path, status code, duration, and AWS request IDs where applicable.

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] Unit tests for: configuration loading, capability reporting, state store CRUD, AWS error mapping, 501 responses for unsupported operations
- [ ] Tests use mock AWS clients (no real AWS calls in unit tests)
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] AWS SDK errors wrapped with context: `fmt.Errorf("lambda: create function: %w", err)`
- [ ] Zerolog structured logging on all error paths with AWS request IDs
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`
- [ ] Unsupported operations return 501 with descriptive message

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` created with Lambda backend overview, configuration, prerequisites, and limitations

### Integration
- [ ] Implements Backend interface from API-002 (unsupported methods return NotImplementedError)
- [ ] Capability model accurately reflects Lambda backend limitations

---

## Suggested File Paths

```
backends/lambda/
├── go.mod                              # module github.com/sockerless/backend-lambda, go 1.23
├── go.sum
├── README.md
├── server.go                           # HTTP server setup, route registration
├── capabilities.go                     # Capability reporting handler
├── config.go                           # YAML + env + flag config loading
├── aws.go                              # AWS SDK v2 client initialization (lambda, cloudwatchlogs)
├── containers.go                       # Container create (CreateFunction), start (Invoke), stop (no-op), remove (DeleteFunction)
├── logs.go                             # CloudWatch Logs retrieval (GetLogEvents)
├── store.go                            # State store (container_id -> function ARN mapping)
├── errors.go                           # AWS error -> HTTP error mapping
├── unsupported.go                      # 501 handlers for exec, attach, networks, volumes
└── cmd/
    └── sockerless-backend-lambda/
        └── main.go                     # Binary entrypoint
```

---

## Notes

- Use AWS SDK v2 (`github.com/aws/aws-sdk-go-v2/...`). SDK v1 is in maintenance mode.
- Lambda container image support requires images in ECR. The image must implement the Lambda Runtime API, OR the function must be invoked with a custom runtime. For Sockerless, container images should use the Lambda container image format with an appropriate entrypoint.
- Lambda function names must be unique within a region. Use the sockerless container ID (truncated or hashed) as part of the function name to avoid collisions.
- CloudWatch Logs have a propagation delay (typically 1-5 seconds). Log retrieval may not return the most recent output immediately. Document this latency for users.
- Lambda cold starts add 1-5 seconds of latency on first invocation. Subsequent invocations may reuse warm execution environments.
- The state store must map between sockerless's 64-char hex IDs and Lambda function names/ARNs. Consider SQLite via `modernc.org/sqlite` (pure Go, no CGO) for persistence across restarts.
- Container stop/kill should be idempotent no-ops. Lambda functions run to completion or timeout -- there is no mechanism to cancel a running invocation from the caller side.
- Import `github.com/sockerless/api` for shared types and the `Backend` interface.
