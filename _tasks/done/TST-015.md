# TST-015: FaaS backend capability tests

**Component:** TST (Test infrastructure and suites)
**Phase:** 4
**Depends on:** LAM-001, GCF-001, AZF-001
**Estimated effort:** M

---

## Description

Build a parameterized test suite that validates FaaS backend behavior across all three FaaS backends (Lambda, Cloud Run Functions, Azure Functions). The tests verify that unsupported operations (exec, attach, networks, volumes, health checks) return `501 Not Implemented` with descriptive error messages, that supported operations (container create, start, logs, wait, remove) work correctly, and that the capability endpoint accurately reports reduced capabilities.

These tests are parameterized so they run against any FaaS backend by changing the target address. They complement the existing black-box REST test suite but focus specifically on FaaS-specific behavior: capability-limited operation, 501 responses, and the fire-and-forget container lifecycle (create, start, logs, wait, remove -- no exec or attach).

---

## Context

### FaaS backend capabilities (Spec Section 9.2)

> All FaaS backends share the same reduced capability set:
>
> | Capability | Lambda | CR Func | Az Func |
> |---|:---:|:---:|:---:|
> | exec | false | false | false |
> | attach | false | false | false |
> | logs | true | true | true |
> | logs_follow | false | false | false |
> | volumes | false | false | false |
> | networks | false | false | false |
> | health_checks | false | false | false |
> | agent_required | false | false | false |
>
> Backend-specific differences:
> - Lambda: `max_timeout_seconds: 900`, `backend: "lambda"`
> - Cloud Run Functions: `max_timeout_seconds: 3600`, `backend: "gcf"`
> - Azure Functions: `max_timeout_seconds: 600`, `backend: "azf"`

### Capability enforcement (Spec Section 13.4)

> Capability reporting prevents silent failures: FaaS backends report `exec: false, attach: false` in their capabilities. When the frontend receives an exec or attach request, it returns `501 Not Implemented` with `{"message":"This backend (<name>) does not support exec. CI runners require exec-capable backends (ecs, cloudrun, aca, docker)."}`.

### FaaS backend compatibility (Spec Section 9.5)

> | Capability | Lambda | CR Func | Az Func |
> |---|:---:|:---:|:---:|
> | Long-running | No (15m) | No (60m) | No (10m) |
> | Exec | **No** | **No** | **No** |
> | Attach | **No** | **No** | **No** |
> | Log stream | Yes | Yes | Yes |
> | Log follow | No | No | No |
> | Volumes | No | No | No |
> | Networks | No | No | No |
> | Health checks | No | No | No |
> | Agent needed | No | No | No |

### Testing strategy (CONVENTIONS.md)

> - Black-box REST tests only -- all tests in the `tests/` module
> - Tests hit the HTTP endpoint (via Unix socket or TCP)
> - Test binary accepts a `--socket` or `--addr` flag to target any backend
> - Table-driven style for parameterized scenarios
> - Each test creates its own resources and cleans up (no shared state between tests)

---

## Acceptance Criteria

### Capability Endpoint Tests

1. `GET /internal/v1/capabilities` returns 200 with valid JSON containing `backend`, `version`, and `capabilities` fields.
2. The `capabilities` object includes `exec: false`, `attach: false`, `logs: true`, `logs_follow: false`.
3. The `capabilities` object includes `volumes: false`, `networks: false`, `health_checks: false`.
4. The `capabilities` object includes `agent_required: false`.
5. The `capabilities` object includes a `max_timeout_seconds` value greater than 0 (backend-specific: 900, 3600, or 600).
6. The `backend` field matches the expected backend name (`"lambda"`, `"gcf"`, or `"azf"`).

### Unsupported Operation Tests (501 Not Implemented)

7. `POST /containers/{id}/exec` returns 501 with `{"message": "..."}` containing "does not support exec".
8. `POST /exec/{id}/start` returns 501 with `{"message": "..."}` containing "does not support exec".
9. `GET /exec/{id}/json` returns 501 with `{"message": "..."}` containing "does not support exec".
10. `POST /containers/{id}/attach` returns 501 with `{"message": "..."}` containing "does not support attach".
11. `POST /networks/create` returns 501 with `{"message": "..."}` containing "does not support" and "network".
12. `POST /volumes/create` returns 501 with `{"message": "..."}` containing "does not support" and "volume".

### Supported Operation Tests (FaaS Lifecycle)

13. `POST /containers/create` with a valid `Image` returns 201 with `{"Id": "<64-char-hex>", "Warnings": []}`.
14. `POST /containers/{id}/start` on a created container returns 204 (no content).
15. `GET /containers/{id}/json` on a started container returns 200 with container metadata including state information.
16. `GET /containers/{id}/logs` on a container that has produced output returns 200 with log content. Supports `tail` and `timestamps` query parameters.
17. `GET /containers/{id}/logs?follow=true` does NOT hang -- returns immediately with available logs (since `logs_follow: false`).
18. `POST /containers/{id}/wait` returns 200 with `{"StatusCode": <int>}` once the function completes.
19. `DELETE /containers/{id}` returns 204 and removes the container.
20. `GET /containers/json` lists containers; `GET /containers/json?all=true` includes stopped/completed containers.

### Container Stop/Kill No-Op Tests

21. `POST /containers/{id}/stop` on a running container returns 204 (success, idempotent no-op).
22. `POST /containers/{id}/kill` on a running container returns 204 (success, idempotent no-op).

### Image Operation Tests

23. `POST /images/create?fromImage=<image>` returns 200 (no-op pull, but returns success for FaaS backends).
24. `GET /images/{name}/json` on a known image returns 200 with image metadata.

### Error Response Format Tests

25. All 501 responses use Docker's error format: `{"message": "<descriptive error>"}`.
26. All 501 response messages include the backend name and suggest exec-capable backends.
27. Standard error cases (404 for unknown container, 409 for conflicts) use Docker's error format and appropriate status codes.

### Parameterization

28. All tests are parameterized to accept a backend address via `--addr` or `--socket` flag.
29. Tests detect the backend type from the capabilities endpoint and skip backend-specific assertions that don't apply (e.g., exact `max_timeout_seconds` value).
30. Tests that require real cloud resources (function deployment, invocation) are gated behind a `--integration` flag and skipped by default.

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] New FaaS capability tests pass against each FaaS backend (with `--integration` flag and real cloud credentials)
- [ ] Capability and 501-response tests can run without cloud credentials (against a locally-running backend with mock cloud clients)
- [ ] Tests are deterministic (no flaky tests)
- [ ] Each test creates its own resources and cleans up after itself

### Error Handling
- [ ] Custom error types used for all domain errors (not bare `errors.New`)
- [ ] Errors wrapped with context: `fmt.Errorf("operation: %w", err)`
- [ ] Zerolog structured logging on all error paths
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported test helper functions
- [ ] Test file header comments explaining the test suite scope and how to run against each backend

### Integration
- [ ] No breaking changes to the internal API contract
- [ ] Tests validate capability model correctness for all FaaS backends

---

## Suggested File Paths

```
tests/
├── faas_capability_test.go             # Capability endpoint tests (parameterized)
├── faas_unsupported_test.go            # 501 Not Implemented tests for exec, attach, networks, volumes
├── faas_lifecycle_test.go              # Supported operations: create, start, logs, wait, remove
├── faas_errors_test.go                 # Error response format validation
└── helpers/
    └── faas.go                         # FaaS-specific test helpers (detect backend, skip logic)
```

---

## Notes

- Tests should use the Docker client SDK (`github.com/docker/docker/client`) as the HTTP client, consistent with the rest of the test suite. This ensures tests validate Docker API compatibility.
- The `--integration` flag gates tests that make real cloud API calls (deploying functions, invoking them, reading logs). Without this flag, only capability reporting and 501-response tests run.
- For 501 response validation, the exact error message format should match the spec: `"This backend (<name>) does not support <operation>. CI runners require exec-capable backends (ecs, cloudrun, aca, docker)."` -- but tests should use substring matching (contains) rather than exact string matching for flexibility.
- Log retrieval tests may need to account for cloud logging propagation delays. Use polling with a timeout (e.g., retry for up to 30 seconds) when running integration tests against real backends.
- The test suite should detect the backend type by calling `GET /internal/v1/capabilities` first. This allows the same test binary to run against any FaaS backend without code changes -- only the target address changes.
- Table-driven tests with `t.Run` subtests are preferred for the 501-response tests, where the same assertion applies to multiple endpoints.
- Consider adding a test that performs the complete FaaS lifecycle: create -> start -> wait -> logs -> remove, validating each step. This serves as a smoke test for the entire backend.
- Tests should verify that `logs?follow=true` returns promptly (within a few seconds) rather than blocking indefinitely, since FaaS backends do not support log following.
