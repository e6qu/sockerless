# ACA-001: ACA backend scaffold

**Component:** ACA (Azure Container Apps backend)
**Phase:** 3
**Depends on:** API-002
**Estimated effort:** M

---

## Description

Build the scaffold for the Azure Container Apps (ACA) backend. This backend translates internal API calls into Azure Container Apps Jobs operations, running containers as job executions within a managed environment. This task sets up the binary entrypoint, Azure SDK for Go clients, configuration loading, capability reporting, and the HTTP server for the internal API. Individual operations (container create/start, logs, images, networking, volumes) are implemented in subsequent ACA-* tasks.

---

## Context

### ACA backend mapping (Spec Section 9.1)

> | Docker Concept | ACA Mapping |
> |---|---|
> | Container create + start | `Create Job` + `Start Job Execution` |
> | Container stop | `Stop Job Execution` |
> | Container logs | Azure Monitor / Log Analytics |
> | Exec / Attach | Via sockerless-agent (agent on container port, VNet accessible) |
> | Image pull | ACA pulls from ACR / Docker Hub natively |
> | Network | VNet integration (managed environment) |
> | Volume | Azure Files, ephemeral storage |
>
> **Agent networking:** Container Apps jobs run within a managed environment that is VNet-integrated. The agent listens on port 9111. The frontend must be able to reach the container's IP within the VNet (same VNet, peering, or VPN gateway).
>
> **Startup latency:** 10-60 seconds.

### Capability reporting (Spec Section 9.5)

ACA backend capabilities (derived from the backend comparison matrix):
```json
{
  "backend": "aca",
  "version": "0.1.0",
  "capabilities": {
    "exec": true,
    "attach": true,
    "logs": true,
    "logs_follow": true,
    "volumes": true,
    "networks": true,
    "health_checks": true,
    "image_pull": true,
    "image_load": true,
    "max_timeout_seconds": 0,
    "agent_required": true
  }
}
```

### ACA backend configuration (Spec Section 15.3 pattern)

> ```yaml
> aca:
>   subscription_id: "00000000-0000-0000-0000-000000000000"
>   resource_group: "sockerless-rg"
>   managed_environment_name: "sockerless-env"
>   location: "eastus"
>   log_analytics_workspace_id: "/subscriptions/.../workspaces/sockerless-logs"
>   storage_account_name: "sockerlessstorage"
>   storage_account_key: ""            # or use managed identity
>   registry_server: "sockerless.azurecr.io"
>   registry_username: ""              # or use managed identity
>   registry_password: ""
> ```

---

## Acceptance Criteria

1. `sockerless-backend-aca` binary compiles and runs from `cmd/sockerless-backend-aca/main.go`.
2. Server listens on a Unix socket (default `/var/run/sockerless-backend.sock`) or TCP address for internal API requests.
3. Azure SDK for Go clients are initialized for: `armappcontainers` (Container Apps Jobs management), `azmonitor` / `azquery` (Log Analytics query), `armstorage` (Azure Files), and `azcontainerregistry` (ACR).
4. Configuration loads from YAML file, environment variables, and CLI flags (priority: flags > env > file > defaults). Required config: `subscription_id`, `resource_group`, `managed_environment_name`, `location`. Optional: `log_analytics_workspace_id`, `storage_account_name`, `storage_account_key`, `registry_server`, `registry_username`, `registry_password`.
5. `GET /internal/v1/capabilities` returns the capability JSON with `backend: "aca"`, `agent_required: true`, and all container-backend capabilities `true`.
6. In-memory state store (or SQLite -- consistent with backend config from spec Section 15.3) for containers, images, networks, volumes, execs -- mapping sockerless IDs to Azure resource IDs/names.
7. State store maps: `container_id -> {job_name, execution_name, agent_address, agent_token, ...}`, `network_id -> {vnet_subnet_id, ...}`, `volume_name -> {file_share_name, ...}`, `image_ref -> {config, digest, ...}`.
8. Azure credentials are loaded via the standard `azidentity.NewDefaultAzureCredential()` chain (env vars, managed identity, Azure CLI, etc.).
9. Error responses use Docker's `{"message": "..."}` format. Azure SDK errors are mapped to appropriate HTTP status codes (e.g., `AuthenticationFailedError` -> 500, `ResourceNotFoundError` -> 500).
10. Graceful shutdown on SIGTERM/SIGINT: drain in-flight requests, clean exit.
11. All requests logged via zerolog with method, path, status code, duration, and Azure correlation IDs where applicable.

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] Unit tests for: configuration loading (YAML, env, flags, defaults), capability reporting, state store CRUD operations, Azure error mapping
- [ ] Tests use mock Azure clients (no real Azure calls in unit tests)
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Azure SDK errors wrapped with context: `fmt.Errorf("aca: describe job: %w", err)`
- [ ] Zerolog structured logging on all error paths with Azure correlation IDs
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` created with ACA backend overview, configuration, and prerequisites

### Integration
- [ ] Implements Backend interface from API-002 (stub methods return NotImplementedError for operations not yet implemented)
- [ ] Capability model accurately reflects ACA backend features

---

## Suggested File Paths

```
backends/aca/
├── go.mod                          # module github.com/sockerless/backend-aca, go 1.23
├── go.sum
├── README.md
├── server.go                       # HTTP server setup, route registration
├── capabilities.go                 # Capability reporting handler
├── config.go                       # YAML + env + flag config loading
├── azure.go                        # Azure SDK client initialization, credential setup
├── store.go                        # State store (container/network/volume -> Azure resource mapping)
├── errors.go                       # Azure error -> HTTP error mapping
└── cmd/
    └── sockerless-backend-aca/
        └── main.go                 # Binary entrypoint
```

---

## Notes

- Use Azure SDK for Go v2 (`github.com/Azure/azure-sdk-for-go/sdk/...`). The older `Azure/azure-sdk-for-go` monolithic package is deprecated.
- Key packages: `azidentity` for authentication, `armappcontainers` for Container Apps Jobs management, `azquery` for Log Analytics queries, `armstorage` for Azure Files, `azcontainerregistry` for ACR.
- The state store must map between sockerless's 64-char hex IDs and Azure resource names. Azure Container Apps Job names have restrictions (lowercase alphanumeric + hyphens, max 32 chars), so generate short unique names from the container ID prefix.
- For the state store, consider SQLite via `modernc.org/sqlite` (pure Go, no CGO) for persistence across restarts. The memory backend uses in-memory maps, but a production ACA backend benefits from surviving restarts.
- Azure SDK error handling: use `errors.As` with `*azcore.ResponseError` to extract HTTP status codes and error codes. Map these to appropriate Docker-compatible error responses.
- The managed environment must exist before the backend starts. The backend does NOT create the managed environment. Consider a startup validation check that verifies the environment exists and logs a warning if not found.
- Authentication: `DefaultAzureCredential` supports managed identity (for production), Azure CLI (for development), and environment variables. Document the required Azure RBAC roles: Contributor on the resource group, or finer-grained: Container Apps Contributor, Storage Account Contributor, Log Analytics Reader.
- Import `github.com/sockerless/api` for shared types and the `Backend` interface.
