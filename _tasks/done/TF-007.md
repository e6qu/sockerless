# TF-007: ACA test environment

**Component:** Terraform
**Phase:** 3
**Depends on:** TF-001, TF-006
**Estimated effort:** S

---

## Description

Create a Terraform environment configuration that instantiates the ACA module (from TF-006) for integration testing. This environment lives under `terraform/environments/aca-test/` and provides a fully provisioned Azure subscription with all infrastructure needed by the ACA backend (ACA-001 through ACA-004) and the ACA integration test suite (TST-014). The environment uses test-appropriate defaults (Basic SKU where possible, minimal retention periods, consumption workload profile), configures an Azure Blob backend for remote state, and outputs every value the test runner needs to connect to and validate the ACA infrastructure.

---

## Context

### ACA backend infrastructure requirements (from ACA-001, Spec Section 9.1)

The ACA backend requires the following Azure resources to operate:

> | Docker Concept | ACA Mapping |
> |---|---|
> | Container create + start | `Create Job` + `Start Job Execution` |
> | Container stop | `Stop Job Execution` |
> | Container logs | Azure Monitor / Log Analytics |
> | Exec / Attach | Via sockerless-agent (agent on container port, VNet accessible) |
> | Image pull | ACA pulls from ACR / Docker Hub natively |
> | Network | VNet integration (managed environment) |
> | Volume | Azure Files, ephemeral storage |

### ACA backend configuration keys (from ACA-001)

> ```yaml
> aca:
>   subscription_id: "00000000-0000-0000-0000-000000000000"
>   resource_group: "sockerless-rg"
>   managed_environment_name: "sockerless-env"
>   location: "eastus"
>   log_analytics_workspace_id: "/subscriptions/.../workspaces/sockerless-logs"
>   storage_account_name: "sockerlessstorage"
>   storage_account_key: ""            # or use managed identity
>   registry_server: "sockerless.azurecr.io"
>   registry_username: ""              # or use managed identity
>   registry_password: ""
> ```

### Agent networking requirements (from ACA-002, Spec Section 9.1)

> Container Apps jobs run within a managed environment that is VNet-integrated. The agent listens on port 9111. The frontend must be able to reach the container's IP within the VNet (same VNet, peering, or VPN gateway).

The test environment must provision the full VNet-integrated Container Apps Environment so that agent connectivity can be validated during integration tests. The NSG must allow inbound TCP 9111 from the VNet CIDR range.

### Volume and storage requirements (from ACA-004, Spec Section 10.3)

> 1. Create an Azure Files share per sockerless instance
> 2. Mount the share in the container app job
> 3. Shared access via the same file share
>
> The storage account access key is used for mounting Azure Files shares in Container Apps Jobs. Alternatively, managed identity can be used if the Container Apps environment has the appropriate RBAC role on the storage account.

The test environment provisions the storage account and default file share so volume mount operations can be tested.

### Output-to-environment-variable mapping

The integration test suite (TST-014) and the ACA backend (ACA-001) expect the following environment variables:

| Terraform Output | Environment Variable | Used By |
|---|---|---|
| `subscription_id` | `SOCKERLESS_ACA_SUBSCRIPTION_ID` | ACA-001 |
| `resource_group_name` | `SOCKERLESS_ACA_RESOURCE_GROUP` | ACA-001 |
| `managed_environment_name` | `SOCKERLESS_ACA_MANAGED_ENVIRONMENT_NAME` | ACA-001 |
| `location` | `SOCKERLESS_ACA_LOCATION` | ACA-001 |
| `log_analytics_workspace_id` | `SOCKERLESS_ACA_LOG_ANALYTICS_WORKSPACE_ID` | ACA-001 |
| `storage_account_name` | `SOCKERLESS_ACA_STORAGE_ACCOUNT_NAME` | ACA-001, ACA-004 |
| `acr_login_server` | `SOCKERLESS_ACA_REGISTRY_SERVER` | ACA-001, ACA-003 |

### Test environment pattern (from TF-001 conventions)

Test environments instantiate their respective module with cost-optimized defaults, configure remote state backends, and output values consumed by integration test suites. The test runner receives Terraform outputs via `terraform output -json` and maps them to backend configuration environment variables.

### Cost-optimization for testing

The ACA test environment uses the cheapest viable SKUs:
- Container Apps Environment: Consumption workload profile (pay-per-use, no idle cost for the environment itself)
- Log Analytics: PerGB2018 with 30-day retention and low daily cap
- Storage account: Standard_LRS (locally redundant, cheapest)
- ACR: Basic SKU (10 GiB storage, sufficient for testing)
- VNet: No cost for the VNet itself; subnet delegation is free

---

## Acceptance Criteria

1. `terraform/environments/aca-test/` directory contains `main.tf`, `variables.tf`, `outputs.tf`, `providers.tf`, `backend.tf`, and `terraform.tfvars.example`.
2. `backend.tf` configures an Azure Blob backend for state storage with configurable resource group, storage account, container name, and key (default key `sockerless/aca-test/terraform.tfstate`).
3. `main.tf` instantiates the ACA module (`../../modules/aca/`) with all required variables, using test-appropriate defaults.
4. The module is instantiated with `location = "eastus"` (or configurable via variable) and a subscription ID provided via variable (no default -- must be explicitly set).
5. Test-appropriate defaults are applied: ACR Basic SKU, Log Analytics 30-day retention with 1 GB/day cap, Standard_LRS storage, Consumption workload profile, Azure Files share quota of 10 GiB.
6. All resources are tagged with consistent tags: `environment = "test"`, `project = "sockerless"`, `managed-by = "terraform"`.
7. `outputs.tf` exports all values needed by the integration test suite: `subscription_id`, `resource_group_name`, `managed_environment_name`, `managed_environment_id`, `location`, `vnet_id`, `subnet_id`, `log_analytics_workspace_id`, `log_analytics_workspace_key` (sensitive), `storage_account_name`, `storage_account_key` (sensitive), `acr_login_server`, `acr_admin_username` (sensitive, if enabled), `acr_admin_password` (sensitive, if enabled), `managed_identity_client_id`, `managed_identity_principal_id`, `dns_zone_name`.
8. `variables.tf` defines: `subscription_id` (required, no default), `location` (default `eastus`), `environment` (default `test`), `name_prefix` (default `sockerless`), and any module-specific overrides.
9. `terraform.tfvars.example` contains all required variables with placeholder values and comments explaining each.
10. `terraform validate` passes with zero errors in the environment directory.
11. `terraform fmt -check` passes with zero formatting deviations.
12. `terraform plan` succeeds without errors when valid Azure credentials and subscription ID are provided (no resources need to exist beforehand except the state backend storage account and container).
13. A `README.md` in the environment directory documents: prerequisites (Azure subscription, state storage account, Azure CLI or service principal), how to initialize, how to apply, how to extract outputs for the test runner, and how to destroy.
14. The README includes a mapping from Terraform outputs to backend environment variables (e.g., `resource_group_name` -> `SOCKERLESS_ACA_RESOURCE_GROUP`, `managed_environment_name` -> `SOCKERLESS_ACA_MANAGED_ENVIRONMENT_NAME`, etc.).

---

## Definition of Done

### Code Quality
- [ ] `terraform validate` passes with zero errors
- [ ] `terraform fmt -check` passes with zero formatting deviations
- [ ] `terraform fmt -recursive` produces no changes
- [ ] No deprecated resource types or provider features used
- [ ] Provider version constraints are pinned to minor version (e.g., `~> 4.0`)

### Testing
- [ ] `terraform plan` succeeds with valid credentials (dry run, no apply required for DoD)
- [ ] All outputs are defined and referenced correctly
- [ ] Variable defaults are sensible for a test environment (cost-optimized)
- [ ] No hard-coded subscription IDs, tenant IDs, or credentials

### Documentation
- [ ] `README.md` in the environment directory with setup and teardown instructions
- [ ] `terraform.tfvars.example` with all required variables documented
- [ ] Inline comments on non-obvious configuration choices

### Integration
- [ ] Outputs match the configuration keys expected by the ACA backend (ACA-001)
- [ ] Outputs provide all values needed by TST-014 (ACA integration tests)
- [ ] State backend configuration is consistent with TF-001 conventions

---

## Suggested File Paths

```
terraform/environments/aca-test/
├── main.tf                    # Module instantiation with test defaults
├── variables.tf               # Input variables (subscription_id, location, etc.)
├── outputs.tf                 # All outputs for the test runner
├── providers.tf               # AzureRM provider configuration with features block
├── backend.tf                 # Azure Blob remote state backend
├── terraform.tfvars.example   # Example variable values
└── README.md                  # Setup, usage, teardown, output mapping
```

---

## Notes

- The Azure Blob state backend requires a pre-existing storage account and blob container. Document the bootstrap commands: `az group create -n sockerless-tfstate-rg -l eastus`, `az storage account create -n sockerlesstfstate -g sockerless-tfstate-rg -l eastus --sku Standard_LRS`, `az storage container create -n tfstate --account-name sockerlesstfstate`. The state storage account is separate from the ACA module's storage account for volumes.
- Use `eastus` as the default location because it has broad Azure service availability and is cost-effective for testing.
- The AzureRM provider requires a `features {}` block. Include it in `providers.tf` with sensible defaults for testing (e.g., `resource_group { prevent_deletion_if_contains_resources = false }` to allow easy teardown).
- Container Apps Environment with Consumption workload profile has no idle cost -- you only pay for running container jobs. This makes it ideal for intermittent test usage.
- ACR Basic SKU has a 10 GiB storage limit. For the test environment this is sufficient. If image load tests push many images, the storage may fill up. Document `az acr purge` as a cleanup step.
- Sensitive outputs (`storage_account_key`, `log_analytics_workspace_key`, `acr_admin_password`) must be marked with `sensitive = true` in Terraform. The test runner should use `terraform output -json` to retrieve them.
- For CI/CD pipelines, prefer using a service principal or managed identity for authentication instead of interactive Azure CLI login. Document the required Azure RBAC role for the CI/CD identity: `Contributor` on the subscription or a dedicated resource group.
- The NSG rules in the module allow port 9111 from within the VNet. For development testing where the frontend runs on a developer machine outside the VNet, document the option to add an NSG rule for the developer's IP or use Azure Bastion / VPN.
- Consider providing a Makefile or script that wraps `terraform` commands with the correct environment configuration, similar to the pattern established in TF-001. Example targets: `make init`, `make plan`, `make apply`, `make destroy`, `make outputs`.
- The environment destroy order matters: Container Apps Jobs must be deleted before the environment, and the environment before the VNet. Terraform handles this automatically via dependency graph, but document it for manual cleanup scenarios.
- Estimated monthly cost for an idle test environment (no running jobs): approximately $2-5/month (Log Analytics ingestion, storage account, ACR Basic). Active testing with container jobs adds per-execution costs.
