# GCF-001: Cloud Run Functions backend

**Component:** GCF (Google Cloud Run Functions backend)
**Phase:** 4
**Depends on:** API-002
**Estimated effort:** L

---

## Description

Build the Google Cloud Run Functions (2nd generation) backend for Sockerless. This backend translates internal API calls into Cloud Run Functions operations, deploying and invoking functions using container image support. Like all FaaS backends, Cloud Run Functions has hard limitations: no exec, no attach, no volumes, no networks, and no health checks. The backend reports these reduced capabilities so the frontend can return `501 Not Implemented` for unsupported operations.

2nd generation Cloud Run Functions are built on Cloud Run and support container images from Artifact Registry. Functions are deployed, invoked via HTTP triggers, and their output is retrieved from Cloud Logging. The agent is NOT required -- there is no mechanism for exec or attach. Maximum timeout is 60 minutes (significantly longer than Lambda's 15 minutes).

This backend is suitable for short-lived, fire-and-forget container workloads such as batch processing, webhooks, and scheduled tasks. It is NOT compatible with CI runners (GitLab Runner, GitHub Actions Runner).

---

## Context

### Cloud Run Functions backend mapping (Spec Section 9.2)

> | Docker Concept | Cloud Run Functions Mapping |
> |---|---|
> | Container create + start | Deploy function (2nd gen, container-based) + invoke |
> | Container stop/kill | N/A |
> | Container logs | Cloud Logging |
> | Exec / Attach | **Not supported** |
> | Image pull | Functions pull from Artifact Registry |
> | Max timeout | 60 minutes (2nd gen) |
>
> **Capabilities:** `exec: false, attach: false, logs: true, logs_follow: false, max_timeout_seconds: 3600, agent_required: false`

### Capability reporting (Spec Section 9.5)

> | Capability | CR Func |
> |---|:---:|
> | Long-running | No (60m) |
> | Exec | **No** |
> | Attach | **No** |
> | Log stream | Yes |
> | Log follow | No |
> | Volumes | No |
> | Networks | No |
> | Health checks | No |
> | Agent needed | No |
> | Startup latency | 1-5s |

### FaaS backend compatibility (Spec Section 13.4)

> FaaS backends (Lambda, Cloud Run Functions, Azure Functions) are NOT compatible with CI runners. This is a hard architectural limitation.
>
> Capability reporting prevents silent failures: FaaS backends report `exec: false, attach: false` in their capabilities. When the frontend receives an exec or attach request, it returns `501 Not Implemented` with `{"message":"This backend (gcf) does not support exec. CI runners require exec-capable backends (ecs, cloudrun, aca, docker)."}`.
>
> FaaS backends ARE useful for: Short-lived, fire-and-forget container workloads that don't need exec or attach -- batch processing, webhooks, scheduled tasks.

### Backend configuration (Spec Section 15.3)

> Configuration follows the standard backend YAML format with Cloud Run Functions-specific fields:
> ```yaml
> gcf:
>   project_id: my-gcp-project
>   region: us-central1
>   service_account: "...@...iam.gserviceaccount.com"
>   artifact_registry: "us-central1-docker.pkg.dev/my-project/sockerless"
>   timeout: 3600                        # seconds (max 3600 for 2nd gen)
>   memory: "1Gi"                        # Memory allocation
>   cpu: 1                               # CPU allocation
> ```

---

## Acceptance Criteria

1. `sockerless-backend-gcf` binary compiles and runs from `cmd/sockerless-backend-gcf/main.go`.
2. Server listens on a Unix socket (default `/var/run/sockerless-backend.sock`) or TCP address for internal API requests.
3. GCP SDK clients are initialized for: Cloud Functions v2 API and Cloud Logging.
4. Configuration loads from YAML file, environment variables, and CLI flags (priority: flags > env > file > defaults). Required config: `project_id`, `region`. Optional: `service_account`, `artifact_registry`, `timeout` (default `3600`), `memory` (default `"1Gi"`), `cpu` (default `1`).
5. `GET /internal/v1/capabilities` returns the capability JSON with `backend: "gcf"`, `agent_required: false`, `exec: false`, `attach: false`, `logs: true`, `logs_follow: false`, `volumes: false`, `networks: false`, `health_checks: false`, `max_timeout_seconds: 3600`.
6. Container create maps to deploying a 2nd gen Cloud Run Function from a container image in Artifact Registry. The container's `Image` field is used as the function's container image URI. Returns a 64-char hex container ID.
7. Container start maps to invoking the Cloud Run Function via its HTTP trigger URL. The function begins execution.
8. Container logs retrieves output from Cloud Logging using the Cloud Logging client. Supports `tail` and `timestamps` parameters. Does NOT support `follow` (returns immediately with available logs).
9. Container wait returns the function's exit status (0 for success, non-zero for failure/timeout) once invocation completes.
10. Container stop/kill are no-ops -- Cloud Run Functions cannot be stopped mid-execution. Return success (idempotent).
11. Container remove deletes the Cloud Run Function and removes state store entry.
12. Exec create, exec start, and attach requests return `501 Not Implemented` with message: `"This backend (gcf) does not support exec. CI runners require exec-capable backends (ecs, cloudrun, aca, docker)."` (or similar for attach).
13. Image operations: image pull is a no-op (Cloud Run Functions pulls from Artifact Registry natively), image inspect returns stored metadata.
14. Network and volume operations return `501 Not Implemented`.
15. In-memory or SQLite state store maps `container_id -> {function_name, function_url, log_resource, invocation_status, ...}` and `image_ref -> {config, digest, ...}`.
16. GCP SDK errors are mapped to Docker-compatible HTTP error responses: `{"message": "..."}`.
17. GCP credentials are loaded via Application Default Credentials (ADC) -- env vars, service account JSON, metadata server.
18. Graceful shutdown on SIGTERM/SIGINT: drain in-flight requests, clean exit.
19. All requests logged via zerolog with method, path, status code, duration, and GCP request metadata where applicable.

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] Unit tests for: configuration loading, capability reporting, state store CRUD, GCP error mapping, 501 responses for unsupported operations
- [ ] Tests use mock GCP clients (no real GCP calls in unit tests)
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] GCP SDK errors wrapped with context: `fmt.Errorf("gcf: deploy function: %w", err)`
- [ ] Zerolog structured logging on all error paths with GCP request metadata
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`
- [ ] Unsupported operations return 501 with descriptive message

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` created with Cloud Run Functions backend overview, configuration, prerequisites, and limitations

### Integration
- [ ] Implements Backend interface from API-002 (unsupported methods return NotImplementedError)
- [ ] Capability model accurately reflects Cloud Run Functions backend limitations

---

## Suggested File Paths

```
backends/cloudrun-functions/
├── go.mod                              # module github.com/sockerless/backend-gcf, go 1.23
├── go.sum
├── README.md
├── server.go                           # HTTP server setup, route registration
├── capabilities.go                     # Capability reporting handler
├── config.go                           # YAML + env + flag config loading
├── gcp.go                              # GCP SDK client initialization (functions v2, logging)
├── containers.go                       # Container create (deploy function), start (invoke), stop (no-op), remove (delete)
├── logs.go                             # Cloud Logging retrieval
├── store.go                            # State store (container_id -> function name/URL mapping)
├── errors.go                           # GCP error -> HTTP error mapping
├── unsupported.go                      # 501 handlers for exec, attach, networks, volumes
└── cmd/
    └── sockerless-backend-gcf/
        └── main.go                     # Binary entrypoint
```

---

## Notes

- Use the GCP Go SDK (`cloud.google.com/go/functions/apiv2` for Cloud Functions v2 and `cloud.google.com/go/logging` for Cloud Logging).
- 2nd generation Cloud Run Functions are built on Cloud Run infrastructure. They support container images deployed from Artifact Registry, which aligns with Sockerless's container image model.
- Function names must follow GCP naming conventions (`projects/{project}/locations/{region}/functions/{name}`). Use the sockerless container ID (truncated or hashed) as part of the function name.
- Cloud Logging has a propagation delay (typically a few seconds). Log retrieval may not return the most recent output immediately. Document this latency.
- Function deployment can take 30-120 seconds (building and deploying the container). This is significantly longer than Lambda's cold start. Consider the deployment as part of the "create" phase and use long-polling or status checking for readiness.
- Cloud Run Functions 2nd gen uses Cloud Run under the hood, so the HTTP trigger model applies. The function is invoked by sending an HTTP request to its generated URL.
- The state store must map between sockerless's 64-char hex IDs and GCP function resource names. Consider SQLite via `modernc.org/sqlite` (pure Go, no CGO) for persistence.
- Import `github.com/sockerless/api` for shared types and the `Backend` interface.
