# API-001: Internal API data models

**Component:** API (Shared internal API types)
**Phase:** 1
**Depends on:** --
**Estimated effort:** M

---

## Description

Define the Go data structures shared between the frontend and all backends via the internal API. These types live in the `api/` module (`github.com/sockerless/api`) and have **zero external dependencies** (stdlib only). Every field must have a JSON tag matching the Docker API's PascalCase naming convention so that responses serialized from these types are compatible with Docker clients.

The types cover five resource kinds: Container, Image, Network, Volume, and ExecInstance. Each type includes both the "create request" shape and the "inspect response" shape where they differ.

---

## Context

### Internal API role (Spec Section 7.1)

> The internal API mirrors the Docker REST API structure but without Docker-specific protocol quirks (no multiplexed streams, no connection hijacking, no `X-Registry-Auth` headers). It is defined by the `api/` module using its own types (zero external dependencies).
>
> The frontend translates: `Docker types (OpenAPI-generated) <-> api/ types <-> internal HTTP/JSON`
> The backend translates: `api/ types <-> cloud SDK types`

### Container create body (Spec Section 4.3)

The following fields are sent by CI runners and must be representable:

```json
{
  "Image": "nginx:latest",
  "Hostname": "runner-abc-project-1-concurrent-0",
  "Cmd": ["sh", "-c", "echo hello"],
  "Entrypoint": ["/bin/sh"],
  "Env": ["CI=true", "GITLAB_CI=true"],
  "Labels": {"com.gitlab.gitlab-runner.managed": "true"},
  "User": "",
  "Tty": false,
  "AttachStdin": true, "AttachStdout": true, "AttachStderr": true,
  "OpenStdin": true, "StdinOnce": true,
  "ExposedPorts": {"80/tcp": {}},
  "WorkingDir": "/app",
  "HostConfig": {
    "Binds": ["/builds:/builds", "/cache:/cache"],
    "Memory": 536870912,
    "NanoCPUs": 1000000000,
    "NetworkMode": "<network-id>",
    "PortBindings": {"80/tcp": [{"HostPort": "8080"}]},
    "RestartPolicy": {"Name": "no"},
    "ExtraHosts": ["service:10.0.0.2"],
    "Dns": ["8.8.8.8"],
    "Privileged": false,
    "VolumesFrom": [],
    "Tmpfs": {}
  },
  "NetworkingConfig": {
    "EndpointsConfig": {
      "<network-name>": {
        "Aliases": ["postgres", "db"],
        "MacAddress": "02:42:ac:11:00:02"
      }
    }
  }
}
```

### Container inspect response (Spec Section 4.3)

```json
{
  "Id": "<64-char-hex>",
  "Created": "2026-02-15T12:00:00Z",
  "Name": "/container-name",
  "State": {
    "Status": "running",
    "Running": true,
    "Paused": false, "Restarting": false, "OOMKilled": false, "Dead": false,
    "Pid": 1, "ExitCode": 0, "Error": "",
    "StartedAt": "2026-02-15T12:00:01Z",
    "FinishedAt": "0001-01-01T00:00:00Z",
    "Health": { "Status": "healthy", "FailingStreak": 0, "Log": [] }
  },
  "Config": { "Image": "...", "Env": [...], "Cmd": [...], "..." },
  "HostConfig": { "..." },
  "NetworkSettings": {
    "IPAddress": "10.0.0.5",
    "Ports": {"80/tcp": [{"HostIp": "0.0.0.0", "HostPort": "8080"}]},
    "Networks": {
      "bridge": { "IPAddress": "10.0.0.5", "Aliases": ["db"], "NetworkID": "..." }
    }
  }
}
```

### Image inspect response (Spec Section 4.2)

```json
{
  "Id": "sha256:<digest>",
  "RepoTags": ["nginx:latest"],
  "RepoDigests": ["nginx@sha256:..."],
  "Created": "2026-01-01T00:00:00Z",
  "Size": 0, "VirtualSize": 0,
  "Config": {
    "Env": ["PATH=/usr/local/sbin:..."],
    "Cmd": ["nginx", "-g", "daemon off;"],
    "Entrypoint": null,
    "ExposedPorts": {"80/tcp": {}},
    "Labels": {},
    "WorkingDir": ""
  },
  "Os": "linux", "Architecture": "amd64"
}
```

### Network inspect response (Spec Section 4.5)

```json
{
  "Name": "build-network", "Id": "<hex>",
  "Created": "2026-02-15T12:00:00Z",
  "Scope": "local", "Driver": "bridge", "EnableIPv6": false,
  "IPAM": {
    "Driver": "default",
    "Config": [{"Subnet": "172.18.0.0/16", "Gateway": "172.18.0.1"}]
  },
  "Containers": {
    "<container-id>": { "Name": "postgres", "IPv4Address": "172.18.0.2/16" }
  },
  "Labels": {}
}
```

### Volume response (Spec Section 4.6)

```json
{
  "Name": "runner-cache-sha256abc",
  "Driver": "local",
  "Mountpoint": "/var/lib/docker/volumes/runner-cache-sha256abc/_data",
  "Labels": {"com.gitlab.gitlab-runner.managed": "true"},
  "Scope": "local",
  "CreatedAt": "2026-02-15T12:00:00Z"
}
```

### Exec types (Spec Section 4.4)

Create request: `{ "AttachStdin": true, "AttachStdout": true, "AttachStderr": true, "Tty": false, "Cmd": ["sh", "-c", "echo hello"], "Env": ["FOO=bar"], "WorkingDir": "/app" }`

Inspect response: `{ "ID": "<exec-id>", "Running": false, "ExitCode": 0, "Pid": 0 }`

### Backend state ownership (Spec Section 6.4)

| Object | State Fields |
|--------|-------------|
| Container | ID, name, config, status, cloud task ID, agent address, IP, ports, timestamps, exit code, labels |
| Network | ID, name, labels, IPAM subnet, connected containers |
| Volume | ID, name, labels, cloud storage ID, mount references |
| Image | Reference, digest, config (env/cmd/entrypoint), pulled timestamp |
| Exec | ID, container ID, cmd, env, workdir, running, exit code |

---

## Acceptance Criteria

1. A `Container` struct exists with all fields from the inspect response: `Id`, `Created`, `Name`, `State` (with nested `ContainerState` including `Status`, `Running`, `Paused`, `Restarting`, `OOMKilled`, `Dead`, `Pid`, `ExitCode`, `Error`, `StartedAt`, `FinishedAt`, `Health`), `Config`, `HostConfig`, `NetworkSettings`.
2. A `ContainerCreateRequest` struct exists with all fields from the create body (Image, Hostname, Cmd, Entrypoint, Env, Labels, User, Tty, AttachStdin/Stdout/Stderr, OpenStdin, StdinOnce, ExposedPorts, WorkingDir, HostConfig, NetworkingConfig).
3. A `ContainerListEntry` struct exists with the summary fields returned by `GET /containers/json` (Id, Names, Image, ImageID, Command, Created, State, Status, Ports, Labels, NetworkSettings).
4. An `Image` struct exists with: `Id`, `RepoTags`, `RepoDigests`, `Created`, `Size`, `VirtualSize`, `Config` (nested `ImageConfig` with Env, Cmd, Entrypoint, ExposedPorts, Labels, WorkingDir), `Os`, `Architecture`.
5. A `Network` struct exists with: `Name`, `Id`, `Created`, `Scope`, `Driver`, `EnableIPv6`, `IPAM` (nested with Driver and Config slice), `Containers` (map), `Labels`, `Options`.
6. A `Volume` struct exists with: `Name`, `Driver`, `Mountpoint`, `Labels`, `Scope`, `CreatedAt`.
7. An `ExecInstance` struct exists with: `ID`, `ContainerID`, `Cmd`, `Env`, `WorkingDir`, `Tty`, `AttachStdin`, `AttachStdout`, `AttachStderr`, `Running`, `ExitCode`, `Pid`.
8. All exported fields have `json:"PascalCase"` tags matching Docker API names exactly.
9. All exported types and fields have GoDoc comments.
10. The module compiles with `go build ./...` and has zero external dependencies (only `time` from stdlib if needed).

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] No new lint warnings introduced

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` created

### Integration
- [ ] No breaking changes to the internal API contract
- [ ] Module path is `github.com/sockerless/api`
- [ ] Zero external dependencies in `go.mod`

---

## Suggested File Paths

```
api/
├── go.mod            # module github.com/sockerless/api, go 1.23
├── types.go          # Shared sub-types (PortBinding, RestartPolicy, EndpointConfig, etc.)
├── container.go      # Container, ContainerCreateRequest, ContainerListEntry, ContainerState, HostConfig, NetworkSettings
├── image.go          # Image, ImageConfig
├── network.go        # Network, NetworkCreateRequest, IPAM, IPAMConfig, NetworkContainer
├── volume.go         # Volume, VolumeCreateRequest, VolumeListResponse
└── exec.go           # ExecInstance, ExecCreateRequest, ExecStartRequest
```

---

## Notes

- Use `map[string]struct{}` for ExposedPorts and Tmpfs (matches Docker's JSON shape `{"80/tcp": {}}`).
- Use `map[string][]PortBinding` for PortBindings where `PortBinding` has `HostIp` and `HostPort` string fields.
- Container `Name` in inspect is prefixed with `/` (e.g., `"/mycontainer"`). Store with the slash.
- `Created` in `ContainerListEntry` is a Unix timestamp (int64), but `Created` in the inspect response is an RFC3339 string. Use distinct types or fields.
- The `Health` field inside `ContainerState` is a pointer (`*HealthState`) because it is `null` when no healthcheck is configured.
- `HostConfig.Tmpfs` is `map[string]string` (mount path -> options).
- `HostConfig.VolumesFrom` is `[]string`.
- The `AgentAddress` field should be added to the container type (not part of the Docker API but needed for internal API communication per Spec Section 7.5).
- Keep types minimal but complete. If Docker returns a field in inspect, it should exist in the struct even if sockerless does not use it, for client compatibility. Use zero values for unused fields.
