# ECS-004: Container logs (CloudWatch)

**Component:** ECS (AWS ECS Fargate backend)
**Phase:** 2
**Depends on:** ECS-002
**Estimated effort:** M

---

## Description

Implement the `ContainerLogs` operation for the ECS backend. Container logs are stored in CloudWatch Logs by the `awslogs` log driver configured in the task definition (set up in ECS-002). This task fetches log events from CloudWatch using `GetLogEvents` (one-shot) and `FilterLogEvents` (for filtering/tailing), formats them into Docker's 8-byte multiplexed stream protocol with stdout/stderr framing, and supports the `follow` mode by polling CloudWatch for new events. The log output must be compatible with both GitLab Runner and GitHub Actions Runner log consumption patterns.

---

## Context

### ECS log mapping (Spec Section 9.1)

> | Docker Concept | ECS Mapping |
> |---|---|
> | Container logs | CloudWatch Logs (`GetLogEvents` / `FilterLogEvents`) |

### CloudWatch log structure (Spec Section 15.3 / ECS-002)

> The task definition includes the `awslogs` log driver:
> ```json
> {
>   "LogConfiguration": {
>     "LogDriver": "awslogs",
>     "Options": {
>       "awslogs-group": "/sockerless/containers",
>       "awslogs-region": "us-east-1",
>       "awslogs-stream-prefix": "<container-id-12-char-prefix>"
>     }
>   }
> }
> ```
>
> CloudWatch log stream name format: `<stream-prefix>/<container-name>/<task-id>`.
> Example: `abc123def456/main/1234567890abcdef`.

### Docker logs endpoint (Spec Section 4.2)

> Query parameters:
> - `stdout` (bool): Include stdout
> - `stderr` (bool): Include stderr
> - `follow` (bool): Stream logs (long-poll)
> - `timestamps` (bool): Add RFC3339Nano timestamps
> - `tail` (string): Number of lines from end ("all" or number)
> - `details` (bool): Include extra attributes
>
> **Response format:** Multiplexed stream (when `Tty: false`, which is the CI runner case):
> ```
> [stream_type: 1 byte][0x00 0x00 0x00][size: 4 bytes big-endian][payload: size bytes]
> ```
> Where `stream_type` = `1` (stdout) or `2` (stderr).

### CI runner log consumption (Spec Section 13.1/13.2)

> GitLab Runner reads logs with: `stdout=true, stderr=true, timestamps=true, follow=false` (one-shot, 64KB limit).
> GitHub Runner reads logs with: `details=true, stdout=true, stderr=true`.

### Multiplexed stream protocol (Spec Section 5.2)

> When `Tty: false`, attach and logs use Docker's multiplexed stream format:
> ```
> +--------+--------+--------+--------+--------+--------+--------+--------+
> | STREAM | 0x00   | 0x00   | 0x00   | SIZE1  | SIZE2  | SIZE3  | SIZE4  |
> +--------+--------+--------+--------+--------+--------+--------+--------+
> ```
> - **Byte 0 (STREAM):** `0` = stdin, `1` = stdout, `2` = stderr
> - **Bytes 1-3:** Padding (zeros)
> - **Bytes 4-7:** Payload size as big-endian uint32
> - **Following bytes:** Payload (exactly `SIZE` bytes)

---

## Acceptance Criteria

### Log retrieval
1. `ContainerLogs` retrieves log events from CloudWatch Logs using the log group and stream associated with the container (stored in state from ECS-002).
2. The log stream name is resolved using the format `<stream-prefix>/<container-name>/<task-id>`, where `stream-prefix` is the container ID's first 12 characters, `container-name` is `"main"`, and `task-id` is extracted from the task ARN.
3. `GetLogEvents` is used for one-shot log retrieval (when `follow=false`).
4. When `tail` is a number (e.g., `"100"`), only the last N log events are returned. When `tail` is `"all"` or empty, all events are returned.
5. When `timestamps=true`, each log line is prefixed with an RFC3339Nano timestamp derived from the CloudWatch event's `timestamp` field (milliseconds since epoch).

### Multiplexed framing
6. Each log event is wrapped in Docker's 8-byte multiplexed stream header before being written to the response.
7. CloudWatch does not distinguish stdout from stderr -- all output goes to a single log stream. By default, all events are framed as stdout (`stream_type=1`). If the log message contains the agent's stderr marker prefix (e.g., `[stderr]`), it is framed as stderr (`stream_type=2`) with the marker stripped.
8. When `stdout=false`, stdout-framed events are excluded. When `stderr=false`, stderr-framed events are excluded.

### Follow mode
9. When `follow=true`, the connection is kept open and CloudWatch is polled at a configurable interval (default 2 seconds) for new log events.
10. Follow mode uses `GetLogEvents` with a forward token to paginate through new events as they arrive.
11. Follow mode terminates when: (a) the client disconnects, (b) the container has exited and no new events arrive after a configurable grace period (default 10 seconds), or (c) the request context is cancelled.

### Pagination and limits
12. CloudWatch `GetLogEvents` returns a maximum of 10,000 events or 1MB per call. If more events exist, the implementation paginates using the `nextForwardToken` until all requested events are fetched.
13. For containers that have not produced any logs yet, the response is an empty stream (not an error).

### Error handling
14. If the CloudWatch log group or stream does not exist yet (container just started, logs not flushed), return an empty stream rather than an error.
15. If the container ID is not found in the state store, return a 404 error with Docker-format message.
16. CloudWatch API throttling errors (`ThrottlingException`) are retried with exponential backoff (3 retries, starting at 500ms).

### Example SDK Calls

```go
// GetLogEvents (one-shot)
cloudwatchlogs.GetLogEvents(&cloudwatchlogs.GetLogEventsInput{
    LogGroupName:  &logGroup,
    LogStreamName: &logStream,
    StartFromHead: aws.Bool(true),
    Limit:         aws.Int32(100), // when tail=100
})

// GetLogEvents (follow mode, with forward token)
cloudwatchlogs.GetLogEvents(&cloudwatchlogs.GetLogEventsInput{
    LogGroupName:  &logGroup,
    LogStreamName: &logStream,
    StartFromHead: aws.Bool(true),
    NextToken:     &forwardToken,
})
```

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] Unit tests with mock CloudWatch client for: one-shot log retrieval, tail N lines, tail all, timestamps formatting, follow mode polling (new events, container exit termination), empty log stream, pagination across multiple GetLogEvents calls
- [ ] Unit tests for multiplexed frame encoding (correct header bytes, stream type, payload length)
- [ ] Tests for stdout/stderr filtering (stdout=false, stderr=false)
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Container not found returns 404 with Docker-format message
- [ ] CloudWatch log stream not found returns empty stream (not error)
- [ ] Throttling errors retried with exponential backoff
- [ ] Errors wrapped with context: `fmt.Errorf("ecs: container logs: %w", err)`
- [ ] Zerolog structured logging with container ID and log stream name

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants

### Integration
- [ ] Log output compatible with GitLab Runner's log consumption (stdout+stderr, timestamps)
- [ ] Log output compatible with GitHub Actions Runner's log consumption (stdout+stderr, details)
- [ ] State store queried for log group, stream prefix, and task ARN

---

## Suggested File Paths

```
backends/ecs/
├── container_logs.go          # ContainerLogs: CloudWatch retrieval, follow mode
├── cloudwatch.go              # CloudWatch client wrapper, pagination, throttle retry
├── mux_frame.go               # Multiplexed stream frame encoding (8-byte header)
└── store.go                   # (update) Log stream metadata stored with container state
```

---

## Notes

- CloudWatch log stream names follow the pattern `<prefix>/<container-name>/<task-id>`. The task ID is the last segment of the task ARN (e.g., `arn:aws:ecs:us-east-1:123456789:task/cluster/TASK_ID` -> `TASK_ID`).
- CloudWatch events have a `timestamp` (ingestion time) and an `ingestionTime`. Use `timestamp` for the RFC3339Nano prefix since it reflects when the log line was produced.
- CloudWatch `GetLogEvents` with `StartFromHead: false` returns the most recent events -- use this for `tail` parameter support.
- The multiplexed framing code (`mux_frame.go`) should be shared with any future attach/exec streaming that also needs framing on the backend side.
- CloudWatch does not natively separate stdout from stderr. The `awslogs` driver sends both streams to the same log stream. If the agent prefixes stderr lines with a marker, the backend can split them. Otherwise, all lines default to stdout framing. This is acceptable for CI runners, which merge stdout and stderr in their output.
- For `follow=true`, use a polling approach rather than CloudWatch subscription filters. Subscription filters add complexity (Lambda/Kinesis) and are unnecessary for the expected log volume.
- Consider buffering log lines and flushing in batches to reduce the number of small writes on the HTTP response stream.
