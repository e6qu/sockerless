# FE-020: Unsupported endpoint stubs

**Component:** FE (Docker REST API frontend)
**Phase:** 1
**Depends on:** FE-001
**Estimated effort:** S

---

## Description

Register stub handlers for all Docker API endpoints that Sockerless does not implement. Each stub returns `501 Not Implemented` with a descriptive JSON error message `{"message": "not supported by sockerless: <endpoint>"}`. This prevents clients (Docker CLI, SDKs, CI runners, Compose) from receiving confusing connection errors, 404s, or panics when they probe unsupported features. Instead, they get a clear signal that the operation is not available.

The full list of unsupported endpoints is defined in Spec Section 14.2.

---

## Context

### Unsupported endpoints (Spec Section 14.2)

> These endpoints return `501 Not Implemented` with a descriptive message:
>
> | Category | Endpoints | Reason |
> |---|---|---|
> | Build | `POST /build`, `POST /build/prune` | Out of scope (N1) |
> | Swarm | All `/swarm/*`, `/services/*`, `/tasks/*`, `/nodes/*`, `/secrets/*`, `/configs/*` | Not applicable to cloud backends |
> | Plugins | All `/plugins/*` | Not applicable |
> | Session | `POST /session` | BuildKit-specific |
> | Distribution | `GET /distribution/{name}/json` | Not needed |
> | Container archive | `GET/PUT/HEAD /containers/{id}/archive` | Not used by CI runners |
> | Container export | `GET /containers/{id}/export` | Not used |
> | Container commit | `POST /commit` | Not used |
> | Container stats | `GET /containers/{id}/stats` | Future enhancement |
> | Container top | `GET /containers/{id}/top` | Future enhancement |
> | Container changes | `GET /containers/{id}/changes` | Not used |
> | Container update | `POST /containers/{id}/update` | Not used |
> | Container rename | `POST /containers/{id}/rename` | Not used |
> | Container pause/unpause | `POST /containers/{id}/pause`, `/unpause` | Not used |
> | Container resize | `POST /containers/{id}/resize` | Future (TTY support) |
> | Container attach/ws | `GET /containers/{id}/attach/ws` | Future (WebSocket support) |
> | Image search | `POST /images/search` | Not used |
> | Image save/get | `GET /images/get` | Not used |
> | Image push | `POST /images/{name}/push` | Out of scope |
> | Image prune | `POST /images/prune` | Future enhancement |
> | Image remove | `DELETE /images/{name}` | Future enhancement |
> | Image history | `GET /images/{name}/history` | Not used |
> | Image list | `GET /images/json` | Future enhancement |
> | Container prune | `POST /containers/prune` | Future enhancement |
> | Volume prune | `POST /volumes/prune` | Future enhancement |
> | System df | `GET /system/df` | Future enhancement |
> | Events | `GET /events` | Future enhancement |

### Non-goals from Spec Section 2.2

> | N1 | `docker build` / `POST /build` | Out of scope. CI runners can use kaniko, buildx, or external build services. |
> | N2 | Swarm endpoints | Neither CI runner uses Swarm. No cloud backend maps to it. |
> | N3 | Plugin endpoints | Docker plugin system is not relevant to cloud backends. |
> | N4 | Session/BuildKit endpoint | Tied to docker build, which is out of scope. |
> | N5 | Distribution endpoint | Not used by target CI runners. |
> | N6 | Container filesystem archive | Not used by target CI runners. |
> | N7 | Image push | Users push images to registries externally. |

---

## Acceptance Criteria

1. Every endpoint listed in Spec Section 14.2 has a registered route handler.
2. Each stub handler returns HTTP `501 Not Implemented`.
3. The response body is `{"message": "not supported by sockerless: <METHOD> <path>"}` where `<METHOD>` is the HTTP method and `<path>` is the matched route pattern.
4. The `Content-Type` response header is `application/json`.
5. Swarm endpoints use a catch-all prefix route: `/swarm/*`, `/services/*`, `/tasks/*`, `/nodes/*`, `/secrets/*`, `/configs/*`.
6. Plugin endpoints use a catch-all prefix route: `/plugins/*`.
7. The stub handler is a single reusable function, not duplicated per endpoint.
8. Versioned paths (`/v1.44/build`, `/v1.44/containers/{id}/stats`) are also handled by the stubs.
9. The stubs do NOT interfere with supported endpoints -- supported routes take precedence.
10. A request to an endpoint not in either the supported or unsupported list returns `404 Not Found` with `{"message": "page not found"}`.

### Example Requests

```bash
# Docker build (unsupported)
curl -s -X POST --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/build
# Response: 501 Not Implemented
# {"message":"not supported by sockerless: POST /build"}

# Container stats (unsupported)
curl -s --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/containers/abc123/stats
# Response: 501 Not Implemented
# {"message":"not supported by sockerless: GET /containers/{id}/stats"}

# Swarm init (unsupported)
curl -s -X POST --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/swarm/init
# Response: 501 Not Implemented
# {"message":"not supported by sockerless: POST /swarm/init"}

# Plugin list (unsupported)
curl -s --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/plugins
# Response: 501 Not Implemented
# {"message":"not supported by sockerless: GET /plugins"}

# Image push (unsupported)
curl -s -X POST --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/images/myimage/push
# Response: 501 Not Implemented
# {"message":"not supported by sockerless: POST /images/{name}/push"}

# Container archive (unsupported)
curl -s --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/containers/abc123/archive
# Response: 501 Not Implemented
# {"message":"not supported by sockerless: GET /containers/{id}/archive"}

# System df (unsupported)
curl -s --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/system/df
# Response: 501 Not Implemented
# {"message":"not supported by sockerless: GET /system/df"}

# Events (unsupported)
curl -s --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/events
# Response: 501 Not Implemented
# {"message":"not supported by sockerless: GET /events"}

# Completely unknown endpoint (404, not 501)
curl -s --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/foo/bar/baz
# Response: 404 Not Found
# {"message":"page not found"}
```

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] New black-box REST tests written for: representative sample of stubbed endpoints (build, swarm, plugins, container stats, image push, events), verify 501 status and JSON body, verify supported endpoints still return correct responses, verify unknown endpoints return 404
- [ ] Tests run against memory backend by default
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Zerolog structured logging at `debug` level for stubbed endpoint hits (useful for debugging which unsupported features clients are probing)
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on the stub handler function
- [ ] Module `README.md` updated with a note about unsupported endpoint behavior

### Integration
- [ ] No breaking changes to the internal API contract
- [ ] Supported endpoint routes are NOT shadowed by stub routes

---

## Suggested File Paths

```
frontends/docker/
├── handler_unsupported.go    # Reusable stub handler + route registration for all unsupported endpoints
└── routes.go                 # Ensure supported routes are registered before stubs
```

---

## Notes

- Route registration order matters. Register all supported endpoint routes BEFORE registering unsupported stubs. This ensures that supported routes take precedence in the router. With gorilla/mux, more specific routes automatically take precedence, but verify this explicitly.
- Use a table-driven approach for registering stubs. Define a slice of `{method, path, description}` entries and register them in a loop with the same handler function.
- The complete list of routes to stub (from Spec Section 14.2):

  **Build:**
  - `POST /build`
  - `POST /build/prune`

  **Swarm (catch-all):**
  - `* /swarm/{rest:.*}`
  - `* /services/{rest:.*}`
  - `* /tasks/{rest:.*}`
  - `* /nodes/{rest:.*}`
  - `* /secrets/{rest:.*}`
  - `* /configs/{rest:.*}`

  **Plugins (catch-all):**
  - `* /plugins/{rest:.*}`

  **Session:**
  - `POST /session`

  **Distribution:**
  - `GET /distribution/{name}/json`

  **Container operations:**
  - `GET /containers/{id}/archive`
  - `PUT /containers/{id}/archive`
  - `HEAD /containers/{id}/archive`
  - `GET /containers/{id}/export`
  - `POST /commit`
  - `GET /containers/{id}/stats`
  - `GET /containers/{id}/top`
  - `GET /containers/{id}/changes`
  - `POST /containers/{id}/update`
  - `POST /containers/{id}/rename`
  - `POST /containers/{id}/pause`
  - `POST /containers/{id}/unpause`
  - `POST /containers/{id}/resize`
  - `GET /containers/{id}/attach/ws`
  - `POST /containers/prune`

  **Image operations:**
  - `POST /images/search`
  - `GET /images/get`
  - `GET /images/{name}/get`
  - `POST /images/{name}/push`
  - `POST /images/prune`
  - `DELETE /images/{name}`
  - `GET /images/{name}/history`
  - `GET /images/json`

  **Volume:**
  - `POST /volumes/prune`

  **System:**
  - `GET /system/df`
  - `GET /events`

- Log each stub hit at `debug` level with the method, path, and client IP. This helps operators understand which unsupported features their tools are probing.
- Some Docker CLI commands (like `docker images`) map to `GET /images/json`, which is stubbed. The user will see a clear "not supported" error instead of a confusing failure.
