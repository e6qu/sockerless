# FE-019: Volume endpoints

**Component:** FE (Docker REST API frontend)
**Phase:** 1
**Depends on:** FE-001, MEM-004
**Estimated effort:** M

---

## Description

Implement all four volume endpoints: create, list, inspect, and remove. Volumes are primarily used by GitLab Runner for sharing build directories and caches between the helper, build, and service containers within a CI job. All containers in a GitLab job get the same `Binds` list, which references named volumes for `/builds/<namespace>/<project>` and `/cache`. The helper container clones the repo into the build volume, and the build container reads it from the same volume.

---

## Context

### Volume create (Spec Section 4.6)

> `POST /volumes/create`
>
> ```json
> {
>   "Name": "runner-cache-sha256abc",
>   "Driver": "local",
>   "Labels": {"com.gitlab.gitlab-runner.managed": "true"}
> }
> ```
>
> Response:
> ```json
> {
>   "Name": "runner-cache-sha256abc",
>   "Driver": "local",
>   "Mountpoint": "/var/lib/docker/volumes/runner-cache-sha256abc/_data",
>   "Labels": {"com.gitlab.gitlab-runner.managed": "true"},
>   "Scope": "local",
>   "CreatedAt": "2026-02-15T12:00:00Z"
> }
> ```
>
> Sockerless: Creates cloud storage (see Volume Emulation) and records volume metadata.

### Volume list (Spec Section 4.6)

> `GET /volumes` -- List Volumes
>
> Response:
> ```json
> {
>   "Volumes": [ ... ],
>   "Warnings": []
> }
> ```

### Volume inspect (Spec Section 4.6)

> `GET /volumes/{name}` -- Inspect Volume
>
> Returns volume metadata (same shape as create response).

### Volume remove (Spec Section 4.6)

> `DELETE /volumes/{name}`
>
> Query parameter: `force` (bool)
>
> Response: `204 No Content`
>
> Sockerless: Remove cloud storage. If force=true, remove even if in use.

### GitLab Runner volume usage (Spec Section 13.1.2)

> ```
> 4. Volume Setup
>    VolumeCreate("runner-<hash>-cache-<hash>") # cache volume
>    VolumeCreate("runner-<hash>-build-<hash>") # build dir volume (if cache_dir unset)
> ```

### Volume sharing between containers (Spec Section 13.1.3)

> **Volume sharing:**
> ALL containers in the job (helper, build, services) get the same `Binds` list from `e.volumesManager.Binds()`. This includes named volumes for `/builds/<namespace>/<project>` and `/cache`. The helper container clones the repo into the build volume; the build container reads it from the same volume.

### Cloud volume emulation (Spec Section 13.3, Gap 6)

> Cloud shared filesystems:
> - **ECS:** EFS filesystem with access points. Multiple Fargate tasks mount the same EFS access point -> shared data.
> - **Cloud Run:** GCS bucket mounted via Cloud Storage FUSE. Multiple jobs access the same bucket path.
> - **ACA:** Azure Files share. Multiple container app jobs mount the same file share.
>
> Volume creation (`POST /volumes/create`) provisions a directory/access-point in the shared filesystem. Container creation records the volume mount mapping. Container start applies the mount to the cloud task definition.

### GitLab Runner cleanup (Spec Section 13.1.2)

> ```
> 8. Cleanup
>    VolumeRemove(volumeID)
> ```

---

## Acceptance Criteria

1. `POST /volumes/create` accepts a JSON body with: `Name` (string, optional -- auto-generated if empty), `Driver` (string, defaults to `"local"`), `DriverOpts` (map), `Labels` (map).
2. `POST /volumes/create` returns `201 Created` with the full volume object: `Name`, `Driver`, `Mountpoint`, `Labels`, `Scope`, `CreatedAt`, `Options`, `Status`.
3. `POST /volumes/create` is idempotent: creating a volume with the same `Name` and compatible options returns the existing volume (not an error).
4. The `Mountpoint` field follows Docker's convention: `/var/lib/docker/volumes/<name>/_data`.
5. `GET /volumes` returns `200 OK` with body `{"Volumes": [...], "Warnings": []}`.
6. `GET /volumes` supports `filters` query parameter with JSON-encoded filters: `label` (key or key=value), `name`, `driver`.
7. `GET /volumes/{name}` returns `200 OK` with the full volume metadata.
8. `GET /volumes/{name}` returns `404` with `{"message": "get <name>: no such volume"}` if the volume does not exist.
9. `DELETE /volumes/{name}` returns `204 No Content` on success.
10. `DELETE /volumes/{name}` returns `404` with `{"message": "get <name>: no such volume"}` if the volume does not exist.
11. `DELETE /volumes/{name}` returns `409` with `{"message": "remove <name>: volume is in use"}` if the volume is mounted by a running container (and `force=false`).
12. `DELETE /volumes/{name}?force=true` removes the volume even if in use.
13. The `Scope` field is always `"local"`.
14. The `CreatedAt` field is an RFC3339 timestamp string.
15. Volume labels are preserved and returned in list and inspect responses.

### Example Requests

```bash
# Create a named volume
curl -s -X POST --unix-socket /var/run/sockerless.sock \
  -H "Content-Type: application/json" \
  -d '{
    "Name": "runner-abc-cache-def",
    "Driver": "local",
    "Labels": {"com.gitlab.gitlab-runner.managed": "true"}
  }' \
  http://localhost/v1.44/volumes/create
# Response: 201 Created
# {
#   "Name": "runner-abc-cache-def",
#   "Driver": "local",
#   "Mountpoint": "/var/lib/docker/volumes/runner-abc-cache-def/_data",
#   "Labels": {"com.gitlab.gitlab-runner.managed": "true"},
#   "Scope": "local",
#   "CreatedAt": "2026-02-15T12:00:00Z",
#   "Options": null,
#   "Status": {}
# }

# Create a volume with auto-generated name
curl -s -X POST --unix-socket /var/run/sockerless.sock \
  -H "Content-Type: application/json" \
  -d '{}' \
  http://localhost/v1.44/volumes/create
# Response: 201 Created
# {"Name":"a1b2c3d4e5f6...","Driver":"local","Mountpoint":"...","Scope":"local",...}

# List all volumes
curl -s --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/volumes
# Response: 200 OK
# {"Volumes":[{"Name":"runner-abc-cache-def",...}],"Warnings":[]}

# List volumes with label filter
curl -s --unix-socket /var/run/sockerless.sock \
  "http://localhost/v1.44/volumes?filters=%7B%22label%22%3A%5B%22com.gitlab.gitlab-runner.managed%3Dtrue%22%5D%7D"
# Response: 200 OK (filtered list)

# Inspect a volume
curl -s --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/volumes/runner-abc-cache-def
# Response: 200 OK
# {"Name":"runner-abc-cache-def","Driver":"local","Mountpoint":"...","Labels":{...},...}

# Remove a volume
curl -s -X DELETE --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/volumes/runner-abc-cache-def
# Response: 204 No Content

# Remove a non-existent volume
curl -s -X DELETE --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/volumes/nonexistent
# Response: 404
# {"message":"get nonexistent: no such volume"}

# Remove an in-use volume (error)
curl -s -X DELETE --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/volumes/in-use-volume
# Response: 409
# {"message":"remove in-use-volume: volume is in use"}

# Force remove an in-use volume
curl -s -X DELETE --unix-socket /var/run/sockerless.sock \
  "http://localhost/v1.44/volumes/in-use-volume?force=true"
# Response: 204 No Content
```

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] New black-box REST tests written for: create (named, auto-generated, idempotent), list (all, with label filter), inspect, remove (success, not found, in-use, force), full GitLab Runner volume lifecycle
- [ ] Tests run against memory backend by default
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Custom error types used for all domain errors (NotFound, Conflict)
- [ ] Errors wrapped with context: `fmt.Errorf("volume create: %w", err)`
- [ ] Zerolog structured logging on all error paths
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` updated if new public API is added

### Integration
- [ ] No breaking changes to the internal API contract
- [ ] Volume state is used by FE-004 (container create with Binds) and FE-011 (container remove with v=true)
- [ ] Capability model updated if volume operations are a separate capability

---

## Suggested File Paths

```
frontends/docker/
├── handler_volume_create.go   # POST /volumes/create
├── handler_volume_list.go     # GET /volumes
├── handler_volume_inspect.go  # GET /volumes/{name}
├── handler_volume_remove.go   # DELETE /volumes/{name}
└── routes.go                  # Register new routes (update existing)
```

---

## Notes

- Docker's volume create is idempotent: creating a volume with the same name and compatible options returns 201 with the existing volume. If options differ, Docker still returns the existing volume (no error). Match this behavior.
- The `Mountpoint` path is synthetic in Sockerless -- cloud backends use their own storage paths. But the value must follow Docker's convention for client compatibility.
- Volume "in use" detection requires tracking which containers have bind mounts referencing each volume. This is done by matching `HostConfig.Binds` entries (format: `volume-name:/container/path`) to known volume names.
- The volume `Status` field is an empty object `{}` in Docker's response for the local driver. Include it for compatibility.
- Auto-generated volume names in Docker are 64-character hex strings. Use the same format.
- The `DriverOpts` field is accepted but has no effect for the `local` driver in Sockerless. Cloud backends may use driver options for storage configuration (e.g., EFS throughput mode, GCS bucket class).
- The `filters` query parameter for list follows the same format as container list and network list: URL-encoded JSON object with string array values.
- Docker returns volume errors with the format `"get <name>: no such volume"` (lowercase, with the operation prefix). Match this exactly.
