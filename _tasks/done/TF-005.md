# TF-005: Cloud Run test environment

**Component:** Terraform
**Phase:** 3
**Depends on:** TF-001, TF-004
**Estimated effort:** S

---

## Description

Create a Terraform environment configuration that instantiates the Cloud Run module (from TF-004) for integration testing. This environment lives under `terraform/environments/cloudrun-test/` and provides a fully provisioned GCP project with all infrastructure needed by the Cloud Run backend (GCR-001 through GCR-004) and the Cloud Run integration test suite (TST-013). The environment uses test-appropriate defaults, configures a GCS backend for remote state, and outputs every value the test runner needs to connect to and validate the Cloud Run infrastructure.

---

## Context

### Cloud Run backend infrastructure requirements (from GCR-001, GCR-004, Spec Section 9.1)

The Cloud Run backend requires the following GCP resources to operate:

> | Docker Concept | Cloud Run Mapping |
> |---|---|
> | Container create + start | `CreateJob` + `RunJob` (or `CreateExecution`) |
> | Container stop | `CancelExecution` |
> | Container logs | Cloud Logging (`entries.list`) |
> | Exec / Attach | Via sockerless-agent (agent on Cloud Run's ingress port) |
> | Image pull | Cloud Run pulls from Artifact Registry / GCR / Docker Hub natively |
> | Network | VPC Connector or Direct VPC Egress |
> | Volume | Cloud Storage FUSE, GCS, in-memory (tmpfs) |

The Cloud Run module (TF-004) creates: VPC with subnets, Serverless VPC Connector, Cloud DNS managed zone, GCS bucket for volumes, Artifact Registry repository, IAM service account with necessary roles, and enables required APIs.

### Cloud Run backend configuration (from GCR-001)

> ```yaml
> cloudrun:
>   project: my-gcp-project
>   region: us-central1
>   vpc_connector: "projects/my-project/locations/us-central1/connectors/sockerless"
>   gcs_bucket: sockerless-volumes
>   log_filter: ""
> ```

### Agent networking (from GCR-001, Spec Section 9.1)

> Cloud Run containers serve traffic on the port defined by `PORT` env var. The agent can share this port (mux HTTP + WebSocket) or use Cloud Run's sidecar support. Frontend reaches agent via Cloud Run's internal URL.
>
> **Startup latency:** 5-30 seconds.

The test environment must provision a VPC Connector so that the Cloud Run backend can communicate with agent containers via internal networking. The VPC Connector is a key resource bridging Cloud Run Jobs to VPC-resident services.

### GCS volume support (from GCR-004, Spec Section 10.3)

> 1. Create a GCS bucket (or use a pre-provisioned one) per sockerless instance
> 2. Mount via Cloud Storage FUSE in the container
> 3. Shared access via the same bucket/path prefix

The test environment provisions the GCS bucket that Cloud Run Jobs use for volume mounts via Cloud Storage FUSE.

### Test environment pattern (from TF-001 conventions)

Test environments instantiate their respective module with cost-optimized defaults, configure remote state backends, and output values consumed by integration test suites. The test runner receives Terraform outputs via `terraform output -json` and maps them to backend configuration environment variables.

### Output-to-environment-variable mapping

The integration test suite (TST-013) and the Cloud Run backend (GCR-001) expect the following environment variables, which are derived from Terraform outputs:

| Terraform Output | Environment Variable | Used By |
|---|---|---|
| `project_id` | `SOCKERLESS_CLOUDRUN_PROJECT` | GCR-001 |
| `region` | `SOCKERLESS_CLOUDRUN_REGION` | GCR-001 |
| `vpc_connector_id` | `SOCKERLESS_CLOUDRUN_VPC_CONNECTOR` | GCR-001 |
| `gcs_bucket_name` | `SOCKERLESS_CLOUDRUN_GCS_BUCKET` | GCR-001, GCR-004 |
| `artifact_registry_repo` | Used by TST-013 for image push | TST-013 |
| `service_account_email` | Used by TST-013 for auth | TST-013 |
| `dns_zone_name` | Used by TST-013 for DNS validation | TST-013 |

---

## Acceptance Criteria

1. `terraform/environments/cloudrun-test/` directory contains `main.tf`, `variables.tf`, `outputs.tf`, `providers.tf`, `backend.tf`, and `terraform.tfvars.example`.
2. `backend.tf` configures a GCS backend for state storage with a configurable bucket name and prefix (`sockerless/cloudrun-test`).
3. `main.tf` instantiates the Cloud Run module (`../../modules/cloudrun/`) with all required variables, using test-appropriate defaults.
4. The module is instantiated with `region = "us-central1"` (or configurable via variable) and a project ID provided via variable (no default -- must be explicitly set).
5. All resources are tagged with consistent labels: `environment = "test"`, `project = "sockerless"`, `managed-by = "terraform"`.
6. `outputs.tf` exports all values needed by the integration test suite: `project_id`, `region`, `vpc_connector_name`, `vpc_connector_id`, `dns_zone_name`, `gcs_bucket_name`, `artifact_registry_repo`, `service_account_email`, `service_account_key` (sensitive), and `cloud_run_endpoint`.
7. `variables.tf` defines: `project_id` (required, no default), `region` (default `us-central1`), `environment` (default `test`), and any module-specific overrides.
8. `terraform.tfvars.example` contains all required variables with placeholder values and comments explaining each.
9. `terraform validate` passes with zero errors in the environment directory.
10. `terraform fmt -check` passes with zero formatting deviations.
11. `terraform plan` succeeds without errors when valid GCP credentials and project ID are provided (no resources need to exist beforehand except the GCS state bucket).
12. A `README.md` in the environment directory documents: prerequisites (GCP project, billing enabled, state bucket), how to initialize (`terraform init`), how to apply (`terraform apply`), how to extract outputs for the test runner (`terraform output -json`), and how to destroy (`terraform destroy`).
13. The README includes a mapping from Terraform outputs to backend environment variables (e.g., `project_id` -> `SOCKERLESS_CLOUDRUN_PROJECT`, `region` -> `SOCKERLESS_CLOUDRUN_REGION`, etc.).

---

## Definition of Done

### Code Quality
- [ ] `terraform validate` passes with zero errors
- [ ] `terraform fmt -check` passes with zero formatting deviations
- [ ] `terraform fmt -recursive` produces no changes
- [ ] No deprecated resource types or provider features used
- [ ] Provider version constraints are pinned to minor version (e.g., `~> 5.0`)

### Testing
- [ ] `terraform plan` succeeds with valid credentials (dry run, no apply required for DoD)
- [ ] All outputs are defined and referenced correctly
- [ ] Variable defaults are sensible for a test environment (cost-optimized)
- [ ] No hard-coded project IDs, credentials, or account numbers

### Documentation
- [ ] `README.md` in the environment directory with setup and teardown instructions
- [ ] `terraform.tfvars.example` with all required variables documented
- [ ] Inline comments on non-obvious configuration choices

### Integration
- [ ] Outputs match the configuration keys expected by the Cloud Run backend (GCR-001)
- [ ] Outputs provide all values needed by TST-013 (Cloud Run integration tests)
- [ ] State backend configuration is consistent with TF-001 conventions

---

## Suggested File Paths

```
terraform/environments/cloudrun-test/
├── main.tf                    # Module instantiation with test defaults
├── variables.tf               # Input variables (project_id, region, etc.)
├── outputs.tf                 # All outputs for the test runner
├── providers.tf               # Google provider configuration
├── backend.tf                 # GCS remote state backend
├── terraform.tfvars.example   # Example variable values
└── README.md                  # Setup, usage, teardown, output mapping
```

---

## Notes

- The GCS state bucket must be created manually (or via a bootstrap script) before `terraform init`. This is a standard Terraform chicken-and-egg pattern. Document the bootstrap command: `gsutil mb -p PROJECT_ID -l us-central1 gs://sockerless-tf-state`.
- Use `us-central1` as the default region because it has the widest Cloud Run feature availability and lowest latency for US-based testing.
- The VPC Connector has a minimum cost when idle. For cost optimization, consider documenting a `terraform destroy` step after test runs complete, or using a CI/CD pipeline that provisions and tears down the environment per test run.
- The Artifact Registry repository should use Docker format (`DOCKER`) for container images.
- Service account key output is marked as `sensitive = true` in Terraform. For CI/CD pipelines, prefer workload identity federation over service account keys. Document both approaches.
- The environment should enable only the GCP APIs required by the Cloud Run backend: `run.googleapis.com`, `logging.googleapis.com`, `dns.googleapis.com`, `artifactregistry.googleapis.com`, `vpcaccess.googleapis.com`, `compute.googleapis.com`.
- For the test runner integration, provide a helper script or Makefile target that runs `terraform output -json` and exports the values as environment variables in the format expected by the Cloud Run backend. Example: `eval $(terraform output -json | jq -r 'to_entries | .[] | "export SOCKERLESS_CLOUDRUN_\(.key | ascii_upcase)=\(.value.value)"')`.
- Cloud DNS managed zone costs are negligible for testing. The zone can remain provisioned without ongoing cost.
- Consider adding a `lifecycle { prevent_destroy = false }` on expensive resources to allow easy teardown, and document the estimated monthly cost of the test environment when idle vs. active.
- Estimated monthly cost for an idle test environment: VPC Connector ~$7/month (e2-micro instances), Cloud DNS zone ~$0.20/month, GCS bucket ~$0.02/GB/month, Artifact Registry ~$0.10/GB/month. Total idle: approximately $8-10/month. Active testing adds Cloud Run job execution costs (per vCPU-second and GiB-second).
- The Google provider requires the `project` and `region` arguments. Set them at the provider level so individual resources inherit them automatically. The `google-beta` provider may be needed for certain Cloud Run v2 features; include both if required by the module.
- For local development, authenticate via `gcloud auth application-default login`. For CI/CD, use workload identity federation with a service account key as a fallback. Document both methods in the README.
- The Cloud Run Jobs API (`run.googleapis.com`) must be enabled in the project before any jobs can be created. The Cloud Run module (TF-004) handles API enablement, so the test environment relies on the module for this.
- Consider providing a Makefile or script in the environment directory with targets: `init`, `plan`, `apply`, `destroy`, `outputs`. This makes the test environment easier to operate and consistent with the TF-001 conventions.
