# MEM-002: Memory backend container lifecycle

**Component:** In-memory Backend
**Phase:** 1
**Depends on:** MEM-001
**Estimated effort:** L

---

## Description

Implement the full container lifecycle in the memory backend: create, start, inspect, list, stop, kill, remove, and wait. Containers are simulated -- no actual processes run. State transitions follow Docker's state machine (`created -> running -> exited`) with proper timestamps and exit codes. This is the core of the memory backend and the foundation for all container-related integration tests.

---

## Context

### Container state machine (Spec Section 4.3)

Docker containers follow this state machine:

```
created ──start──> running ──stop/kill──> exited
                     │                       │
                     └──────remove───────────┘ (if force)
created ─────────────────remove──────────────┘
exited ──────────────────remove──────────────┘
```

### Container create (Spec Section 4.3)

1. Generate a unique 64-character hex container ID
2. Store the full container configuration in internal state
3. Do NOT start the container yet (that happens on start)
4. Return `{"Id": "<64-char-hex>", "Warnings": []}`

**Fields that must be preserved in state** (read back by inspect):
`Image`, `Hostname`, `Cmd`, `Entrypoint`, `Env`, `Labels`, `User`, `Tty`, `ExposedPorts`, `WorkingDir`, `HostConfig.*`, `NetworkingConfig.*`, `AttachStdin`, `AttachStdout`, `AttachStderr`, `OpenStdin`, `StdinOnce`

### Container inspect response (Spec Section 4.3)

```json
{
  "Id": "<64-char-hex>",
  "Created": "2026-02-15T12:00:00Z",
  "Name": "/container-name",
  "State": {
    "Status": "running",
    "Running": true,
    "Paused": false,
    "Restarting": false,
    "OOMKilled": false,
    "Dead": false,
    "Pid": 1,
    "ExitCode": 0,
    "Error": "",
    "StartedAt": "2026-02-15T12:00:01Z",
    "FinishedAt": "0001-01-01T00:00:00Z"
  },
  "Config": { "Image": "...", "Env": [...], "Cmd": [...] },
  "HostConfig": { "..." },
  "NetworkSettings": {
    "IPAddress": "10.0.0.5",
    "Ports": {"80/tcp": [{"HostIp": "0.0.0.0", "HostPort": "8080"}]},
    "Networks": {
      "bridge": { "IPAddress": "10.0.0.5", "Aliases": ["db"], "NetworkID": "..." }
    }
  }
}
```

### Container list response (Spec Section 4.3)

```json
[
  {
    "Id": "<64-char-hex>",
    "Names": ["/container-name"],
    "Image": "nginx:latest",
    "ImageID": "sha256:...",
    "Command": "nginx -g 'daemon off;'",
    "Created": 1708000000,
    "State": "running",
    "Status": "Up 5 minutes",
    "Ports": [{"PrivatePort": 80, "PublicPort": 8080, "Type": "tcp"}],
    "Labels": {},
    "NetworkSettings": { "Networks": { "bridge": {"IPAddress": "10.0.0.5"} } }
  }
]
```

Filter formats: `{"label":["key=value"]}`, `{"id":["<id>"]}`, `{"name":["<name>"]}`, `{"status":["running"]}`

### Container stop (Spec Section 4.3)

Sends SIGTERM, waits `t` seconds, then SIGKILL. Response: `204 No Content`.

### Container kill (Spec Section 4.3)

Immediate termination. Response: `204 No Content`.

### Container wait (Spec Section 4.3)

Long-polling endpoint. Blocks until container exits. Response: `{"StatusCode": 0, "Error": null}`

### Internal API endpoints (Spec Section 7.3)

| Method | Path | Operation |
|--------|------|-----------|
| `POST` | `/internal/v1/containers` | Create |
| `GET` | `/internal/v1/containers` | List |
| `GET` | `/internal/v1/containers/{id}` | Inspect |
| `POST` | `/internal/v1/containers/{id}/start` | Start |
| `POST` | `/internal/v1/containers/{id}/stop` | Stop |
| `POST` | `/internal/v1/containers/{id}/kill` | Kill |
| `DELETE` | `/internal/v1/containers/{id}` | Remove |
| `WS` | `/internal/v1/containers/{id}/wait` | Wait |

---

## Acceptance Criteria

1. `POST /internal/v1/containers` accepts a JSON body with at minimum `Image` field, generates a 64-char hex ID, stores the container with state `created`, and returns `{"Id": "<id>", "Warnings": []}`.
2. `POST /internal/v1/containers` with a `name` query parameter stores the name; duplicate names return `409` with `{"message": "Conflict. The container name \"/name\" is already in use"}`.
3. `POST /internal/v1/containers` returns `404` if the image has not been pulled (not in the images map).
4. `POST /internal/v1/containers/{id}/start` transitions state from `created` to `running`, records `StartedAt` timestamp, and returns `204`.
5. `POST /internal/v1/containers/{id}/start` on an already running container returns `304 Not Modified`.
6. `GET /internal/v1/containers/{id}` returns the full container inspect response with `State`, `Config`, `HostConfig`, and `NetworkSettings`.
7. `GET /internal/v1/containers` returns a list of running containers; with `all=true` returns all containers including stopped.
8. `GET /internal/v1/containers` supports filters: `label` (key=value match), `id` (prefix match), `name` (prefix match), `status` (exact match).
9. `POST /internal/v1/containers/{id}/stop` transitions from `running` to `exited` with `ExitCode: 0`, records `FinishedAt`, accepts `t` query param (timeout in seconds), returns `204`.
10. `POST /internal/v1/containers/{id}/kill` immediately transitions to `exited` with `ExitCode: 137`, records `FinishedAt`, returns `204`.
11. `DELETE /internal/v1/containers/{id}` removes the container from the store; returns `204`. If the container is running and `force=true`, stop it first then remove. If running and `force=false`, return `409`.
12. `DELETE /internal/v1/containers/{id}` on a non-existent container returns `404`.
13. `WS /internal/v1/containers/{id}/wait` blocks until the container exits, then returns `{"StatusCode": <exit-code>, "Error": null}`.
14. All state transitions update `State.Status`, `State.Running`, `State.ExitCode`, `State.StartedAt`, and `State.FinishedAt` consistently.

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] New black-box REST tests written for new/changed behavior (in `tests/` module)
- [ ] Tests run against memory backend by default
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Custom error types used for all domain errors (not bare `errors.New`)
- [ ] Errors wrapped with context: `fmt.Errorf("operation: %w", err)`
- [ ] Zerolog structured logging on all error paths
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` updated

### Integration
- [ ] No breaking changes to the internal API contract
- [ ] Capability model updated if new backend capabilities are added

### Task-Specific
- [ ] Full lifecycle works: create -> inspect (created) -> start -> inspect (running) -> stop -> inspect (exited) -> remove -> inspect (404)
- [ ] Concurrent container operations safe under `-race`
- [ ] Container wait channel unblocks on stop/kill

---

## Suggested File Paths

```
backends/memory/
├── containers.go              # Container CRUD handlers: create, inspect, list, start, stop, kill, remove
├── containers_wait.go         # WebSocket-based wait handler with channel signaling
└── store.go                   # (extended) AddContainer, GetContainer, ListContainers, DeleteContainer methods
```

---

## Notes

- Use `sync.Cond` or a `chan struct{}` per container for the wait operation. When the container transitions to `exited`, close the channel to unblock all waiters. Allocate the channel at create time.
- ID lookup should support both full 64-char IDs and short prefix matching (Docker allows `docker inspect abc` to match `abc123...`). For memory backend, iterate and prefix-match.
- Name lookup: the `{id}` path parameter can be either an ID or a name. Check the name index first, then fall back to ID lookup.
- The `Status` field in list response is a human-readable string like `"Up 5 minutes"` or `"Exited (0) 2 minutes ago"`. Compute this from timestamps.
- The `Command` field in list response is a truncated string representation of Cmd/Entrypoint, matching Docker's format.
- For the simulated memory backend, `stop` with timeout `t` can simply sleep for `t` seconds (or skip the sleep since there is no real process). For test speed, skip the sleep and transition immediately.
- NetworkSettings should assign a virtual IP from a private subnet (e.g., `172.17.0.0/16`) when the container starts. Increment an IP counter in the store.
