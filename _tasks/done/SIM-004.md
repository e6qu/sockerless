# SIM-004: Azure service simulator

**Component:** Simulator
**Phase:** 3
**Depends on:** SIM-001
**Estimated effort:** XL

---

## Description

Implement a simulator for the Azure services used by the Sockerless ACA and Azure Functions backends. The simulator must be compatible with the Azure SDK for Go and the Azure CLI (`az`) by configuring a custom `AZURE_AUTHORITY_HOST` and per-client endpoint overrides. Authentication accepts any valid-format Bearer token without real validation.

The Azure simulator implements only the API actions that Sockerless backends actually call, across seven services: Container Apps Jobs, Azure Monitor / Log Analytics, Azure Files (Storage), Azure Container Registry (ACR), Private DNS Zones, Azure Functions, and Application Insights. Each service handler parses ARM-style REST requests routed by the resource provider in the URL path, validates the `api-version` query parameter, performs the operation against the in-memory state store, and returns responses in the exact ARM JSON format the real Azure API returns, including long-running operation support.

---

## Context

### Azure services used by Sockerless ACA backend

From ACA-001 and ACA-002, the ACA backend initializes SDK clients for and calls APIs on:

- **Container Apps Jobs** (from ACA-001, ACA-002): Create/update job (`BeginCreateOrUpdate`), get job, list jobs, delete job, start job execution (`BeginStart`), get execution, list executions, stop execution
- **Azure Monitor / Log Analytics** (from ACA-001): Log Analytics query API for `ContainerAppConsoleLogs_CL` table, basic metrics API
- **Azure Files** (implied by ACA volume config): Storage account properties, file shares create/get/list/delete, file operations
- **Azure Container Registry** (from ACA-001): OCI Distribution API (manifest get/put, blob upload/download, tags list), admin credentials endpoint
- **Private DNS Zones** (implied by ACA network config): Zones create/get/list/delete, record sets create/get/list/delete, VNet links create/get/delete

### Azure services used by Sockerless Azure Functions backend

- **Azure Functions**: Function Apps create/get/list/delete, functions list/get, HTTP trigger invocation
- **Application Insights**: Basic live metrics, query API

### Azure API format details

Azure uses ARM REST with JSON payloads. All requests require the `api-version` query parameter:
- Container Apps: `api-version=2024-03-01`
- Azure Monitor: `api-version=2023-04-01`
- Storage: `api-version=2023-05-01`
- DNS: `api-version=2020-06-01`
- Functions: `api-version=2023-12-01`

Resource paths follow the ARM pattern:
```
/subscriptions/{subscriptionId}/resourceGroups/{resourceGroupName}/providers/{resourceProvider}/{resourceType}/{resourceName}
```

Long-running operations return `Azure-AsyncOperation` or `Location` headers for polling. The operation resource contains `status: "InProgress"` -> `status: "Succeeded"`.

All responses include `x-ms-request-id` and `x-ms-correlation-id` headers.

### ACA execution state machine (from ACA-002)

Job executions transition: Running -> Succeeded/Failed. The simulator must implement this state machine with configurable timers.

---

## Acceptance Criteria

### Container Apps Jobs (Microsoft.App)
1. `PUT /subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.App/jobs/{name}?api-version=2024-03-01` creates or updates a Container Apps Job. Returns the job resource with `provisioningState: "Succeeded"`. Supports long-running operation via `Azure-AsyncOperation` header.
2. `GET /subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.App/jobs/{name}?api-version=2024-03-01` returns the full job resource including properties, configuration (trigger type, registries), and template (containers, volumes).
3. `GET /subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.App/jobs?api-version=2024-03-01` lists all jobs in the resource group with pagination via `nextLink`.
4. `DELETE /subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.App/jobs/{name}?api-version=2024-03-01` deletes a job. Returns 202 with `Azure-AsyncOperation` header.
5. `POST /subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.App/jobs/{name}/start?api-version=2024-03-01` starts a job execution. Returns the execution resource with `status: "Running"`. The execution transitions Running -> Succeeded on a timer (configurable, default 2s).
6. `GET /subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.App/jobs/{name}/executions/{execution}?api-version=2024-03-01` returns execution details including status, start time, end time, and replica status.
7. `GET /subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.App/jobs/{name}/executions?api-version=2024-03-01` lists executions for a job with pagination.
8. `POST /subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.App/jobs/{name}/executions/{execution}/stop?api-version=2024-03-01` stops a running execution, transitioning it to `Failed` state.
9. Managed Environments: `GET /subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.App/managedEnvironments/{name}` returns a pre-seeded environment resource (the simulator pre-creates a default managed environment on startup).

### Azure Monitor / Log Analytics
10. `POST /v1/workspaces/{workspaceId}/query` accepts a KQL query string and returns tabular results. Supports a simplified KQL parser for common patterns: `ContainerAppConsoleLogs_CL | where ContainerAppName_s == "..." | where TimeGenerated >= datetime(...)  | project TimeGenerated, Log_s, Stream_s`.
11. Log entries are stored in the simulator's state and queryable by container app name, time range, and stream type.
12. Results are returned in the Log Analytics response format: `{"tables": [{"name": "PrimaryResult", "columns": [...], "rows": [...]}]}`.
13. Pagination is supported via `$top` and `$skip` parameters in the query or via continuation tokens.

### Azure Files (Microsoft.Storage)
14. `GET /subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Storage/storageAccounts/{account}?api-version=2023-05-01` returns storage account properties (pre-seeded on startup).
15. `PUT /subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Storage/storageAccounts/{account}/fileServices/default/shares/{share}?api-version=2023-05-01` creates a file share with quota and metadata.
16. `GET .../shares/{share}` returns file share properties.
17. `GET .../shares?api-version=2023-05-01` lists file shares for a storage account.
18. `DELETE .../shares/{share}` deletes a file share.
19. File content operations (create file, read file, delete file) are simulated via in-memory storage keyed by share name and file path.

### Azure Container Registry (ACR)
20. OCI Distribution API: `GET /v2/{repo}/manifests/{reference}` returns image manifests. `PUT /v2/{repo}/manifests/{reference}` stores a manifest. Both accept and return `application/vnd.docker.distribution.manifest.v2+json` and `application/vnd.oci.image.manifest.v1+json`.
21. `POST /v2/{repo}/blobs/uploads/` initiates a blob upload, returning a `Location` header with an upload URL. `PUT /v2/{repo}/blobs/uploads/{uuid}?digest={digest}` completes the upload.
22. `GET /v2/{repo}/blobs/{digest}` returns a stored blob.
23. `GET /v2/{repo}/tags/list` returns all tags for a repository.
24. `POST /oauth2/token` returns a dummy access token for Docker authentication handshakes.
25. Admin credentials endpoint: `POST /subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.ContainerRegistry/registries/{name}/listCredentials` returns dummy admin username and passwords.

### Private DNS Zones (Microsoft.Network)
26. `PUT /subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Network/privateDnsZones/{zone}?api-version=2020-06-01` creates a private DNS zone.
27. `GET .../privateDnsZones/{zone}` returns zone details.
28. `GET .../privateDnsZones` lists all private DNS zones in the resource group.
29. `DELETE .../privateDnsZones/{zone}` deletes a zone. Fails if non-default record sets exist.
30. `PUT .../privateDnsZones/{zone}/{recordType}/{name}` creates or updates a record set (A, AAAA, CNAME, SRV, TXT).
31. `GET .../privateDnsZones/{zone}/{recordType}/{name}` returns a record set.
32. `GET .../privateDnsZones/{zone}/all` lists all record sets.
33. `DELETE .../privateDnsZones/{zone}/{recordType}/{name}` deletes a record set.
34. `PUT .../privateDnsZones/{zone}/virtualNetworkLinks/{link}` creates a VNet link.
35. `GET .../privateDnsZones/{zone}/virtualNetworkLinks/{link}` returns a VNet link.
36. `DELETE .../privateDnsZones/{zone}/virtualNetworkLinks/{link}` deletes a VNet link.

### Azure Functions (Microsoft.Web)
37. `PUT /subscriptions/{sub}/resourceGroups/{rg}/providers/Microsoft.Web/sites/{name}?api-version=2023-12-01` creates a function app with site config, app settings, and managed identity.
38. `GET .../sites/{name}` returns function app details including default hostname and state.
39. `GET .../sites` lists function apps in the resource group.
40. `DELETE .../sites/{name}` deletes a function app.
41. `GET .../sites/{name}/functions` lists functions within a function app.
42. `GET .../sites/{name}/functions/{function}` returns function details including trigger bindings.
43. HTTP trigger invocation: `POST https://{name}.azurewebsites.net/api/{function}` invokes the function, stores the payload, and returns a configurable response.

### Application Insights (basic)
44. `POST /v1/apps/{appId}/query` accepts a basic KQL query and returns results from stored telemetry data.
45. Live Metrics endpoint returns a simple heartbeat response.

### Long-running operations
46. `GET {Azure-AsyncOperation-URL}` returns the operation status: `{"status": "InProgress"}` or `{"status": "Succeeded", "properties": {...}}` or `{"status": "Failed", "error": {...}}`.
47. Operations complete after a configurable delay (default 100ms in test mode).

### General
48. All responses include `x-ms-request-id` and `x-ms-correlation-id` headers with generated UUIDs.
49. Error responses use the ARM error format: `{"error": {"code": "ResourceNotFound", "message": "..."}}` with appropriate HTTP status codes.
50. All requests are validated for the `api-version` query parameter. Missing or unsupported versions return `400 Bad Request` with an error message listing supported versions.

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] Unit tests for each service: CRUD operations, state machine transitions, error cases, pagination, filtering
- [ ] Tests use Azure SDK for Go as the client (proving SDK compatibility)
- [ ] Tests verify exact response format (JSON field names, ARM envelope, nesting)
- [ ] Tests for Container Apps execution state machine transitions
- [ ] Tests for Log Analytics KQL query parsing and result formatting
- [ ] Tests for ACR OCI Distribution API (manifest push/pull, blob upload)
- [ ] Tests for long-running operation polling
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Unknown resource providers return 404 with ARM error format
- [ ] Missing `api-version` returns 400 with descriptive message
- [ ] Resource not found returns 404 with `ResourceNotFound` code
- [ ] Resource conflict returns 409 with `Conflict` code
- [ ] Errors wrapped with context: `fmt.Errorf("azure-sim: aca: %w", err)`
- [ ] Zerolog structured logging on all error paths

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` with supported API actions, SDK configuration, and limitations

### Integration
- [ ] All services accessible via a single HTTP server (routed by ARM resource provider path)
- [ ] Long-running operations shared across services
- [ ] Configurable state machine timers for CI speed

---

## Suggested File Paths

```
simulators/azure/
├── go.mod
├── go.sum
├── README.md
├── router.go              # ARM path-based routing, api-version validation
├── containerapps.go       # Container Apps Jobs: jobs, executions
├── containerapps_state.go # Execution state machine (background goroutines)
├── loganalytics.go        # Log Analytics: KQL query, log ingestion
├── kql.go                 # Simplified KQL parser for common query patterns
├── storage.go             # Azure Files: storage accounts, file shares, files
├── acr.go                 # ACR: OCI Distribution API, admin credentials
├── dns.go                 # Private DNS Zones: zones, record sets, VNet links
├── functions.go           # Azure Functions: function apps, functions, invocation
├── appinsights.go         # Application Insights: basic query, live metrics
├── operations.go          # Long-running operations: store, poll, complete
├── arm.go                 # ARM envelope helpers (resource ID generation, response wrapping)
├── cmd/
│   └── main.go            # Azure simulator binary entrypoint
└── *_test.go              # Tests per service using Azure SDK for Go
```

---

## Notes

- ARM resource IDs follow the pattern `/subscriptions/{sub}/resourceGroups/{rg}/providers/{provider}/{type}/{name}`. The simulator should parse these from URL paths and use them as state store keys. Generate a default subscription ID (e.g., `00000000-0000-0000-0000-000000000000`) via `SIM_AZURE_SUBSCRIPTION_ID` environment variable.
- The `api-version` query parameter is mandatory on all ARM requests. The simulator should accept a set of known versions per resource provider and reject unknown versions with a helpful error message. This is important because Azure SDK clients always send `api-version` and real Azure rejects unknown versions.
- Long-running operations in Azure use two patterns: (1) `Azure-AsyncOperation` header pointing to an operation status URL, and (2) `Location` header for redirect-based polling. The simulator should support the `Azure-AsyncOperation` pattern, which is what the `armappcontainers` SDK uses.
- The KQL parser for Log Analytics does not need to be a full KQL implementation. Support the subset that Sockerless uses: `Table | where Column == "value" | where Column >= datetime(...) | project Column1, Column2 | take N`. A simple line-by-line parser that handles `where`, `project`, and `take` operators is sufficient.
- ACR's OCI Distribution API endpoints (`/v2/...`) are separate from the ARM management endpoints. Route `/v2/...` requests to the ACR handler and ARM-style requests to their respective service handlers.
- Azure Functions invocation uses a separate hostname (`{name}.azurewebsites.net`). In the simulator, route all requests to the same server and match on the `Host` header or a path prefix (`/api/{function}`).
- The Container Apps managed environment should be pre-seeded in the state store on simulator startup so that job creation requests can reference it without needing to create it first (matching the real-world pattern where the environment is created via Terraform/CLI before the backend runs).
- Consider implementing `SIM_AZURE_SUBSCRIPTION_ID`, `SIM_AZURE_RESOURCE_GROUP`, and `SIM_AZURE_LOCATION` environment variables to configure default values.
