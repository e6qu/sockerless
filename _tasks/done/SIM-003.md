# SIM-003: GCP service simulator

**Component:** Simulator
**Phase:** 3
**Depends on:** SIM-001
**Estimated effort:** XL

---

## Description

Implement a simulator for the GCP services used by the Sockerless Cloud Run and Cloud Functions backends. The simulator must be compatible with the Google Cloud Go SDK and the `gcloud` CLI by setting `CLOUDSDK_API_ENDPOINT_OVERRIDES_*` environment variables or per-client endpoint options. Authentication accepts any valid-format OAuth2 Bearer token or service account key without real validation.

The GCP simulator implements only the API actions that Sockerless backends actually call, across six services: Cloud Run Jobs v2, Cloud Logging, Cloud DNS, Cloud Storage (GCS), Artifact Registry, and Cloud Functions v2. Each service handler parses REST-style requests routed by URL path prefix, performs the operation against the in-memory state store, and returns responses in the exact JSON format the real GCP API returns, including long-running operation support.

---

## Context

### GCP services used by Sockerless Cloud Run backend

From GCR-001 and GCR-002, the Cloud Run backend initializes SDK clients for and calls APIs on:

- **Cloud Run Jobs v2** (from GCR-001, GCR-002): `CreateJob`, `GetJob`, `ListJobs`, `DeleteJob`, `RunJob` (creates execution), `GetExecution`, `ListExecutions`, `CancelExecution`
- **Cloud Logging** (from GCR-001): `entries.list` (with filter parsing for `resource.type`, `timestamp`, `severity`), `entries.write`
- **Cloud DNS** (implied by GCR-001 network config): `managedZones.create`, `managedZones.get`, `managedZones.list`, `managedZones.delete`, `resourceRecordSets.create`, `resourceRecordSets.get`, `resourceRecordSets.list`, `resourceRecordSets.delete`
- **Cloud Storage** (from GCR-001 volume config): Buckets: `create`, `get`, `list`, `delete`; Objects: `insert`, `get`, `list`, `delete`, `compose`
- **Artifact Registry** (from GCR-001): `repositories.create`, `repositories.get`, `repositories.list`, `repositories.delete`; Docker image operations via OCI Distribution API

### GCP services used by Sockerless Cloud Functions backend

- **Cloud Functions v2**: `functions.create`, `functions.get`, `functions.list`, `functions.delete`, `functions.patch`, `functions.generateUploadUrl`
- Invocation via HTTP trigger simulation

### GCP API format details

GCP uses REST with JSON payloads. Resource paths follow a hierarchical pattern:
- Cloud Run: `/v2/projects/{project}/locations/{location}/jobs/{job}`
- Cloud Logging: `/v2/entries:list`, `/v2/entries:write`
- Cloud DNS: `/dns/v1/projects/{project}/managedZones/{zone}`
- Cloud Storage: `/storage/v1/b/{bucket}`, `/storage/v1/b/{bucket}/o/{object}`
- Artifact Registry: `/v1/projects/{project}/locations/{location}/repositories/{repo}`
- Cloud Functions: `/v2/projects/{project}/locations/{location}/functions/{function}`

Long-running operations return an `Operation` resource: `{"name": "operations/...", "done": false}`. Poll via `GET /v2/{operation.name}` until `done: true`.

All responses include `x-goog-request-id` header.

### Cloud Run execution state machine (from GCR-002)

Executions transition: PENDING -> RUNNING -> SUCCEEDED/FAILED/CANCELLED. The simulator must implement this state machine with configurable timers.

---

## Acceptance Criteria

### Cloud Run Jobs v2
1. `POST /v2/projects/{project}/locations/{location}/jobs?jobId={id}` creates a job in state with the provided spec (containers, template, labels). Returns a long-running operation.
2. `GET /v2/projects/{project}/locations/{location}/jobs/{job}` returns the full job resource including conditions, execution template, and latest execution reference.
3. `GET /v2/projects/{project}/locations/{location}/jobs` returns all jobs in the specified project/location, with optional page size and page token for pagination.
4. `DELETE /v2/projects/{project}/locations/{location}/jobs/{job}` deletes a job. Returns a long-running operation. Fails if active executions exist (unless force is set).
5. `POST /v2/projects/{project}/locations/{location}/jobs/{job}:run` creates a new execution for the job. The execution starts in `PENDING` state and transitions PENDING -> RUNNING -> SUCCEEDED on a timer (configurable, default 2s per transition). Returns a long-running operation containing the execution resource.
6. `GET /v2/projects/{project}/locations/{location}/jobs/{job}/executions/{execution}` returns execution details including status, start time, completion time, and task counts.
7. `GET /v2/projects/{project}/locations/{location}/jobs/{job}/executions` lists executions for a job with pagination.
8. `POST /v2/projects/{project}/locations/{location}/jobs/{job}/executions/{execution}:cancel` transitions the execution to `CANCELLED` state.

### Cloud Logging
9. `POST /v2/entries:list` returns log entries matching the provided filter. Supports filtering by `resource.type`, `logName`, `timestamp` ranges (e.g., `timestamp >= "2026-01-01T00:00:00Z"`), and `severity` levels.
10. `POST /v2/entries:write` stores log entries in the in-memory state, keyed by log name and timestamp.
11. Log entries include `timestamp`, `severity`, `textPayload` or `jsonPayload`, `resource`, `logName`, and `insertId`.
12. Pagination is supported via `pageSize` and `pageToken` on `entries.list`.

### Cloud DNS
13. `POST /dns/v1/projects/{project}/managedZones` creates a managed zone (private or public) with DNS name and description.
14. `GET /dns/v1/projects/{project}/managedZones/{zone}` returns zone details.
15. `GET /dns/v1/projects/{project}/managedZones` lists all managed zones for a project.
16. `DELETE /dns/v1/projects/{project}/managedZones/{zone}` deletes a zone. Fails if non-default record sets exist.
17. `POST /dns/v1/projects/{project}/managedZones/{zone}/rrsets` creates a resource record set (A, AAAA, CNAME, SRV, TXT).
18. `GET /dns/v1/projects/{project}/managedZones/{zone}/rrsets` lists record sets with optional name and type filtering.
19. `DELETE /dns/v1/projects/{project}/managedZones/{zone}/rrsets/{name}/{type}` deletes a record set.

### Cloud Storage (GCS)
20. `POST /storage/v1/b?project={project}` creates a bucket with name, location, and storage class.
21. `GET /storage/v1/b/{bucket}` returns bucket metadata.
22. `GET /storage/v1/b?project={project}` lists buckets for a project.
23. `DELETE /storage/v1/b/{bucket}` deletes a bucket. Fails if objects exist.
24. `POST /upload/storage/v1/b/{bucket}/o?name={object}` (or multipart) stores an object with body and metadata.
25. `GET /storage/v1/b/{bucket}/o/{object}?alt=media` returns the object body. Returns 404 if not found.
26. `GET /storage/v1/b/{bucket}/o` lists objects with prefix filtering, delimiter support, and page tokens.
27. `DELETE /storage/v1/b/{bucket}/o/{object}` deletes an object.
28. `POST /storage/v1/b/{bucket}/o/{object}/compose` composes multiple source objects into a destination object.

### Artifact Registry
29. `POST /v1/projects/{project}/locations/{location}/repositories?repositoryId={id}` creates a repository. Returns a long-running operation.
30. `GET /v1/projects/{project}/locations/{location}/repositories/{repo}` returns repository details.
31. `GET /v1/projects/{project}/locations/{location}/repositories` lists repositories.
32. `DELETE /v1/projects/{project}/locations/{location}/repositories/{repo}` deletes a repository. Returns a long-running operation.
33. OCI Distribution API compatibility: `GET /v2/{name}/manifests/{reference}`, `PUT /v2/{name}/manifests/{reference}`, `GET /v2/{name}/blobs/{digest}`, `POST /v2/{name}/blobs/uploads/`, `GET /v2/{name}/tags/list` -- sufficient for Docker image push/pull via Artifact Registry.

### Cloud Functions v2
34. `POST /v2/projects/{project}/locations/{location}/functions?functionId={id}` creates a function with build config, service config, and HTTP trigger. Returns a long-running operation.
35. `GET /v2/projects/{project}/locations/{location}/functions/{function}` returns function details including state and URI.
36. `GET /v2/projects/{project}/locations/{location}/functions` lists functions.
37. `DELETE /v2/projects/{project}/locations/{location}/functions/{function}` deletes a function. Returns a long-running operation.
38. `PATCH /v2/projects/{project}/locations/{location}/functions/{function}` updates function configuration. Returns a long-running operation.
39. `POST /v2/projects/{project}/locations/{location}/functions:generateUploadUrl` returns a signed upload URL (points to the simulator's own endpoint for testing).
40. HTTP trigger invocation: `POST <function-uri>` invokes the function, stores the payload, and returns a configurable response.

### Long-running operations
41. `GET /v2/operations/{operation}` (or `/v1/operations/{operation}`) returns the operation status. Operations transition from `done: false` to `done: true` with the result resource embedded in `response` (or `error` on failure).
42. Operations complete after a configurable delay (default 100ms in test mode).

### General
43. All responses include `x-goog-request-id` header with a generated UUID.
44. Error responses use the GCP error format: `{"error": {"code": 404, "message": "...", "status": "NOT_FOUND"}}`.

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] Unit tests for each service: CRUD operations, state machine transitions, error cases, pagination, filtering
- [ ] Tests use Google Cloud Go SDK as the client (proving SDK compatibility)
- [ ] Tests verify exact response format (JSON field names, nesting, types)
- [ ] Tests for Cloud Run execution state machine transitions
- [ ] Tests for Cloud Logging filter parsing and entry matching
- [ ] Tests for GCS ListObjects prefix/delimiter behavior
- [ ] Tests for long-running operation polling
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Unknown paths return 404 with GCP error format
- [ ] Missing required fields return 400 with descriptive message
- [ ] Resource not found returns 404 with `NOT_FOUND` status
- [ ] Resource already exists returns 409 with `ALREADY_EXISTS` status
- [ ] Errors wrapped with context: `fmt.Errorf("gcp-sim: cloudrun: %w", err)`
- [ ] Zerolog structured logging on all error paths

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` with supported API actions, SDK configuration, and limitations

### Integration
- [ ] All services accessible via a single HTTP server (routed by URL path prefix)
- [ ] Long-running operations shared across services (common operation store and polling endpoint)
- [ ] Configurable state machine timers for CI speed

---

## Suggested File Paths

```
simulators/gcp/
├── go.mod
├── go.sum
├── README.md
├── router.go              # REST path-based routing to service handlers
├── cloudrun.go            # Cloud Run Jobs v2: jobs, executions
├── cloudrun_state.go      # Execution state machine (background goroutines)
├── logging.go             # Cloud Logging: entries write/list, filter parsing
├── dns.go                 # Cloud DNS: managed zones, record sets
├── storage.go             # Cloud Storage: buckets, objects
├── artifactregistry.go    # Artifact Registry: repositories, OCI Distribution API
├── functions.go           # Cloud Functions v2: functions, invocations
├── operations.go          # Long-running operations: store, poll, complete
├── cmd/
│   └── main.go            # GCP simulator binary entrypoint
└── *_test.go              # Tests per service using Google Cloud Go SDK
```

---

## Notes

- GCP resource names follow the pattern `projects/{project}/locations/{location}/jobs/{job}`. The simulator should parse these from URL paths and store resources keyed by their full resource name.
- Long-running operations are central to the GCP API design. Many create/delete/update calls return an operation. Implement a shared operation store that all services use. Operations should auto-complete after a configurable delay (background goroutine sets `done: true` and embeds the result).
- Cloud Logging filter parsing does not need to be a full implementation of the Cloud Logging filter language. Support the subset that Sockerless actually uses: `resource.type = "..."`, `logName = "..."`, `timestamp >= "..." AND timestamp <= "..."`, and `severity >= "..."`. A simple string-matching parser is sufficient.
- Cloud Storage object bodies should be stored in memory as `[]byte`. For the expected test usage (terraform state files, small artifacts), memory usage is not a concern.
- Artifact Registry's Docker/OCI Distribution API is separate from its management API. The OCI endpoints (`/v2/...`) use a different authentication model (Docker registry auth) but the simulator can accept any credentials. Implement enough of the OCI spec to support `docker push` and `docker pull` (manifest get/put, blob upload/download, tags list).
- Cloud Functions `generateUploadUrl` should return a URL pointing back to the simulator itself (e.g., `http://localhost:4567/upload/...`) so that test code can upload function source to the simulator.
- For `gcloud` CLI compatibility, set `CLOUDSDK_API_ENDPOINT_OVERRIDES_RUN=http://localhost:4567/` (and similar for other services). Document all required environment variables.
- Consider implementing a `SIM_GCP_PROJECT` environment variable to set the default project ID used when the SDK does not specify one.
