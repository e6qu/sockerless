# TF-006: ACA Terraform module

**Component:** Terraform
**Phase:** 3
**Depends on:** TF-001
**Estimated effort:** L

---

## Description

Create a Terraform module that provisions all Azure infrastructure required by the Azure Container Apps (ACA) backend (ACA-001 through ACA-004). The module lives under `terraform/modules/aca/` and creates: a resource group (or uses an existing one), a Container Apps Environment with VNet integration, a VNet with a subnet delegated to Container Apps, a Log Analytics workspace for container logs, an Azure Files storage account and default file share for volume mounts, an Azure Container Registry for agent images and loaded images, a user-assigned managed identity with all required RBAC roles, a private DNS zone for service discovery linked to the VNet, and an NSG for the subnet with required security rules. All resources are parameterized via input variables with sensible defaults.

---

## Context

### ACA backend resource requirements (from ACA-001)

> ```yaml
> aca:
>   subscription_id: "00000000-0000-0000-0000-000000000000"
>   resource_group: "sockerless-rg"
>   managed_environment_name: "sockerless-env"
>   location: "eastus"
>   log_analytics_workspace_id: "/subscriptions/.../workspaces/sockerless-logs"
>   storage_account_name: "sockerlessstorage"
>   storage_account_key: ""            # or use managed identity
>   registry_server: "sockerless.azurecr.io"
>   registry_username: ""              # or use managed identity
>   registry_password: ""
> ```

### ACA backend mapping (Spec Section 9.1)

> | Docker Concept | ACA Mapping |
> |---|---|
> | Container create + start | `Create Job` + `Start Job Execution` |
> | Container stop | `Stop Job Execution` |
> | Container logs | Azure Monitor / Log Analytics |
> | Exec / Attach | Via sockerless-agent (agent on container port, VNet accessible) |
> | Image pull | ACA pulls from ACR / Docker Hub natively |
> | Network | VNet integration (managed environment) |
> | Volume | Azure Files, ephemeral storage |

### Network emulation (from ACA-004, Spec Section 11.2)

> ACA provides environment-scoped internal DNS where container names and configured aliases resolve within the managed environment's VNet. The managed environment must be VNet-integrated (`vnetConfiguration` set during environment creation).

### Volume emulation (from ACA-004, Spec Section 10.3)

> 1. Create an Azure Files share per sockerless instance
> 2. Mount the share in the container app job
> 3. Shared access via the same file share
>
> The storage account access key is used for mounting Azure Files shares in Container Apps Jobs. Alternatively, managed identity can be used if the Container Apps environment has the appropriate RBAC role on the storage account.

### Agent networking (from ACA-002, Spec Section 9.1)

> Container Apps jobs run within a managed environment that is VNet-integrated. The agent listens on port 9111. The frontend must be able to reach the container's IP within the VNet (same VNet, peering, or VPN gateway).

### Required Azure RBAC roles (from ACA-001)

> Contributor on the resource group, or finer-grained: Container Apps Contributor, Storage Account Contributor, Log Analytics Reader.

---

## Acceptance Criteria

### Resource Group
1. The module creates a new Azure resource group when `create_resource_group = true` (default), or accepts an existing resource group name via `existing_resource_group_name` variable.
2. The resource group is created in the configured `location` with consistent tags.

### VNet and Subnet
3. The module creates a VNet with a configurable address space (default `10.0.0.0/16`).
4. A subnet is created within the VNet with a configurable address prefix (default `10.0.0.0/23`) and delegated to `Microsoft.App/environments` for Container Apps.
5. An NSG is created and associated with the subnet. Rules allow: inbound TCP 9111 from VNet (agent traffic), outbound HTTPS to Internet (Azure SDK, registry pulls), and deny all other inbound from Internet.

### Container Apps Environment
6. A Container Apps Environment is created with VNet integration, using the delegated subnet.
7. The environment is configured with the Log Analytics workspace for log ingestion (`appLogsConfiguration` with `logAnalyticsConfiguration`).
8. The environment's `workloadProfileType` is configurable (default `"Consumption"` for cost optimization, with option for `"Dedicated"`).

### Log Analytics Workspace
9. A Log Analytics workspace is created with configurable SKU (default `PerGB2018`) and retention period (default 30 days).
10. The workspace ID and primary key are output for backend configuration.

### Azure Files Storage
11. A storage account is created with configurable SKU (default `Standard_LRS`), HTTPS-only, and TLS 1.2 minimum.
12. The storage account name is auto-generated from the project name prefix (lowercase alphanumeric, max 24 chars) or configurable via variable.
13. A default Azure Files share is created within the storage account (default name `sockerless-volumes`, configurable quota default 100 GiB).
14. The storage account name and access key are output for backend configuration.

### Azure Container Registry
15. An ACR instance is created with configurable SKU (default `Basic` for test, `Standard` or `Premium` for production).
16. The ACR admin user is enabled when `acr_admin_enabled = true` (default `false`; managed identity is preferred).
17. The ACR login server is output for backend configuration.

### Managed Identity and RBAC
18. A user-assigned managed identity is created for the ACA backend.
19. The identity is assigned the following RBAC roles: `Contributor` on the Container Apps Environment, `Storage Blob Data Contributor` on the storage account, `AcrPull` on the ACR instance, `Monitoring Reader` on the Log Analytics workspace.
20. The managed identity client ID and principal ID are output for backend configuration.

### DNS Zone
21. A private DNS zone is created (default `sockerless.internal`) and linked to the VNet for service discovery resolution within the environment.
22. The DNS zone name is output for backend configuration.

### Tags and Naming
23. All resources receive consistent tags: `environment`, `project = "sockerless"`, `managed-by = "terraform"`, plus any additional tags from the `extra_tags` variable.
24. Resource names follow a consistent naming convention using the `name_prefix` variable (default `sockerless`).

### Validation
25. `terraform validate` passes with zero errors.
26. `terraform fmt -check` passes with zero formatting deviations.
27. All input variables have descriptions, types, and sensible defaults.
28. All outputs have descriptions and expose the values needed by the ACA backend configuration (ACA-001).

---

## Definition of Done

### Code Quality
- [ ] `terraform validate` passes with zero errors
- [ ] `terraform fmt -check` passes with zero formatting deviations
- [ ] `terraform fmt -recursive` produces no changes
- [ ] No deprecated resource types or provider features used
- [ ] Provider version constraints are pinned to minor version (e.g., `~> 4.0`)
- [ ] All variables have type constraints, descriptions, and validation rules where appropriate
- [ ] No hard-coded subscription IDs, tenant IDs, or credentials

### Testing
- [ ] `terraform plan` succeeds with valid Azure credentials (dry run, no apply required for DoD)
- [ ] All outputs are defined and referenced correctly
- [ ] Module can be instantiated multiple times in the same subscription with different `name_prefix` values (no naming collisions)
- [ ] Module works with both `create_resource_group = true` and `create_resource_group = false`

### Documentation
- [ ] `README.md` in the module directory with usage example, input variables table, and outputs table
- [ ] Inline comments on non-obvious configuration (e.g., subnet delegation, NSG rules, RBAC role assignments)

### Integration
- [ ] Outputs match the configuration keys expected by the ACA backend (ACA-001): `resource_group_name`, `managed_environment_name`, `managed_environment_id`, `location`, `log_analytics_workspace_id`, `storage_account_name`, `storage_account_key`, `registry_server`, `managed_identity_client_id`
- [ ] VNet configuration supports agent networking (port 9111 accessible from frontend)
- [ ] Azure Files storage supports volume mounts for Container Apps Jobs (ACA-004)
- [ ] DNS zone supports service discovery aliases (ACA-004)

---

## Suggested File Paths

```
terraform/modules/aca/
├── main.tf                    # Resource group, Container Apps Environment
├── variables.tf               # All input variables with defaults
├── outputs.tf                 # All outputs for backend configuration
├── providers.tf               # AzureRM provider version constraints
├── vnet.tf                    # VNet, subnet, delegation, NSG
├── log_analytics.tf           # Log Analytics workspace
├── storage.tf                 # Storage account and Azure Files share
├── acr.tf                     # Azure Container Registry
├── identity.tf                # User-assigned managed identity and RBAC role assignments
├── dns.tf                     # Private DNS zone and VNet link
├── versions.tf                # Terraform and provider version constraints
└── README.md                  # Module documentation
```

---

## Notes

- The Container Apps Environment requires a subnet with a minimum `/23` CIDR range when VNet-integrated. The default `10.0.0.0/23` provides 512 addresses, which is the minimum. For larger deployments, use `/21` or larger.
- Subnet delegation to `Microsoft.App/environments` is required for internal VNet integration. Once delegated, the subnet cannot be used for other resource types.
- The storage account name must be globally unique across all Azure subscriptions. Use a naming convention like `${name_prefix}sa${random_suffix}` or allow explicit override. Consider using `random_string` resource for the suffix.
- ACR Basic SKU is sufficient for testing but has limited storage (10 GiB) and throughput. For production or heavy image-load testing, use Standard or Premium SKU.
- RBAC role assignments may take up to 5 minutes to propagate. The ACA backend should retry operations that fail with `AuthorizationFailed` during initial setup.
- The NSG rule for port 9111 allows agent traffic from within the VNet only. If the frontend runs outside the VNet (e.g., on a developer machine), additional network configuration (VPN gateway, peering, or public IP with NSG rule) is needed. Document this in the README.
- Azure Private DNS zones have a TTL of 1 second minimum. For service discovery during testing, use low TTL values to allow rapid DNS updates when containers start and stop.
- The Log Analytics workspace `PerGB2018` pricing tier charges per GB ingested. For testing, set a low daily cap (e.g., 1 GB/day) to control costs. This is configurable via the `daily_quota_gb` variable.
- Consider adding a `lifecycle { prevent_destroy = true }` on the resource group and storage account in production environments, but leave it off (or `false`) for test environments to allow easy teardown.
- The managed identity must be assigned to the Container Apps Environment as the environment-level identity for pulling images from ACR. This is separate from the RBAC role assignments -- the identity must also be configured in the environment's `identity` block.
- For the DNS zone, use a private zone (not public) since service discovery is VNet-internal only. The zone is linked to the VNet via `azurerm_private_dns_zone_virtual_network_link`.
