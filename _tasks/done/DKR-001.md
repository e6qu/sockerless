# DKR-001: Docker backend scaffold

**Component:** Docker Daemon Backend
**Phase:** 1
**Depends on:** API-002
**Estimated effort:** M

---

## Description

Build the Docker backend for Sockerless. This backend connects to a real Docker daemon via the Docker Go SDK and serves as the reference implementation for testing. If the test suite passes against the Docker backend, the API contract is correct. The Docker backend uses Docker's native exec and attach -- no agent is needed.

This task creates the scaffold: binary entrypoint (`sockerless-backend-docker`), Docker client connection, capability reporting, and the HTTP server that accepts internal API calls. The actual operation passthrough is implemented in DKR-002.

---

## Context

### Docker backend role (Spec Section 9.3)

| Docker Concept | Docker Mapping |
|---|---|
| Container create + start | `POST /containers/create` + `POST /containers/{id}/start` on real Docker daemon |
| Exec / Attach | Docker's native exec and attach (no agent needed) |
| Everything else | 1:1 passthrough to Docker daemon |

> **Capabilities:** `exec: true, attach: true, logs: true, logs_follow: true, volumes: true, networks: true, health_checks: true, agent_required: false`

> The Docker backend is the **reference implementation** for testing. Running the test suite against the Docker backend validates that sockerless produces responses identical to a real Docker daemon.

### Backend architecture (Spec Section 6.4)

Each backend is a **stateful** daemon that:

1. Listens on a Unix socket (or TCP) for internal API calls from the frontend
2. Owns all persistent state (delegated to Docker daemon in this case)
3. Translates internal API calls into Docker SDK calls
4. Reports its capabilities so the frontend can return `501 Not Implemented` for unsupported operations

### Docker backend special case (Spec Section 6.4)

> The Docker backend (`backends/docker/`) talks to a real Docker daemon. It does NOT need the agent -- it uses Docker's native exec and attach APIs directly.

### Module dependencies (Spec Section 6.2)

| Module | Binary Name | External Dependencies |
|--------|------------|----------------------|
| `backends/docker/` | `sockerless-backend-docker` | `api/`, `github.com/docker/docker` client SDK |

### Capability reporting (Spec Section 7.4)

`GET /internal/v1/capabilities` returns:

```json
{
  "backend": "docker",
  "version": "0.1.0",
  "capabilities": {
    "exec": true,
    "attach": true,
    "logs": true,
    "logs_follow": true,
    "volumes": true,
    "networks": true,
    "health_checks": true,
    "image_pull": true,
    "image_load": true,
    "max_timeout_seconds": 0,
    "agent_required": false
  }
}
```

---

## Acceptance Criteria

1. `sockerless-backend-docker` binary compiles and runs from `cmd/sockerless-backend-docker/main.go`.
2. Server listens on a Unix socket (default `/var/run/sockerless-backend.sock`) or TCP address and responds to internal API requests.
3. Docker client connects to the Docker daemon at the configured socket path (default `/var/run/docker.sock`) using the Docker Go SDK (`github.com/docker/docker/client`).
4. Docker client uses API version negotiation (`client.WithAPIVersionNegotiation()`) to auto-detect the daemon's API version.
5. `GET /internal/v1/capabilities` returns the capability JSON above with `backend: "docker"` and all capabilities `true`, `agent_required: false`.
6. Configuration loads from CLI flags (`--socket`, `--tcp`, `--docker-socket`, `--docker-api-version`, `--log-level`) and environment variables (`SOCKERLESS_BACKEND_SOCKET`, `DOCKER_HOST`).
7. On startup, the backend verifies connectivity to the Docker daemon by calling `client.Ping(ctx)`. If the daemon is unreachable, log an error and exit.
8. Server returns `{"message": "..."}` format for all error responses.
9. Graceful shutdown on SIGTERM/SIGINT: close Docker client, drain in-flight requests, clean exit.
10. All requests are logged via zerolog with method, path, status code, and duration.

### Example Requests

```bash
# Capability check
curl --unix-socket /var/run/sockerless-backend.sock \
  http://localhost/internal/v1/capabilities
# Expected: 200
# {
#   "backend": "docker",
#   "version": "0.1.0",
#   "capabilities": {
#     "exec": true,
#     "attach": true,
#     "logs": true,
#     "logs_follow": true,
#     "volumes": true,
#     "networks": true,
#     "health_checks": true,
#     "image_pull": true,
#     "image_load": true,
#     "max_timeout_seconds": 0,
#     "agent_required": false
#   }
# }

# Verify Docker daemon connectivity (implicit in startup)
# If /var/run/docker.sock is not available, the backend exits with error:
# "failed to connect to Docker daemon: ..."
```

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] New black-box REST tests written for new/changed behavior (in `tests/` module)
- [ ] Tests run against memory backend by default
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Custom error types used for all domain errors (not bare `errors.New`)
- [ ] Errors wrapped with context: `fmt.Errorf("operation: %w", err)`
- [ ] Zerolog structured logging on all error paths
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` created or updated

### Integration
- [ ] No breaking changes to the internal API contract
- [ ] Capability model updated if new backend capabilities are added

### Task-Specific
- [ ] Binary entrypoint works: `go run ./cmd/sockerless-backend-docker/main.go --help`
- [ ] Docker client connects to daemon and pings successfully
- [ ] Capabilities endpoint returns correct JSON
- [ ] Backend fails gracefully when Docker daemon is unavailable

---

## Suggested File Paths

```
backends/docker/
├── go.mod                         # module github.com/sockerless/backend-docker, go 1.23
├── go.sum
├── README.md
├── client.go                      # Docker SDK client wrapper, connection setup, ping
├── server.go                      # HTTP server setup, route registration
├── capabilities.go                # Capability reporting handler
├── config.go                      # CLI flags, env vars (socket path, API version)
├── errors.go                      # Error mapping: Docker SDK errors -> internal errors
└── cmd/
    └── sockerless-backend-docker/
        └── main.go                # Binary entrypoint
```

---

## Notes

- Use `github.com/docker/docker/client` package. Create the client with `client.NewClientWithOpts(client.FromEnv, client.WithAPIVersionNegotiation())` for maximum compatibility.
- The `DOCKER_HOST` environment variable is respected by `client.FromEnv`. Common values: `unix:///var/run/docker.sock`, `tcp://localhost:2375`.
- Error mapping is critical. Docker SDK returns typed errors (e.g., `errdefs.IsNotFound(err)`). Map these to the internal API error types from API-003.
- The Docker backend does not need its own state store -- Docker daemon is the source of truth. However, it may need a thin cache or mapping layer for translating between internal API types and Docker SDK types.
- This backend is meant to run alongside a real Docker daemon (Docker Desktop, colima, etc.). Tests that use this backend require Docker to be installed and running.
- Consider wrapping the Docker client in an interface for testability (mock Docker client in unit tests).
