# P32-003: Add Top and Stats to ProcessLifecycleDriver

**Phase:** 32A (Driver Interface Extension)
**Depends on:** —
**Estimated effort:** S

---

## Description

Add `Top` and `Stats` methods to `ProcessLifecycleDriver` so `handleContainerTop`, `buildStatsEntry`, and `handleSystemDf` don't need to call `s.Store.Processes.Load()`.

## What to Change

### 1. Extend `ProcessLifecycleDriver` interface in `backends/core/drivers.go`

Add:
```go
// Top returns process list entries and the formatted start time.
// Returns nil entries if no process is running.
Top(containerID string) ([]ProcessTopEntry, string)

// Stats returns resource usage for the container process.
// Returns zero stats if no process is running.
Stats(containerID string) ProcessStats
```

### 2. Implement in both tiers

**WASMProcessLifecycleDriver** (`drivers_process.go`):
```go
func (d *WASMProcessLifecycleDriver) Top(containerID string) ([]ProcessTopEntry, string) {
    if wp, ok := d.Store.Processes.Load(containerID); ok {
        proc := wp.(ContainerProcess)
        return proc.Top(), proc.FormatStartTime()
    }
    return nil, ""
}

func (d *WASMProcessLifecycleDriver) Stats(containerID string) ProcessStats {
    if wp, ok := d.Store.Processes.Load(containerID); ok {
        return wp.(ContainerProcess).Stats()
    }
    return ProcessStats{}
}
```

**SyntheticProcessLifecycleDriver** (`drivers_synthetic.go`):
```go
func (d *SyntheticProcessLifecycleDriver) Top(_ string) ([]ProcessTopEntry, string) {
    return nil, ""
}

func (d *SyntheticProcessLifecycleDriver) Stats(_ string) ProcessStats {
    return ProcessStats{}
}
```

### 3. Update handler code in `handle_extended.go`

**handleContainerTop** (lines 30-54) — replace `s.Store.Processes.Load` block:
```go
// AFTER:
entries, stime := s.Drivers.ProcessLifecycle.Top(id)
if entries != nil {
    // ... build processes from entries + stime ...
    WriteJSON(...)
    return
}
// synthetic fallback below...
```

**buildStatsEntry** (lines 144-149) — replace:
```go
// AFTER:
stats := s.Drivers.ProcessLifecycle.Stats(containerID)
memUsage = stats.MemoryUsage
// etc.
```

### 4. Add RootPath usage for handleSystemDf

`handleSystemDf` (lines 292-294) uses `Store.Processes.Load` + `RootPath()` for disk size. After P32-001 adds `RootPath` to `FilesystemDriver`, replace:
```go
// BEFORE:
if wp, ok := s.Store.Processes.Load(c.ID); ok {
    cs.SizeRw = DirSize(wp.(ContainerProcess).RootPath())
}

// AFTER:
if rp := s.Drivers.Filesystem.RootPath(c.ID); rp != "" {
    cs.SizeRw = DirSize(rp)
}
```

## Acceptance Criteria

1. `ProcessLifecycleDriver` interface has `Top` and `Stats` methods
2. Both tiers implement the methods
3. `handleContainerTop`, `buildStatsEntry`, `handleSystemDf` no longer call `Store.Processes.Load`
4. All tests pass: `make test`, `make lint`

## After Completing

Update `_tasks/done/P32-003.md` with actual changes. Update `STATUS.md` progress line.
