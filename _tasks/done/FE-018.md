# FE-018: Network endpoints

**Component:** FE (Docker REST API frontend)
**Phase:** 1
**Depends on:** FE-001, MEM-004
**Estimated effort:** M

---

## Description

Implement all six network endpoints: create, list, inspect, disconnect, remove, and prune. Networks are used by both CI runners to provide DNS-based service discovery between containers. GitLab Runner creates a per-build network and attaches all job containers (helper, build, services) to it. GitHub Actions Runner creates a network for container jobs and services, and failure to create the network is FATAL (no fallback). Network prune with label filters is used by GitHub Runner during cleanup.

---

## Context

### Network create (Spec Section 4.5)

> `POST /networks/create`
>
> Request body:
> ```json
> {
>   "Name": "github_network_abc123",
>   "Labels": {"com.gitlab.gitlab-runner.managed": "true"},
>   "EnableIPv6": false,
>   "Driver": "bridge",
>   "Options": {
>     "com.docker.network.driver.mtu": "1500"
>   }
> }
> ```
>
> Response:
> ```json
> {
>   "Id": "<64-char-hex>",
>   "Warning": ""
> }
> ```
>
> Sockerless: Creates a logical network in internal state. The actual cloud networking is configured when containers join this network.

### Network list (Spec Section 4.5)

> `GET /networks` -- List Networks
>
> Query parameter: `filters` (JSON)
>
> Filter formats used: `{"label":["key=value"]}`, `{"name":["name"]}`

### Network inspect (Spec Section 4.5)

> `GET /networks/{id}` -- Inspect Network
>
> Returns network details including connected containers:
> ```json
> {
>   "Name": "build-network",
>   "Id": "<hex>",
>   "Created": "2026-02-15T12:00:00Z",
>   "Scope": "local",
>   "Driver": "bridge",
>   "EnableIPv6": false,
>   "IPAM": {
>     "Driver": "default",
>     "Config": [{"Subnet": "172.18.0.0/16", "Gateway": "172.18.0.1"}]
>   },
>   "Containers": {
>     "<container-id>": {
>       "Name": "postgres",
>       "IPv4Address": "172.18.0.2/16"
>     }
>   },
>   "Labels": {}
> }
> ```

### Network disconnect (Spec Section 4.5)

> `POST /networks/{id}/disconnect`
>
> ```json
> {"Container": "<container-id>", "Force": true}
> ```

### Network remove (Spec Section 4.5)

> `DELETE /networks/{id}`
>
> Response: `204 No Content`

### Network prune (Spec Section 4.5)

> `POST /networks/prune`
>
> Query parameter: `filters` (JSON, e.g., `{"label":["key"]}`)
>
> Response: `{"NetworksDeleted": ["net1", "net2"]}`

### GitHub Runner network requirement (Spec Section 13.2.4)

> **Network creation is mandatory:**
> The runner ALWAYS creates a network (`github_network_<GUID>`) when container jobs or services are present. Network creation failure is FATAL -- no fallback. Cleanup includes `docker network rm` + `docker network prune --filter label=<hash>`.

### GitLab Runner network usage (Spec Section 13.1.2)

> ```
> 3. Network Setup
>    NetworkCreate("runner-net-<guid>")         # per-build network (FF_NETWORK_PER_BUILD)
> ```
>
> ```
> 8. Cleanup
>    NetworkDisconnect(networkID, id, force=true)
>    NetworkRemove(networkID)
> ```

### Network aliases (Spec Section 13.1.3)

> With `FF_NETWORK_PER_BUILD` enabled (recommended), the runner creates a per-build user-defined bridge network. Service aliases (e.g., `["postgres", "db"]`) are set via `NetworkingConfig.EndpointsConfig[networkName].Aliases`. Docker's embedded DNS resolves these aliases within the network.

---

## Acceptance Criteria

1. `POST /networks/create` accepts a JSON body with: `Name` (required), `Labels` (map), `EnableIPv6` (bool), `Driver` (string), `Options` (map), `IPAM` (object with Driver and Config).
2. `POST /networks/create` returns `201 Created` with `{"Id": "<64-char-hex>", "Warning": ""}`.
3. `POST /networks/create` returns `409` with `{"message": "network with name <name> already exists"}` if a network with the same name exists.
4. `POST /networks/create` must succeed reliably -- this is a fatal operation for GitHub Runner.
5. `GET /networks` returns `200 OK` with an array of network objects.
6. `GET /networks` supports `filters` query parameter with JSON-encoded filters: `label` (key or key=value), `name`.
7. `GET /networks/{id}` returns `200 OK` with the full network inspect response including `Containers` map.
8. `GET /networks/{id}` returns `404` with `{"message": "network <id> not found"}` if the network does not exist.
9. `GET /networks/{id}` accepts both network ID and name for the `{id}` path parameter.
10. `POST /networks/{id}/disconnect` accepts a JSON body with `Container` (string, container ID or name) and `Force` (bool).
11. `POST /networks/{id}/disconnect` returns `200 OK` on success.
12. `POST /networks/{id}/disconnect` returns `404` if the network or container does not exist.
13. `DELETE /networks/{id}` returns `204 No Content` on success.
14. `DELETE /networks/{id}` returns `404` with `{"message": "network <id> not found"}` if the network does not exist.
15. `DELETE /networks/{id}` returns `403` with `{"message": "... has active endpoints"}` if containers are still connected (unless force disconnect has been done first).
16. `POST /networks/prune` returns `200 OK` with `{"NetworksDeleted": [...]}`.
17. `POST /networks/prune` supports `filters` query parameter with `label` filter.
18. `POST /networks/prune` only removes networks with no connected containers.
19. The `Containers` map in network inspect is updated when containers are started on or disconnected from the network.
20. Networks auto-assign IPAM subnets (e.g., 172.18.0.0/16, 172.19.0.0/16) and assign IPs to connected containers.

### Example Requests

```bash
# Create a network
curl -s -X POST --unix-socket /var/run/sockerless.sock \
  -H "Content-Type: application/json" \
  -d '{
    "Name": "github_network_abc123",
    "Labels": {"runner-id": "abc123"},
    "Driver": "bridge"
  }' \
  http://localhost/v1.44/networks/create
# Response: 201 Created
# {"Id":"a1b2c3d4e5f6...","Warning":""}

# List all networks
curl -s --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/networks
# Response: 200 OK
# [{"Name":"github_network_abc123","Id":"a1b2c3d4...","Driver":"bridge",...}]

# List networks with label filter
curl -s --unix-socket /var/run/sockerless.sock \
  "http://localhost/v1.44/networks?filters=%7B%22label%22%3A%5B%22runner-id%3Dabc123%22%5D%7D"
# Response: 200 OK (filtered list)

# Inspect a network
curl -s --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/networks/a1b2c3d4e5f6
# Response: 200 OK
# {"Name":"github_network_abc123","Id":"a1b2c3d4...","Containers":{...},...}

# Disconnect a container from a network
curl -s -X POST --unix-socket /var/run/sockerless.sock \
  -H "Content-Type: application/json" \
  -d '{"Container": "container123", "Force": true}' \
  http://localhost/v1.44/networks/a1b2c3d4e5f6/disconnect
# Response: 200 OK

# Remove a network
curl -s -X DELETE --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/networks/a1b2c3d4e5f6
# Response: 204 No Content

# Prune networks with label filter
curl -s -X POST --unix-socket /var/run/sockerless.sock \
  "http://localhost/v1.44/networks/prune?filters=%7B%22label%22%3A%5B%22runner-id%22%5D%7D"
# Response: 200 OK
# {"NetworksDeleted":["github_network_abc123"]}

# Create duplicate network (error)
curl -s -X POST --unix-socket /var/run/sockerless.sock \
  -H "Content-Type: application/json" \
  -d '{"Name": "github_network_abc123"}' \
  http://localhost/v1.44/networks/create
# Response: 409
# {"message":"network with name github_network_abc123 already exists"}
```

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] New black-box REST tests written for: create, create duplicate, list (all, with label filter, with name filter), inspect (with containers), disconnect, remove, remove with active endpoints, prune (with and without filters)
- [ ] Tests run against memory backend by default
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Custom error types used for all domain errors (NotFound, Conflict, Forbidden)
- [ ] Errors wrapped with context: `fmt.Errorf("network create: %w", err)`
- [ ] Zerolog structured logging on all error paths
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` updated if new public API is added

### Integration
- [ ] No breaking changes to the internal API contract
- [ ] Network state is used by FE-004 (container create with NetworkMode) and FE-006 (container inspect NetworkSettings)
- [ ] Capability model updated if network operations are a separate capability

---

## Suggested File Paths

```
frontends/docker/
├── handler_network_create.go      # POST /networks/create
├── handler_network_list.go        # GET /networks
├── handler_network_inspect.go     # GET /networks/{id}
├── handler_network_disconnect.go  # POST /networks/{id}/disconnect
├── handler_network_remove.go      # DELETE /networks/{id}
├── handler_network_prune.go       # POST /networks/prune
└── routes.go                      # Register new routes (update existing)
```

---

## Notes

- The `Driver` field defaults to `"bridge"` if not specified. Sockerless only supports `"bridge"` semantically -- other drivers are accepted and stored but all networks behave the same way (logical grouping with synthetic IPAM).
- IPAM subnet allocation should be deterministic. Use a simple incrementing subnet allocator: first network gets 172.18.0.0/16, second gets 172.19.0.0/16, etc. Container IPs within the subnet are assigned sequentially.
- The `Containers` map in network inspect must show all containers that have been started on this network. Containers that are created with `NetworkMode` set to this network but not yet started should NOT appear.
- Docker's network prune only removes networks that have zero connected containers and are not predefined networks (bridge, host, none). Sockerless does not have predefined networks, so prune removes all empty networks matching the filter.
- The `filters` query parameter is URL-encoded JSON. The handler must parse this correctly. Example decoded: `{"label":["com.gitlab.gitlab-runner.managed=true"]}`.
- Label filter supports both `key` (just presence) and `key=value` (exact match) formats.
- GitHub Runner's cleanup does both `docker network rm <name>` and `docker network prune --filter label=<hash>`. The prune acts as a safety net to catch networks that might have been missed. Both must work.
