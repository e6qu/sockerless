# ECS-003: ECS container inspect, list, stop, kill, remove

**Component:** ECS (AWS ECS Fargate backend)
**Phase:** 2
**Depends on:** ECS-002
**Estimated effort:** L

---

## Description

Implement the container inspection, listing, stop, kill, and remove operations for the ECS backend. These operations translate Docker container lifecycle calls into ECS API calls: `DescribeTasks` for inspect, task filtering for list, `StopTask` for stop/kill, and task definition deregistration for remove. The inspect response must match Docker's format precisely, including state fields, network settings, and config -- CI runners parse these fields to make decisions about container readiness, health, and cleanup.

---

## Context

### ECS container mappings (Spec Section 9.1)

> | Docker Concept | ECS Mapping |
> |---|---|
> | Container inspect | `DescribeTasks` |
> | Container stop | `StopTask` |
> | Container kill | `StopTask` (ECS has no SIGKILL; tasks get 30s SIGTERM then forced stop) |
> | Container remove | Deregister task definition, clean up |

### GitHub Actions inspect usage (Spec Section 13.2.4)

> After starting a container, the runner calls `docker inspect` and reads `Config.Env` -- an array of `KEY=VALUE` strings. It iterates through the array looking for entries starting with `PATH=`. This PATH is used when constructing `docker exec` commands to find binaries inside the container.

### GitLab Runner inspect usage (Spec Section 13.1.3)

> Before probing service ports, the runner polls `ContainerInspect` until `State.Status` is no longer `"created"`.

### Cleanup (Spec Section 13.1.2)

> ```
> 8. Cleanup (5-minute timeout, parallel)
>    For each container:
>      ContainerKill(id, "SIGTERM")
>      ContainerStop(id, timeout=0)
>      NetworkDisconnect(networkID, id, force=true)
>      ContainerRemove(id, force=true, removeVolumes=true)
>    NetworkRemove(networkID)
>    VolumeRemove(volumeID)
> ```

---

## Acceptance Criteria

### ContainerInspect
1. `ContainerInspect` calls `DescribeTasks` and maps the ECS task state to Docker's container state format.
2. ECS task status mapping: `PROVISIONING`/`PENDING` -> `created`, `ACTIVATING`/`RUNNING` -> `running`, `DEACTIVATING`/`STOPPING`/`STOPPED` -> `exited`.
3. The response includes `State.Status`, `State.Running` (bool), `State.StartedAt`, `State.FinishedAt`, `State.ExitCode`, `State.Error` (from ECS stop reason).
4. `Config.Image`, `Config.Env`, `Config.Cmd`, `Config.Entrypoint`, `Config.Labels` are returned from stored container config (not from ECS -- ECS task definition has the agent-modified entrypoint).
5. `Config.Env` merges the original image env (from stored image config) with user-specified env vars, matching Docker's behavior. The `PATH` env var must be present.
6. `Config.Healthcheck` is returned if the original image had a HEALTHCHECK instruction (from stored image config).
7. `State.Health.Status` is returned as `"starting"`, `"healthy"`, or `"unhealthy"` (from agent health reporting via the state store). Omitted entirely if no healthcheck is configured.
8. `NetworkSettings.IPAddress` is the task's ENI private IP.
9. `NetworkSettings.Networks` maps network names to endpoint configs with `IPAddress`, `NetworkID`, and `Aliases`.
10. Inspect by full ID, short ID prefix, or container name all work.

### ContainerList
11. `ContainerList` returns containers from the state store, filtered by the `Filters` map.
12. Supported filters: `id`, `name`, `label` (key, key=value), `status` (created, running, exited).
13. When `All` is false, only running containers are returned. When `All` is true, all containers are returned.
14. Each list entry includes: `Id`, `Names`, `Image`, `ImageID`, `Command`, `Created`, `State`, `Status` (human-readable like "Up 5 minutes"), `Labels`, `NetworkSettings`.

### ContainerStop
15. `ContainerStop` calls `StopTask` with the reason `"container stopped by sockerless"`.
16. If `timeout` is provided, the backend waits up to `timeout` seconds for graceful shutdown before the task is force-stopped. ECS has a native 30s SIGTERM window.
17. Container state is updated to `"exited"` after the task stops.

### ContainerKill
18. `ContainerKill` calls `StopTask` immediately. ECS does not support arbitrary signals -- SIGKILL maps to StopTask.
19. If the signal is not SIGKILL, the agent is sent a signal message via WebSocket (if reachable) before calling `StopTask`.

### ContainerRemove
20. `ContainerRemove` removes the container from the state store.
21. If `Force` is true and the container is running, stop it first (StopTask) then remove.
22. If `Force` is false and the container is running, return `409 Conflict`.
23. Optionally deregister the task definition revision to prevent accumulation.

### Example SDK Calls

```go
// DescribeTasks
ecs.DescribeTasks(&ecs.DescribeTasksInput{
    Cluster: &cluster,
    Tasks:   []string{taskArn},
})

// StopTask
ecs.StopTask(&ecs.StopTaskInput{
    Cluster: &cluster,
    Task:    &taskArn,
    Reason:  aws.String("container stopped by sockerless"),
})

// DeregisterTaskDefinition
ecs.DeregisterTaskDefinition(&ecs.DeregisterTaskDefinitionInput{
    TaskDefinition: &taskDefArn,
})
```

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] Unit tests with mock AWS clients for: inspect state mapping (each ECS status), inspect with merged env vars, list with filters (id, name, label, status), list with All flag, stop task, kill task, remove (running with force, running without force, already stopped)
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Container not found returns 404 with Docker-format message
- [ ] Remove running container without force returns 409
- [ ] AWS errors wrapped with context
- [ ] Zerolog structured logging with container ID and ECS task ARN

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants

### Integration
- [ ] Inspect response compatible with GitHub Actions Runner PATH extraction
- [ ] Inspect response compatible with GitLab Runner state polling
- [ ] State store correctly transitions through lifecycle states

---

## Suggested File Paths

```
backends/ecs/
├── container_inspect.go     # ContainerInspect: DescribeTasks -> Docker inspect format
├── container_list.go        # ContainerList: state store query with filter support
├── container_stop.go        # ContainerStop and ContainerKill: StopTask
├── container_remove.go      # ContainerRemove: state cleanup, task definition deregistration
└── store.go                 # (update) State transitions, filter query support
```

---

## Notes

- The inspect response must return the ORIGINAL container config (before agent injection), not the ECS-modified one. The original entrypoint, cmd, and env are stored in the state at create time. The ECS task definition contains the agent-wrapped entrypoint, but the Docker client should see the original.
- ECS `DescribeTasks` returns tasks for up to 100 task ARNs. For list operations with many containers, batch the calls.
- The `Status` human-readable string (e.g., "Up 5 minutes", "Exited (0) 2 minutes ago") is computed from state timestamps. Match Docker's format for CI runner log compatibility.
- ECS task definition deregistration: each container create registers a new task definition revision. These accumulate and should be cleaned up. Deregister on container remove.
- For the list operation, rely primarily on the state store rather than calling `ListTasks` on ECS. The state store has all the metadata needed for filtering. Only use `DescribeTasks` to refresh state if staleness is a concern.
