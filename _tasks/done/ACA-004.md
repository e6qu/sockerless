# ACA-004: ACA network and volume operations

**Component:** ACA (Azure Container Apps backend)
**Phase:** 3
**Depends on:** ACA-001
**Estimated effort:** L

---

## Description

Implement network and volume operations for the ACA backend. Networks are emulated via VNet integration and the managed environment's internal DNS for service discovery aliases. Volumes are backed by Azure Files shares mounted into Container Apps Jobs. This task covers the full CRUD lifecycle for both networks and volumes, including DNS alias registration, Azure Files share provisioning, and mount configuration for job definitions.

---

## Context

### ACA network emulation (Spec Section 11.2)

> | Cloud Backend | Network Emulation |
> |---|---|
> | Azure Container Apps | Environment-scoped networking; internal DNS for aliases |
>
> Each sockerless network maps to an isolated cloud networking construct. ACA provides environment-scoped internal DNS where container names and configured aliases resolve within the managed environment's VNet.

### Network lifecycle (Spec Section 11.4)

> | Docker Operation | Sockerless Action |
> |---|---|
> | `POST /networks/create` | Create cloud networking construct |
> | Container create with `NetworkMode`/`EndpointsConfig` | Assign virtual IP, register DNS aliases |
> | `POST /networks/{id}/disconnect` | Remove DNS alias, detach from network |
> | `DELETE /networks/{id}` | Tear down cloud networking construct |
> | `POST /networks/prune` | Clean up unused cloud networking constructs |

### DNS aliases for service discovery (Spec Section 13.3, Gap 10)

> **ACA:** Container Apps environment provides internal DNS. Container names and configured aliases resolve within the environment's VNet.
>
> Both CI runners rely on DNS resolution for service aliases. GitLab uses `EndpointsConfig.Aliases`; GitHub uses network-scoped container names. Docker provides this via its embedded DNS server on user-defined networks.

### IP address assignment (Spec Section 11.3)

> Sockerless assigns virtual IPs from a private subnet (e.g., `172.18.0.0/16`) to each container on a network. These IPs are returned in inspect responses. Actual cloud networking may use different IPs, but the sockerless-level IPs provide the correct inspect output for CI runners.
>
> For DNS-based service discovery (which is what CI runners actually rely on), the container aliases are registered in the cloud's DNS service so they resolve to the actual cloud IPs.

### ACA volume emulation (Spec Section 10.3)

> #### Azure Container Apps + Azure Files
> 1. Create an Azure Files share per sockerless instance
> 2. Mount the share in the container app job
> 3. Shared access via the same file share

### Volume strategy (Spec Section 10.2)

> | Volume Type | Cloud Emulation | Used For |
> |---|---|---|
> | Named volumes (Docker `VolumeCreate`) | Cloud shared filesystem (EFS, GCS, Azure Files) | Caches |
> | Bind mounts (from `HostConfig.Binds`) | Cloud shared filesystem mounted at specified path | Build data sharing |
> | `VolumesFrom` (inherit from another container) | Same shared filesystem mount applied to multiple tasks | Helper-Build sharing |
> | Anonymous volumes | Ephemeral task storage | Temp data |

### Volume sharing for CI (Spec Section 13.3, Gap 6)

> **ACA:** Azure Files share. Multiple container app jobs mount the same file share.
>
> Volume creation (`POST /volumes/create`) provisions a directory/access-point in the shared filesystem. Container creation records the volume mount mapping. Container start applies the mount to the cloud task definition.

---

## Acceptance Criteria

### Network Operations

1. `NetworkCreate` creates a network in the state store with a generated 64-char hex ID, name, labels, and driver. For ACA, the network is a logical construct backed by the managed environment's VNet -- no separate Azure resource is created per network.
2. `NetworkCreate` returns `{"Id": "<64-char-hex>", "Warning": ""}`.
3. `NetworkInspect` returns the network metadata including the `Containers` map showing all containers connected to this network with their virtual IPs, MAC addresses, and endpoint IDs.
4. `NetworkList` returns all networks from the state store, filtered by name, id, driver, scope, and label. Always includes a default `bridge` network.
5. `NetworkConnect` (via container create `EndpointsConfig`) assigns a virtual IP from the `172.18.0.0/16` range, stores the container-network membership, and registers DNS aliases.
6. DNS aliases from `EndpointsConfig.Aliases` and the container name are registered in the managed environment's internal DNS so that other containers within the same environment can resolve them.
7. `NetworkDisconnect` removes the container from the network's membership, deallocates the virtual IP, and removes DNS aliases.
8. `NetworkRemove` deletes the network from the state store. Returns error if containers are still connected (unless force is used).
9. `NetworkPrune` removes networks that have no connected containers and match the provided label filters. Returns the list of removed network IDs.
10. Container inspect (`NetworkSettings.Networks`) returns the correct virtual IP, gateway, MAC address, and aliases for each network the container belongs to.

### Volume Operations

11. `VolumeCreate` provisions an Azure Files share (or a directory within a pre-provisioned share) via the `armstorage` SDK. The volume is stored in the state with a name and the corresponding Azure Files share name/path.
12. `VolumeCreate` returns Docker-compatible response: `{"Name": "...", "Driver": "azure-files", "Mountpoint": "/mnt/azure/<name>", "Labels": {...}, ...}`.
13. `VolumeInspect` returns the volume metadata from the state store including name, driver, mountpoint, labels, and creation time.
14. `VolumeList` returns all volumes from the state store, filtered by name, driver, and label.
15. `VolumeRemove` deletes the Azure Files share (or directory) and removes the volume from the state store. Returns error if the volume is in use by a running container (unless force is used).
16. When a container is created with `HostConfig.Binds` or `Mounts` referencing a named volume, the volume's Azure Files share is included in the Container Apps Job template as a volume mount with the correct mount path.
17. `VolumesFrom` in container create copies the mount list from the referenced container's config, applying the same Azure Files share mounts to the new job.
18. Anonymous volumes (no name specified in bind mount) use the job's ephemeral storage. No Azure Files share is created.
19. Multiple Container Apps Jobs can mount the same Azure Files share simultaneously, enabling data sharing between helper and build containers (critical for CI runner volume-sharing pattern).

### Mount Configuration

20. Azure Files volume mounts are added to the job template's `volumes` array with `storageType: "AzureFile"` and the storage account name, share name, and access mode.
21. Container mounts reference the volume by name with the correct `mountPath` inside the container.

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] Unit tests with mock Azure clients for: network CRUD, virtual IP allocation and deallocation, DNS alias registration, volume CRUD, Azure Files share creation/deletion, volume mount configuration in job templates, VolumesFrom resolution, network prune with filters
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Azure Files API errors mapped to Docker-compatible error responses
- [ ] Volume-in-use returns `{"message": "volume is in use"}` with 409 status
- [ ] Network-in-use returns `{"message": "network has active endpoints"}` with 403 status
- [ ] Errors wrapped with context: `fmt.Errorf("aca: network create: %w", err)`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` updated with network and volume operation details

### Integration
- [ ] Network operations produce correct `NetworkSettings` in container inspect
- [ ] Volume mounts are correctly applied when ACA-002 creates/starts container jobs
- [ ] DNS aliases work for CI runner service discovery patterns

---

## Suggested File Paths

```
backends/aca/
├── network.go               # NetworkCreate, Inspect, List, Remove, Prune
├── network_dns.go           # DNS alias registration/deregistration in managed environment
├── network_ip.go            # Virtual IP allocation from 172.18.0.0/16 range
├── volume.go                # VolumeCreate, Inspect, List, Remove
├── volume_azure_files.go    # Azure Files share provisioning and deletion
├── volume_mount.go          # Mount configuration builder for job templates
└── store.go                 # (update) Network membership, volume -> Azure Files mapping
```

---

## Notes

- ACA managed environments provide built-in internal DNS. Containers within the same environment can resolve each other by name. However, custom DNS aliases (like `postgres` resolving to a specific container) may require additional configuration. If the environment's internal DNS does not support arbitrary aliases, fall back to injecting `/etc/hosts` entries via the agent at container start.
- Azure Files shares have naming restrictions: lowercase letters, numbers, and hyphens, 3-63 characters. Generate share names from the volume name, sanitizing as needed.
- Azure Files shares require a storage account. The storage account should be pre-provisioned and configured in the backend config. The backend creates/deletes shares within this account, not the account itself.
- For the `VolumesFrom` pattern (critical for GitLab Runner helper->build handoff), both containers must mount the same Azure Files share at the same path. The backend copies the volume mount configuration from the referenced container's stored config.
- Virtual IP allocation: maintain a simple counter or bitmap for the `172.18.0.0/16` subnet. These IPs are virtual (for inspect responses only) -- actual networking uses the VNet's IP space.
- The default `bridge` network should always exist in the state store. Containers not explicitly placed on a network are assigned to the default bridge.
- Network prune must respect label filters. Only remove networks matching ALL provided label filters that have zero connected containers.
- Azure Files performance: standard tier provides up to 60 MiB/s throughput per share. For CI workloads (git clone, build artifacts), this is generally adequate. Premium tier can be documented as an option for higher throughput needs.
- The storage account access key is used for mounting Azure Files shares in Container Apps Jobs. Alternatively, managed identity can be used if the Container Apps environment has the appropriate RBAC role on the storage account. Document both approaches.
