# TST-014: ACA Integration Tests

**Component:** Test Infrastructure and Suites
**Phase:** 3
**Depends on:** ACA-002, ACA-003, ACA-004
**Estimated effort:** L

---

## Description

Integration test suite that validates the complete container lifecycle on the Azure Container Apps (ACA) backend. Tests exercise container create, start, inspect, list, logs, stop, and remove operations against actual ACA Jobs, verifying that the Sockerless ACA backend correctly translates Docker API semantics to Azure Container Apps Jobs API operations. Tests also cover agent connectivity (exec/attach via the sockerless-agent running inside ACA), Azure Monitor log retrieval, and network/volume operations (VNet DNS aliases and Azure Files).

All tests in this suite require Azure credentials and a configured Azure subscription/resource group. Tests are automatically skipped when credentials are not available, so CI pipelines without Azure access continue to pass.

---

## Context

### ACA Backend Mapping (Spec Section 9.1)

| Docker Concept | ACA Mapping |
|---|---|
| Container create + start | `Create Job` + `Start Job Execution` |
| Container stop | `Stop Job Execution` |
| Container logs | Azure Monitor / Log Analytics |
| Exec / Attach | Via sockerless-agent (agent on container port, VNet accessible) |
| Image pull | ACA pulls from ACR / Docker Hub natively |
| Network | VNet integration (managed environment) |
| Volume | Azure Files, ephemeral storage |

**Startup latency:** 10-60 seconds.

### Capability Matrix (Spec Section 9.1)

| Capability | ACA |
|---|---|
| Long-running | Yes |
| Exec | Yes (via agent) |
| Attach | Yes (via agent) |
| Log stream | Yes |
| Log follow | Yes |
| Volumes | Yes (Azure Files) |
| Networks | Yes |
| Health checks | Yes |
| Agent needed | Yes |
| Startup latency | 10-60s |

### Azure Monitor Log Retrieval (Spec Section 9.1)

Container logs are retrieved from Azure Monitor / Log Analytics workspace. The backend queries by job execution resource ID and formats entries into Docker-compatible multiplexed log frames with stdout/stderr separation and optional timestamps.

### VNet DNS for Network Aliases (Spec Section 13.3, Gap 10)

Azure Container Apps environments provide internal DNS. Container names and configured aliases resolve within the environment's VNet. Tests verify that containers on the same network can resolve each other by name.

### Azure Files Volume Mounts (Spec Section 10.3)

Named volumes map to Azure Files shares. Multiple container app jobs mount the same file share for shared data access.

---

## Acceptance Criteria

### Prerequisites and Skip Logic

1. Tests detect Azure credentials via `AZURE_SUBSCRIPTION_ID` and `AZURE_TENANT_ID` env vars (or Azure CLI `az login` state); if absent, all tests in this suite are skipped with `t.Skip("Azure credentials not available")`
2. Tests detect the target resource group via `SOCKERLESS_AZURE_RESOURCE_GROUP` env var; if absent, tests are skipped
3. Tests detect the target ACA environment via `SOCKERLESS_AZURE_ACA_ENVIRONMENT` env var; if absent, tests are skipped
4. Tests detect the target Azure region via `SOCKERLESS_AZURE_REGION` env var (default: `eastus`)

### Container Lifecycle

5. `POST /containers/create` with a public image (e.g., `alpine:latest`) succeeds and returns a valid container ID
6. `POST /containers/{id}/start` blocks until the ACA job execution is in Running state and the agent is reachable, then returns `204`
7. `GET /containers/{id}/json` returns container state `"running"` with correct `Config` fields (Image, Env, Cmd, Entrypoint, Labels)
8. `GET /containers/{id}/json` returns `NetworkSettings` with an assigned IP address
9. `GET /containers/json?filters={"id":["<id-prefix>"]}` returns the container in the list
10. `POST /containers/{id}/stop` stops the ACA job execution; subsequent inspect shows state `"exited"`
11. `DELETE /containers/{id}` removes the container from state and cleans up the ACA job resource

### Agent Connectivity

12. After container start, `POST /containers/{id}/exec` with `Cmd: ["echo", "hello"]` creates an exec instance
13. `POST /exec/{id}/start` returns the command output (`hello\n`) via the agent WebSocket bridge
14. Exec exit code is correctly returned: `sh -c "exit 0"` returns 0, `sh -c "exit 1"` returns 1
15. `GET /exec/{id}/json` returns the correct `ExitCode` and `Running: false` after completion

### Log Retrieval

16. `GET /containers/{id}/logs?stdout=true&stderr=true` returns log output retrieved from Azure Monitor
17. `GET /containers/{id}/logs?stdout=true&stderr=true&timestamps=true` includes RFC3339Nano timestamps prefixed to each log line
18. `GET /containers/{id}/logs?tail=10` returns at most the last 10 log lines
19. Logs contain output from commands executed via exec (verifying that Azure Monitor captures agent-relayed output)

### Image Operations

20. `POST /images/create?fromImage=alpine&tag=latest` records the image reference without downloading layers; returns streaming JSON progress
21. `GET /images/alpine:latest/json` returns image metadata including `Config.Env` (fetched from registry manifest/config)

### Network Operations

22. `POST /networks/create` with a name and labels succeeds on the ACA backend
23. Containers created on the same network can resolve each other by container name (verified by exec-ing a DNS lookup or curl command within the ACA environment VNet)
24. `DELETE /networks/{id}` cleans up VNet DNS resources

### Volume Operations

25. `POST /volumes/create` with a name succeeds on the ACA backend
26. A container started with a volume mount can write data; a second container mounting the same volume can read the data (shared Azure Files)
27. `DELETE /volumes/{name}` cleans up the Azure Files share

### Error Handling

28. `POST /containers/{id}/start` for a non-existent container returns `404` with Docker-format error message
29. `GET /containers/{id}/json` for a non-existent container returns `404`
30. `POST /containers/create` with an invalid image reference returns an appropriate error

### Resource Cleanup

31. Every test cleans up all created ACA jobs, networks, and volumes via `defer` statements, even on test failure

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] New black-box REST tests written for new/changed behavior (in `tests/` module)
- [ ] Tests run against memory backend by default (ACA tests skipped without credentials)
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Custom error types used for all domain errors (not bare `errors.New`)
- [ ] Errors wrapped with context: `fmt.Errorf("operation: %w", err)`
- [ ] Zerolog structured logging on all error paths
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` created or updated (if this task creates or modifies a module)

### Integration
- [ ] No breaking changes to the internal API contract
- [ ] Capability model updated if new backend capabilities are added

### Task-Specific
- [ ] All 31 acceptance criteria pass (when Azure credentials are available)
- [ ] Tests are skipped cleanly without credentials (no failures, no errors)
- [ ] Test timeouts account for ACA startup latency (10-60s per container)
- [ ] Each test uses unique resource names to avoid collisions with parallel runs
- [ ] All Azure resources are cleaned up after each test, even on failure
- [ ] Tests pass with `go test -v -timeout 900s` (15-minute overall timeout)

---

## Suggested File Paths

```
tests/
├── aca_integration_test.go            # TestACAContainerLifecycle, TestACAExec,
│                                       # TestACALogs, TestACANetwork, TestACAVolume
├── aca_agent_test.go                  # TestACAAgentConnectivity, TestACAExecExitCodes
└── helpers/
    ├── aca.go                         # skipIfNoAzureCredentials, azureResourceGroup,
    │                                   # azureACAEnvironment, azureRegion helpers
    └── cloud_common.go                # waitForRunning (with extended timeout), cloudCleanup helpers
                                        # (shared with TST-013 Cloud Run tests)
```

---

## Notes

- **Credential detection:** Use the Azure SDK's `azidentity.NewDefaultAzureCredential()` to detect credentials. This checks environment variables (`AZURE_TENANT_ID`, `AZURE_CLIENT_ID`, `AZURE_CLIENT_SECRET`), managed identity, Azure CLI login, and other sources. If it returns an error, skip the entire test file with `t.Skip`.
- **Startup latency:** ACA jobs take 10-60 seconds to start — the longest of any backend. All tests that call `POST /containers/{id}/start` should use extended timeouts (at minimum 90s per container start). Use a helper like `waitForRunning(t, containerID, 90*time.Second)`.
- **Azure Monitor delay:** Azure Monitor / Log Analytics entries may take 5-30 seconds to become available after they are written. Log retrieval tests should include a retry loop (poll every 5s for up to 60s) before asserting on log content. This is significantly longer than Cloud Logging or CloudWatch.
- **Cost awareness:** Each test creates real ACA jobs and Azure Files resources that incur costs. Keep the test suite focused on essential scenarios. Use `testing.Short()` to skip expensive multi-container tests in quick CI runs.
- **Parallel execution:** Tests within this suite should NOT run in parallel (`t.Parallel()` is omitted) to avoid resource contention within the ACA environment and simplify cleanup. The overall suite takes approximately 5-10 minutes.
- **Image choice:** Use `alpine:latest` or `busybox:latest` for test containers. ACA pulls from Docker Hub natively, so these images are readily available without ACR configuration.
- **Cleanup resilience:** Use `defer` for all cleanup, and make cleanup helpers idempotent (ignore "not found" / "resource not found" errors on delete). This ensures resources are cleaned up even if the test panics.
- **Shared helpers with TST-013:** The `cloud_common.go` helpers (extended-timeout polling, idempotent cleanup) are shared between this suite and the Cloud Run integration tests. Ensure both suites use the same patterns for consistency.
- **ACA environment prerequisite:** Tests assume an ACA managed environment already exists (specified via env var). The test suite does NOT create or destroy the environment itself — this is a one-time setup step documented in the test README.
