# SIM-005: Simulator SDK/CLI compatibility tests

**Component:** Simulator
**Phase:** 2 (AWS), 3 (GCP, Azure)
**Depends on:** SIM-002, SIM-003, SIM-004
**Estimated effort:** L

---

## Description

Build comprehensive test suites that verify each simulator is compatible with the real cloud SDKs and CLI tools. Tests use the actual AWS SDK Go v2, Google Cloud Go SDK, and Azure SDK for Go to interact with the simulators, proving that the Sockerless backends will work correctly against them. Additionally, CLI compatibility tests shell out to `aws`, `gcloud`, and `az` CLI tools to verify they work against the simulators with endpoint overrides.

These tests are the primary quality gate for the simulators. If the SDKs and CLIs work against the simulators, the Sockerless backends (which use the same SDKs) will work too. The tests exercise the full request/response cycle: authentication, request serialization, response deserialization, error handling, pagination, and state machine transitions.

---

## Context

### Why SDK compatibility tests matter

The simulators exist to enable testing Sockerless backends without real cloud accounts. The backends use official cloud SDKs (AWS SDK Go v2, Google Cloud Go SDK, Azure SDK for Go). If the simulator responses differ from the real API in any way that the SDK cares about (field names, types, nesting, error format, pagination tokens), the SDK will fail to deserialize the response and the backend test will fail with a confusing error.

These tests catch format discrepancies early by using the same SDKs the backends use, against the simulators.

### SDK endpoint override patterns

**AWS SDK Go v2:**
```go
cfg, _ := config.LoadDefaultConfig(ctx,
    config.WithRegion("us-east-1"),
    config.WithCredentialsProvider(credentials.NewStaticCredentialsProvider("test", "test", "")),
)
ecsClient := ecs.NewFromConfig(cfg, func(o *ecs.Options) {
    o.BaseEndpoint = aws.String("http://localhost:4566")
})
```

**Google Cloud Go SDK:**
```go
client, _ := run.NewJobsClient(ctx,
    option.WithEndpoint("localhost:4567"),
    option.WithoutAuthentication(),
    option.WithGRPCDialOption(grpc.WithTransportCredentials(insecure.NewCredentials())),
)
// Or for REST-based clients:
client, _ := storage.NewClient(ctx,
    option.WithEndpoint("http://localhost:4567/storage/v1/"),
    option.WithoutAuthentication(),
)
```

**Azure SDK for Go:**
```go
cred := &FakeTokenCredential{} // implements azcore.TokenCredential
clientOpts := &arm.ClientOptions{
    ClientOptions: azcore.ClientOptions{
        Cloud: cloud.Configuration{
            Services: map[cloud.ServiceName]cloud.ServiceConfiguration{
                cloud.ResourceManager: {Endpoint: "http://localhost:4568"},
            },
        },
    },
}
client, _ := armappcontainers.NewJobsClient(subscriptionID, cred, clientOpts)
```

### Services tested per provider

**AWS** (from SIM-002): ECS (clusters, task definitions, tasks), ECR (repositories, images, auth), CloudWatch Logs (log groups, streams, events), EFS (filesystems, access points), Cloud Map (namespaces, services, instances), Lambda (functions, invocations), S3 (buckets, objects).

**GCP** (from SIM-003): Cloud Run Jobs (jobs, executions), Cloud Logging (entries), Cloud DNS (zones, records), GCS (buckets, objects), Artifact Registry (repositories, OCI), Cloud Functions (functions, invocations).

**Azure** (from SIM-004): Container Apps Jobs (jobs, executions), Log Analytics (queries), Azure Files (shares, files), ACR (OCI manifests, blobs), Private DNS (zones, records, VNet links), Azure Functions (apps, functions, invocations), Application Insights (queries).

---

## Acceptance Criteria

### Authentication tests
1. AWS SDK connects to the AWS simulator with static credentials (`AWS_ACCESS_KEY_ID=test`, `AWS_SECRET_ACCESS_KEY=test`) and makes a successful API call (e.g., `DescribeClusters`). No authentication errors are returned.
2. Google Cloud SDK connects to the GCP simulator with `option.WithoutAuthentication()` or a dummy token source and makes a successful API call (e.g., `ListJobs`). No authentication errors are returned.
3. Azure SDK connects to the Azure simulator with a fake `TokenCredential` implementation and makes a successful API call (e.g., list jobs). No authentication errors are returned.
4. AWS simulator accepts requests with no `Authorization` header (for simpler test setups) and returns valid responses.
5. GCP simulator accepts requests with no `Authorization` header and returns valid responses.
6. Azure simulator accepts requests with no `Authorization` header and returns valid responses.

### CRUD operations tests
7. AWS ECS: create cluster -> describe cluster (exists) -> register task definition -> describe task definition (exists) -> run task -> describe task (running) -> stop task -> describe task (stopped) -> deregister task definition -> delete cluster. All via AWS SDK Go v2.
8. AWS ECR: create repository -> describe repositories (exists) -> put image -> describe images (exists) -> batch get image (correct manifest) -> delete repository (force). All via AWS SDK Go v2.
9. AWS CloudWatch Logs: create log group -> create log stream -> put log events -> get log events (correct entries) -> filter log events (filter matches) -> delete log group. All via AWS SDK Go v2.
10. AWS EFS: create filesystem -> describe filesystems (exists) -> create access point -> describe access points (exists) -> delete access point -> delete filesystem. All via AWS SDK Go v2.
11. AWS Cloud Map: create namespace -> get namespace (exists) -> create service -> register instance -> discover instances (returns IP) -> deregister instance -> delete service -> delete namespace. All via AWS SDK Go v2.
12. AWS Lambda: create function -> get function (exists) -> invoke (returns response) -> update function code -> delete function. All via AWS SDK Go v2.
13. AWS S3: create bucket -> head bucket (exists) -> put object -> get object (correct body) -> list objects (object in list) -> delete object -> list objects (empty) -> delete bucket. All via AWS SDK Go v2.
14. GCP Cloud Run: create job -> get job (exists) -> run job (creates execution) -> get execution (running) -> wait for execution (succeeded) -> delete job. All via Google Cloud Go SDK.
15. GCP Cloud Logging: write entries -> list entries (filter matches) -> pagination works correctly. All via Google Cloud Go SDK.
16. GCP GCS: create bucket -> get bucket (exists) -> insert object -> get object (correct body) -> list objects (prefix filter works) -> delete object -> delete bucket. All via Google Cloud Go SDK.
17. Azure Container Apps: create job -> get job (exists) -> start execution -> get execution (running) -> wait for execution (succeeded) -> stop execution -> delete job. All via Azure SDK for Go.
18. Azure Log Analytics: write log entries (via simulator API) -> query entries (KQL filter matches) -> results in correct tabular format. All via Azure SDK for Go.
19. Azure ACR: initiate blob upload -> complete blob upload -> put manifest -> get manifest (correct content) -> list tags (tag present) -> get blob (correct content). Via `azcontainerregistry` SDK or HTTP client.

### State machine tests
20. AWS ECS task transitions PROVISIONING -> PENDING -> RUNNING are visible via `DescribeTasks` polling. Each poll returns the current state.
21. AWS ECS task stop transitions RUNNING -> DEPROVISIONING -> STOPPED are visible via `DescribeTasks` polling. Stop reason is included.
22. GCP Cloud Run execution transitions PENDING -> RUNNING -> SUCCEEDED are visible via `GetExecution` polling. Completion time is set when succeeded.
23. GCP Cloud Run execution cancellation transitions to CANCELLED state.
24. Azure Container Apps execution transitions Running -> Succeeded are visible via get execution polling.
25. Azure Container Apps execution stop transitions Running -> Failed.

### Error handling tests
26. AWS: `DescribeClusters` for a non-existent cluster returns `failures` array (not an HTTP error) with reason `MISSING`.
27. AWS: `DescribeTaskDefinition` for a non-existent task definition returns `ClientException` with HTTP 400.
28. AWS: `GetLogEvents` for a non-existent log stream returns `ResourceNotFoundException`.
29. GCP: `GetJob` for a non-existent job returns HTTP 404 with `{"error": {"code": 404, "status": "NOT_FOUND"}}`.
30. GCP: `DeleteJob` for a job with active executions returns HTTP 409 with `FAILED_PRECONDITION`.
31. Azure: Get for a non-existent job returns HTTP 404 with `{"error": {"code": "ResourceNotFound"}}`.
32. Azure: Missing `api-version` query parameter returns HTTP 400 with descriptive error.
33. Error responses from all three simulators are correctly deserialized by the respective SDKs into typed error objects that can be inspected programmatically.

### CLI compatibility tests
34. `aws ecs list-clusters --endpoint-url http://localhost:4566` returns an empty cluster list (JSON output, no errors).
35. `aws s3 ls --endpoint-url http://localhost:4566` returns an empty bucket list.
36. `gcloud run jobs list --project=test --region=us-central1` (with endpoint override) returns an empty job list.
37. `az containerapp job list --resource-group test-rg` (with endpoint override) returns an empty job list.

### Listing and filtering tests
38. AWS: `ListTasks` with `desiredStatus=RUNNING` returns only running tasks. `ListTasks` with `family` filter returns only matching tasks.
39. GCP: `ListJobs` with page size returns correct number of results and a valid `nextPageToken` for the next page.
40. Azure: List jobs returns all jobs. List executions for a specific job returns only that job's executions.

### Pagination tests
41. AWS CloudWatch `GetLogEvents` returns a `nextForwardToken` that can be used to fetch subsequent events. When no more events exist, the token is unchanged.
42. GCP Cloud Logging `entries.list` returns a `nextPageToken` that can be used to fetch the next page of entries.
43. Azure Log Analytics query with large result sets supports continuation.

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All tests pass with simulators running locally (started via `go run` or Docker Compose)
- [ ] Tests are self-contained: each test starts the simulator, runs operations, and verifies results
- [ ] Tests use `testing.T` with subtests (`t.Run`) organized by provider and service
- [ ] Table-driven tests for CRUD operations across resource types
- [ ] Tests include cleanup: resources created during tests are deleted after assertions
- [ ] Tests are deterministic (no flaky tests, fixed seeds for random data)
- [ ] State machine tests use configurable transition delays (set to 0 or minimal values for speed)

### Error Handling
- [ ] Tests verify that SDK error types are correctly populated (e.g., AWS `types.ClusterNotFoundException` is returned by the SDK, not a generic HTTP error)
- [ ] Tests verify HTTP status codes match expectations for each error scenario
- [ ] Errors in test setup/teardown produce clear failure messages

### Documentation
- [ ] GoDoc comments on all exported test helper types and functions
- [ ] README in test directory explaining how to run tests, prerequisites (CLI tools for CLI tests), and how to add new test cases

### Integration
- [ ] Tests can run against simulators started via Docker Compose (`docker compose up -d`)
- [ ] Tests can run against simulators started in-process (for faster CI)
- [ ] Simulator address is configurable via environment variable per test suite (e.g., `SIM_AWS_ENDPOINT`, `SIM_GCP_ENDPOINT`, `SIM_AZURE_ENDPOINT`)
- [ ] CLI tests are skipped if the CLI tool is not installed (with `t.Skip`)

---

## Suggested File Paths

```
simulators/tests/
├── go.mod                          # module github.com/sockerless/simulator-tests, go 1.23
├── go.sum
├── README.md
├── helpers.go                      # Shared test helpers: simulator startup, cleanup, assertions
├── aws_auth_test.go                # AWS authentication tests
├── aws_ecs_test.go                 # AWS ECS CRUD and state machine tests
├── aws_ecr_test.go                 # AWS ECR CRUD tests
├── aws_cloudwatch_test.go          # AWS CloudWatch Logs tests (CRUD, pagination, filtering)
├── aws_efs_test.go                 # AWS EFS CRUD tests
├── aws_cloudmap_test.go            # AWS Cloud Map CRUD tests
├── aws_lambda_test.go              # AWS Lambda CRUD and invocation tests
├── aws_s3_test.go                  # AWS S3 CRUD and listing tests
├── aws_cli_test.go                 # AWS CLI compatibility tests (shelling out to `aws`)
├── gcp_auth_test.go                # GCP authentication tests
├── gcp_cloudrun_test.go            # GCP Cloud Run CRUD and state machine tests
├── gcp_logging_test.go             # GCP Cloud Logging tests (write, list, filter)
├── gcp_dns_test.go                 # GCP Cloud DNS CRUD tests
├── gcp_storage_test.go             # GCP Cloud Storage CRUD and listing tests
├── gcp_ar_test.go                  # GCP Artifact Registry and OCI tests
├── gcp_functions_test.go           # GCP Cloud Functions CRUD and invocation tests
├── gcp_cli_test.go                 # gcloud CLI compatibility tests
├── azure_auth_test.go              # Azure authentication tests
├── azure_containerapps_test.go     # Azure Container Apps CRUD and state machine tests
├── azure_loganalytics_test.go      # Azure Log Analytics query tests
├── azure_storage_test.go           # Azure Files CRUD tests
├── azure_acr_test.go               # Azure ACR OCI Distribution API tests
├── azure_dns_test.go               # Azure Private DNS CRUD tests
├── azure_functions_test.go         # Azure Functions CRUD and invocation tests
├── azure_cli_test.go               # Azure CLI compatibility tests (shelling out to `az`)
└── fake_credentials.go             # Fake credential providers for each SDK
```

---

## Notes

- Tests should start simulators in-process when possible (using `httptest.NewServer` or similar) for speed and simplicity. Docker Compose-based tests are for integration/smoke testing.
- For AWS SDK Go v2, the `BaseEndpoint` option per service client is the cleanest way to point to the simulator. Avoid global endpoint resolvers as they are harder to configure per-service.
- For Google Cloud Go SDK, use `option.WithEndpoint()` and either `option.WithoutAuthentication()` or `option.WithTokenSource(oauth2.StaticTokenSource(&oauth2.Token{AccessToken: "test"}))`.
- For Azure SDK for Go, create a `FakeTokenCredential` struct that implements `azcore.TokenCredential` and returns a dummy token. Configure the client with a custom `cloud.Configuration` pointing to the simulator.
- CLI tests require the respective CLI tools (`aws`, `gcloud`, `az`) to be installed. Use `exec.LookPath` to check for availability and `t.Skip` if not found. This allows the test suite to run in environments without CLI tools (with reduced coverage).
- State machine tests should use a short transition delay (e.g., 50ms) to keep tests fast while still exercising the polling code path. A transition delay of 0 would make the resource immediately reach its final state, which does not test polling behavior.
- Consider using `t.Parallel()` for independent test cases within each provider to speed up the test suite.
- For error handling tests, use `errors.As` to verify that the SDK returns typed errors. For example, AWS SDK should return errors that can be checked with `var notFound *types.ClusterNotFoundException; errors.As(err, &notFound)`.
- The `fake_credentials.go` file should provide reusable credential providers for all three cloud SDKs, documented with usage examples.
- CLI tests should capture both stdout and stderr and verify the output format. Use `exec.Command` with `CombinedOutput` and parse the result.
- Consider adding a test that exercises the "full backend lifecycle" for each provider: create all necessary resources (cluster/environment, task definition/job, network, volume) -> run a container -> check status -> get logs -> stop -> cleanup. This mirrors what the Sockerless backends actually do.
