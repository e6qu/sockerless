# AG-005: Agent keep-alive mode

**Component:** Agent (Container agent)
**Phase:** 2
**Depends on:** AG-001
**Estimated effort:** S

---

## Description

Implement the `--keep-alive` flag for the sockerless agent. In keep-alive mode, the agent does NOT start a child process -- it is PID 1 (or the main process) and simply stays alive, serving exec and attach requests over WebSocket. This mode substitutes for the `tail -f /dev/null` entrypoint pattern used by GitHub Actions Runner for container jobs. The agent keeps the container running indefinitely until it is explicitly stopped by the backend (SIGTERM).

---

## Context

### `tail -f /dev/null` entrypoint handling (Spec Section 13.3, Gap 4)

> **Problem:** The runner overrides the entrypoint to `tail -f /dev/null`. On cloud backends, the sockerless agent needs to be PID 1 (or sidecar) to serve exec/attach.
>
> **Solution:** The frontend detects the `tail -f /dev/null` entrypoint pattern in `POST /containers/create` and flags it as a "keep-alive container". When the backend launches the cloud task, it injects the agent as the entrypoint: `["/sockerless-agent", "--keep-alive", "--"]`. The agent keeps the container alive (replaces `tail -f /dev/null`) and serves exec/attach requests. The `--keep-alive` flag tells the agent NOT to run a child process -- it just stays alive and waits for exec commands.

### GitHub Actions container job pattern (Spec Section 13.2.2)

> ```
> # Job container (long-lived):
> docker create --entrypoint "tail" --name <name> --network <net> \
>   -v "/var/run/docker.sock:/var/run/docker.sock" \
>   -v <workspace-mounts> -e <env-vars> --label <labels> \
>   <image> "-f" "/dev/null"
> ```
>
> The runner ALWAYS overrides the entrypoint for container jobs and service containers: `--entrypoint "tail" <image> "-f" "/dev/null"`. The original entrypoint is discarded.

### Agent entrypoint wrapping (Spec Section 8.6)

> For containers with real entrypoints (non-tail), the agent wraps the original command: `["/sockerless-agent", "--", <original-entrypoint>, <args>...]`.
>
> The agent starts the original command as a child process and serves WebSocket connections for exec/attach.

---

## Acceptance Criteria

1. The agent accepts a `--keep-alive` CLI flag.
2. When `--keep-alive` is set, the agent does NOT exec any child process. It starts only the HTTP/WebSocket server and waits indefinitely.
3. In keep-alive mode, the agent responds to `GET /health` with `{"status":"ok"}` immediately upon startup.
4. In keep-alive mode, exec requests (`{"type":"exec", ...}`) work normally -- the agent forks and execs commands as child processes (via AG-002).
5. In keep-alive mode, attach requests (`{"type":"attach", ...}`) receive an error response: `{"type":"error", "id":"<id>", "message":"no main process to attach to (keep-alive mode)"}`. Alternatively, attach may block until a process is started via exec (implementation choice, document which).
6. The agent process stays alive until it receives SIGTERM or SIGINT. On SIGTERM, it performs graceful shutdown: terminates active exec sessions, closes WebSocket connections, exits with code 0.
7. When NOT in keep-alive mode, the agent parses everything after `--` as the child command. Example: `sockerless-agent -- python app.py` runs `python app.py` as the main child process.
8. When NOT in keep-alive mode and no command is provided after `--`, the agent exits with an error: `"no command specified and --keep-alive not set"`.
9. The `--keep-alive` flag is also detectable from the `SOCKERLESS_KEEP_ALIVE=true` environment variable.
10. In keep-alive mode, the agent logs `"starting in keep-alive mode (no child process)"` at startup.

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing tests continue to pass
- [ ] Unit tests for: keep-alive mode starts without child process, keep-alive mode serves exec requests, keep-alive mode handles attach gracefully, non-keep-alive mode requires command after `--`, non-keep-alive mode starts child process, SIGTERM triggers graceful shutdown, env var SOCKERLESS_KEEP_ALIVE=true enables keep-alive
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Missing command without `--keep-alive` produces a clear error message and non-zero exit
- [ ] Errors wrapped with context
- [ ] Zerolog structured logging for mode selection

### Documentation
- [ ] GoDoc comments on all exported types and functions
- [ ] Module `README.md` updated with keep-alive mode documentation

### Integration
- [ ] Compatible with exec handler (AG-002) -- exec works in keep-alive mode
- [ ] Compatible with attach handler (AG-003) -- attach handled gracefully in keep-alive mode
- [ ] ECS backend (ECS-002, ECS-005) uses `--keep-alive` for tail-f-dev-null containers

---

## Suggested File Paths

```
agent/
├── config.go                # (update) Add --keep-alive flag and SOCKERLESS_KEEP_ALIVE env var
├── cmd/
│   └── sockerless-agent/
│       └── main.go          # (update) Branch on keep-alive mode vs child process mode
└── process.go               # (update) Skip child process start in keep-alive mode
```

---

## Notes

- The keep-alive mode is the simplest code path in the agent. The main function becomes: parse config -> start HTTP/WebSocket server -> block on signal. No child process management.
- The frontend/backend detects the `tail -f /dev/null` pattern by checking if `Entrypoint == ["tail"]` and `Cmd == ["-f", "/dev/null"]` (or variations). This detection happens in the backend when building the task definition, not in the agent itself.
- In keep-alive mode, the agent should still set up the session registry and message router so that exec sessions can be created immediately.
- The `--` separator is a common Unix convention. Use `os.Args` parsing to split flags before `--` (agent flags) and arguments after `--` (child command). Go's `flag` package does not handle `--` natively, so manual parsing or a library like `pflag` may be needed.
- The agent's PID 1 behavior: on Linux, if the agent is PID 1, it must handle zombie reaping. Orphaned child processes (from exec sessions) get reparented to PID 1. Use `signal.Notify(SIGCHLD)` and `syscall.Wait4(-1, ...)` to reap zombies. This applies to both keep-alive and normal modes.
- Consider adding a `--timeout` flag for keep-alive mode to auto-exit after a duration (useful for preventing runaway containers). Default should be no timeout (infinite keep-alive).
