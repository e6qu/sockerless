# TST-008: Volume endpoint tests

**Component:** Test Infrastructure and Suites
**Phase:** 1
**Depends on:** TST-001, FE-019
**Estimated effort:** S

---

## Description

Black-box tests for volume endpoints: create (`POST /volumes/create`), list (`GET /volumes`), inspect (`GET /volumes/{name}`), and remove (`DELETE /volumes/{name}`). Tests verify CRUD operations, label handling, and error cases. Volumes are the simplest resource type in Sockerless.

---

## Context

### Volume create (Spec Section 4.6)

`POST /volumes/create`

Request:
```json
{
  "Name": "runner-cache-sha256abc",
  "Driver": "local",
  "Labels": {"com.gitlab.gitlab-runner.managed": "true"}
}
```

Response: `201 Created`
```json
{
  "Name": "runner-cache-sha256abc",
  "Driver": "local",
  "Mountpoint": "/var/lib/docker/volumes/runner-cache-sha256abc/_data",
  "Labels": {"com.gitlab.gitlab-runner.managed": "true"},
  "Scope": "local",
  "CreatedAt": "2026-02-15T12:00:00Z"
}
```

### Volume list (Spec Section 4.6)

`GET /volumes`

Response:
```json
{
  "Volumes": [
    {
      "Name": "runner-cache-sha256abc",
      "Driver": "local",
      "Mountpoint": "/var/lib/docker/volumes/runner-cache-sha256abc/_data",
      "Labels": {"com.gitlab.gitlab-runner.managed": "true"},
      "Scope": "local",
      "CreatedAt": "2026-02-15T12:00:00Z"
    }
  ],
  "Warnings": []
}
```

### Volume inspect (Spec Section 4.6)

`GET /volumes/{name}` -- Returns volume metadata (same shape as create response).

### Volume remove (Spec Section 4.6)

`DELETE /volumes/{name}?force=false`

Response: `204 No Content`

### Volume emulation (Spec Section 10)

GitLab Runner creates volumes for:
- `/builds/<namespace>/<project>` -- shared between helper and build containers
- `/cache` -- persistent cache across jobs

---

## Acceptance Criteria

### Create

1. `POST /volumes/create` with `Name` and `Labels` returns `201` with the full volume object.
2. Response includes `Name` matching the request.
3. Response includes `Driver` defaulting to `"local"` if not specified.
4. Response includes `Mountpoint` in the format `/var/lib/docker/volumes/<name>/_data`.
5. Response includes `Labels` matching the request.
6. Response includes `Scope` as `"local"`.
7. Response includes `CreatedAt` as a valid RFC3339 timestamp.
8. Creating a volume with an empty `Name` auto-generates a random name.

### List

9. `GET /volumes` returns `{"Volumes": [...], "Warnings": []}`.
10. The `Volumes` array includes the volume created in the test.
11. The `Warnings` array is empty or null (not missing).

### Inspect

12. `GET /volumes/{name}` returns the same volume metadata as create.
13. `GET /volumes/{name}` includes `Labels` and all metadata fields.
14. `GET /volumes/nonexistent` returns `404` with `{"message": "no such volume: nonexistent"}`.

### Remove

15. `DELETE /volumes/{name}` removes the volume. Returns `204`.
16. After remove, `GET /volumes/{name}` returns `404`.
17. `DELETE /volumes/nonexistent` returns `404`.
18. `DELETE /volumes/{name}?force=true` removes the volume even if flagged as in-use (force removal).

### Example Requests

```bash
# Create volume
curl --unix-socket /var/run/sockerless.sock \
  -X POST http://localhost/volumes/create \
  -H "Content-Type: application/json" \
  -d '{"Name":"test-vol","Labels":{"env":"test"}}'
# Expected: 201
# {
#   "Name": "test-vol",
#   "Driver": "local",
#   "Mountpoint": "/var/lib/docker/volumes/test-vol/_data",
#   "Labels": {"env": "test"},
#   "Scope": "local",
#   "CreatedAt": "2026-02-15T12:00:00Z"
# }

# List volumes
curl --unix-socket /var/run/sockerless.sock \
  http://localhost/volumes | jq '.Volumes[].Name'
# Expected: includes "test-vol"

# Inspect volume
curl --unix-socket /var/run/sockerless.sock \
  http://localhost/volumes/test-vol | jq '{Name, Labels, Mountpoint}'
# Expected: {"Name":"test-vol","Labels":{"env":"test"},"Mountpoint":"/var/lib/docker/volumes/test-vol/_data"}

# Inspect non-existent volume
curl --unix-socket /var/run/sockerless.sock \
  http://localhost/volumes/nonexistent
# Expected: 404 {"message":"no such volume: nonexistent"}

# Remove volume
curl --unix-socket /var/run/sockerless.sock \
  -X DELETE http://localhost/volumes/test-vol
# Expected: 204

# Remove non-existent volume
curl --unix-socket /var/run/sockerless.sock \
  -X DELETE http://localhost/volumes/nonexistent
# Expected: 404 {"message":"no such volume: nonexistent"}

# Force remove
curl --unix-socket /var/run/sockerless.sock \
  -X DELETE "http://localhost/volumes/test-vol?force=true"
# Expected: 204
```

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] New black-box REST tests written for new/changed behavior (in `tests/` module)
- [ ] Tests run against memory backend by default
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Custom error types used for all domain errors (not bare `errors.New`)
- [ ] Errors wrapped with context: `fmt.Errorf("operation: %w", err)`
- [ ] Zerolog structured logging on all error paths
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` created or updated (if this task creates or modifies a module)

### Integration
- [ ] No breaking changes to the internal API contract
- [ ] Capability model updated if new backend capabilities are added

### Task-Specific
- [ ] All 18 acceptance criteria pass
- [ ] Each test creates its own volumes and cleans up via `defer removeVolume(t, name)`
- [ ] Tests pass against both memory and Docker backends
- [ ] Tests run in <1 second total

---

## Suggested File Paths

```
tests/
├── volume_test.go                 # TestVolumeCreate, TestVolumeList, TestVolumeInspect, TestVolumeRemove
└── helpers/
    └── volume.go                  # createVolume, inspectVolume, listVolumes, removeVolume helpers
```

---

## Notes

- Volume names are strings (not hex IDs like containers). Docker uses the name as the primary identifier for volumes.
- Docker's error message for missing volumes is lowercase: `"no such volume: <name>"` (unlike containers which use `"No such container: <id>"`). Match Docker's casing.
- Use unique volume names per test to avoid conflicts when tests run in parallel.
- The `Volumes` response wraps the array in an object: `{"Volumes": [...], "Warnings": []}`. Do not confuse this with the array-only format used by container list.
- For the memory backend, `Mountpoint` is a synthetic path. For the Docker backend, it is the actual path on the Docker host.
- Volume `CreatedAt` should be parseable as RFC3339. Verify with `time.Parse(time.RFC3339, value)`.
- Consider testing volume creation without a `Name` to verify auto-generation. The response should still have a non-empty `Name`.
- Docker volumes do not have a `force` flag on create (unlike containers). Creating a volume with an existing name is idempotent in Docker (returns the existing volume).
