# P32-001: Add WaitCh and RootPath to driver interfaces

**Phase:** 32A (Driver Interface Extension)
**Depends on:** â€”
**Estimated effort:** M

---

## Description

Add two new methods to driver interfaces so that `handleContainerStart` and `handleContainerRestart` no longer need to call `s.Store.Processes.Load()` to get the process object for waiting on exit and merging staging dirs.

## What to Change

### 1. Extend `ProcessLifecycleDriver` interface in `backends/core/drivers.go`

Add:
```go
// WaitCh returns a channel that receives the exit code when the container's
// process exits. Returns nil if no process is running (synthetic mode).
WaitCh(containerID string) <-chan int
```

### 2. Extend `FilesystemDriver` interface in `backends/core/drivers.go`

Add:
```go
// RootPath returns the host filesystem path of the container's root.
// Returns "" if the container has no real filesystem (synthetic mode).
RootPath(containerID string) string
```

### 3. Implement in all three driver tiers

**WASMProcessLifecycleDriver** (`drivers_process.go`):
```go
func (d *WASMProcessLifecycleDriver) WaitCh(containerID string) <-chan int {
    wp, ok := d.Store.Processes.Load(containerID)
    if !ok {
        return nil
    }
    proc := wp.(ContainerProcess)
    ch := make(chan int, 1)
    go func() {
        ch <- proc.Wait()
    }()
    return ch
}
```

**SyntheticProcessLifecycleDriver** (`drivers_synthetic.go`):
```go
func (d *SyntheticProcessLifecycleDriver) WaitCh(_ string) <-chan int {
    return nil
}
```

**WASMFilesystemDriver** (`drivers_process.go`):
```go
func (d *WASMFilesystemDriver) RootPath(containerID string) string {
    if wp, ok := d.Store.Processes.Load(containerID); ok {
        return wp.(ContainerProcess).RootPath()
    }
    return ""
}
```

**SyntheticFilesystemDriver** (`drivers_synthetic.go`):
```go
func (d *SyntheticFilesystemDriver) RootPath(_ string) string {
    return ""
}
```

**AgentFilesystemDriver** (`drivers_agent.go`):
```go
func (d *AgentFilesystemDriver) RootPath(containerID string) string {
    return d.Fallback.RootPath(containerID)
}
```

### 4. Update handler code in `handle_containers.go`

Replace the bypass in `handleContainerStart` (lines 300-311):
```go
// BEFORE:
if wp, ok := s.Store.Processes.Load(id); ok {
    proc := wp.(ContainerProcess)
    s.mergeStagingDir(id, proc.RootPath())
    go func() {
        exitCode := proc.Wait()
        s.Store.StopContainer(id, exitCode)
    }()
}

// AFTER:
rootPath := s.Drivers.Filesystem.RootPath(id)
if rootPath != "" {
    s.mergeStagingDir(id, rootPath)
}
if waitCh := s.Drivers.ProcessLifecycle.WaitCh(id); waitCh != nil {
    go func() {
        exitCode := <-waitCh
        s.Store.StopContainer(id, exitCode)
    }()
}
```

Same pattern in `handleContainerRestart` (lines 657-664).

## Acceptance Criteria

1. `ProcessLifecycleDriver` interface has `WaitCh(containerID string) <-chan int`
2. `FilesystemDriver` interface has `RootPath(containerID string) string`
3. All three tiers implement both methods
4. `handleContainerStart` and `handleContainerRestart` no longer call `s.Store.Processes.Load()`
5. All tests pass: `make test`, `make lint`

## After Completing

Update `_tasks/done/P32-001.md` with actual changes. Update `STATUS.md` progress line.
