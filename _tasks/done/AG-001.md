# AG-001: Agent WebSocket server scaffold

**Component:** Agent (Container agent)
**Phase:** 2
**Depends on:** ---
**Estimated effort:** M

---

## Description

Build the sockerless-agent binary -- a lightweight process that runs inside cloud containers and serves as the bridge between the frontend and the container's processes. The agent listens on a configurable HTTP port (default 9111), upgrades connections to WebSocket, validates bearer tokens, and routes incoming messages to the appropriate handler (exec, attach, health-check). This task creates the scaffold: binary entrypoint, WebSocket server, authentication middleware, message routing, and health endpoint. The actual exec, attach, and health-check handlers are implemented in AG-002 through AG-004.

---

## Context

### Agent as WebSocket server (Spec Section 8.1)

> The agent runs inside the cloud container and listens for WebSocket connections from the frontend. The frontend connects **on demand** -- only when a user triggers an exec, attach, or streaming logs operation.

```
Frontend                                        Agent (in cloud container)
    |                                                |
    |-- WebSocket CONNECT ----------------------------| ws://10.0.1.47:9111/
    |   Authorization: Bearer <token>                |
    |                                                |
    |-- {"type":"exec","cmd":["sh"],...} ------------>|
    |                                                | (agent fork+exec "sh")
    | <-- {"type":"stdout","data":"$ "} ------------- |
    | ---- {"type":"stdin","data":"ls\n"} ----------->|
    | <-- {"type":"exit","code":0} ------------------- |
    |                                                |
    |-- WebSocket CLOSE ----------------------------->|
```

### Authentication (Spec Section 8.2)

> The backend generates a one-time token when launching the cloud task. This token is:
> 1. Injected into the container as env var `SOCKERLESS_AGENT_TOKEN`
> 2. Returned to the frontend as part of the container's inspect data
>
> When the frontend connects to the agent, it presents the token in the `Authorization: Bearer <token>` header. The agent validates the token and rejects unauthorized connections.

### WebSocket message protocol (Spec Section 8.3)

**Frontend -> Agent:**

| Type | Fields | Purpose |
|------|--------|---------|
| `exec` | `id`, `cmd`, `env`, `workdir`, `tty` | Fork a new process |
| `attach` | `id` | Attach to the main process (PID 1's child) |
| `stdin` | `id`, `data` (base64) | Pipe bytes to process stdin |
| `signal` | `id`, `signal` | Send signal (SIGTERM, SIGKILL) to process |
| `close_stdin` | `id` | Close process stdin (EOF) |
| `resize` | `id`, `width`, `height` | Resize TTY (future) |

**Agent -> Frontend:**

| Type | Fields | Purpose |
|------|--------|---------|
| `stdout` | `id`, `data` (base64) | Process stdout bytes |
| `stderr` | `id`, `data` (base64) | Process stderr bytes |
| `exit` | `id`, `code` | Process exited with code |
| `error` | `id`, `message` | Error (process not found, etc.) |
| `health` | `status`, `log` | Health check result |

The `id` field identifies the exec/attach session (supports multiple concurrent sessions over the same WebSocket).

### Agent configuration (Spec Section 15.4)

> The agent is configured entirely via environment variables (injected by the backend):
>
> | Env Var | Description |
> |---------|-------------|
> | `SOCKERLESS_AGENT_PORT` | Port to listen on (default: `9111`) |
> | `SOCKERLESS_AGENT_TOKEN` | Auth token for validating frontend connections |
> | `SOCKERLESS_ORIGINAL_ENTRYPOINT` | Original container entrypoint (agent runs this as child) |
> | `SOCKERLESS_ORIGINAL_CMD` | Original container CMD |

---

## Acceptance Criteria

1. `sockerless-agent` binary compiles and runs from `cmd/sockerless-agent/main.go`.
2. Agent listens on `SOCKERLESS_AGENT_PORT` (default `9111`) and accepts HTTP connections.
3. `GET /health` returns `200 OK` with `{"status":"ok"}` -- used by backends to confirm agent readiness before returning from `ContainerStart`.
4. WebSocket upgrade on `GET /` (or `GET /ws`) succeeds when a valid `Authorization: Bearer <token>` header is provided, where `<token>` matches `SOCKERLESS_AGENT_TOKEN`.
5. WebSocket upgrade returns `401 Unauthorized` when the token is missing, empty, or does not match `SOCKERLESS_AGENT_TOKEN`.
6. Incoming WebSocket messages are parsed as JSON. Each message must have a `type` field. Unrecognized types receive an `error` response: `{"type":"error","message":"unknown message type: <type>"}`.
7. Messages with `type: "exec"` are routed to the exec handler (stubbed in this task, implemented in AG-002).
8. Messages with `type: "attach"` are routed to the attach handler (stubbed in this task, implemented in AG-003).
9. Messages with `type: "stdin"`, `"signal"`, `"close_stdin"`, `"resize"` are routed to the appropriate session identified by the `id` field. If no session with that `id` exists, return `{"type":"error","id":"<id>","message":"no such session"}`.
10. The agent handles multiple concurrent WebSocket connections (one per frontend request).
11. The agent handles multiple concurrent sessions (exec/attach) across connections using the `id` field for multiplexing.
12. Configuration reads from env vars: `SOCKERLESS_AGENT_PORT`, `SOCKERLESS_AGENT_TOKEN`, `SOCKERLESS_ORIGINAL_ENTRYPOINT`, `SOCKERLESS_ORIGINAL_CMD`. Also accepts `--keep-alive` and `--` CLI flags (see AG-005).
13. Graceful shutdown on SIGTERM/SIGINT: close all WebSocket connections, terminate child processes, clean exit.
14. All operations are logged via zerolog with session IDs and message types.

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] Unit tests for: WebSocket upgrade, token validation (accept valid, reject invalid/missing), message routing (known types dispatched, unknown types return error), health endpoint
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Errors wrapped with context: `fmt.Errorf("agent: %w", err)`
- [ ] Zerolog structured logging on all error paths
- [ ] Invalid messages return JSON error responses over WebSocket

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` created with agent overview, configuration, and message protocol

### Integration
- [ ] Health endpoint usable by backend readiness checks
- [ ] Message routing extensible for AG-002 (exec), AG-003 (attach), AG-004 (health check)

---

## Suggested File Paths

```
agent/
├── go.mod                          # module github.com/sockerless/agent, go 1.23
├── go.sum
├── README.md
├── server.go                       # HTTP server, WebSocket upgrade, health endpoint
├── auth.go                         # Token validation middleware
├── router.go                       # Message type routing, session registry
├── message.go                      # Message type definitions (JSON structs)
├── session.go                      # Session interface and registry (exec/attach sessions)
├── config.go                       # Env var and CLI flag parsing
└── cmd/
    └── sockerless-agent/
        └── main.go                 # Binary entrypoint
```

---

## Notes

- Use `github.com/gorilla/websocket` for the WebSocket implementation. It is the de facto Go WebSocket library and supports concurrent read/write with proper locking.
- The session registry should be a `sync.Map` or a mutex-protected map of `id -> Session` where `Session` is an interface with methods like `HandleStdin(data []byte)`, `HandleSignal(sig string)`, `Close()`.
- The agent must be compiled as a **static binary** (CGO_ENABLED=0) so it can be injected into any Linux container regardless of the base image's libc.
- The binary should be small. Avoid unnecessary dependencies. The agent runs inside user containers and should not bloat the image.
- The `--` CLI argument separates agent flags from the child process command. Everything after `--` is the original entrypoint+cmd to exec. Example: `sockerless-agent -- /usr/bin/python app.py`.
- Token validation should use `crypto/subtle.ConstantTimeCompare` to prevent timing attacks.
- Consider a ping/pong mechanism on the WebSocket to detect dead connections (gorilla/websocket supports this natively with `SetPingHandler`/`SetPongHandler`).
