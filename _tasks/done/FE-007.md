# FE-007: GET /containers/json (List)

**Component:** Docker REST API Frontend
**Phase:** 1
**Depends on:** FE-004
**Estimated effort:** M

---

## Description

Implement the `GET /containers/json` endpoint (container list). This endpoint returns an array of container summary objects, supporting the `all` flag to include stopped containers and a `filters` parameter for filtering by label, id, name, and status. Both GitLab Runner and GitHub Actions Runner use this endpoint with specific filter patterns to find their managed containers.

## Context

### Container List (spec Section 4.3)

Query parameters:
- `all` (bool): Include stopped containers (default: only running)
- `filters` (JSON): Label, status, id, name filters

**Filter formats used by CI runners:**
```
# GitLab Runner - find containers by label
filters={"label":["com.gitlab.gitlab-runner.managed=true"]}

# GitHub Actions Runner - find by label
filters={"label":["<instance-label>"]}

# GitHub Actions Runner - find by id + status
filters={"id":["<container-id>"],"status":["running"]}
```

**Response:** Array of container summary objects:
```json
[
  {
    "Id": "<64-char-hex>",
    "Names": ["/container-name"],
    "Image": "nginx:latest",
    "ImageID": "sha256:...",
    "Command": "nginx -g 'daemon off;'",
    "Created": 1708000000,
    "State": "running",
    "Status": "Up 5 minutes",
    "Ports": [{"PrivatePort": 80, "PublicPort": 8080, "Type": "tcp"}],
    "Labels": {"com.gitlab.gitlab-runner.managed": "true"},
    "NetworkSettings": {
      "Networks": {
        "bridge": {"IPAddress": "10.0.0.5"}
      }
    }
  }
]
```

Sockerless must support filtering by: `label`, `id`, `name`, `status`.

### Internal API (spec Section 7.3)

Frontend sends: `GET /internal/v1/containers` with query parameters for filters.

## Acceptance Criteria

1. `GET /containers/json` returns `200 OK` with a JSON array of container summaries
2. By default (no `all` param), only running containers are returned
3. With `all=true` (or `all=1`), all containers (created, running, exited) are returned
4. Filter by label: `filters={"label":["key=value"]}` returns only containers with that label
5. Filter by label (key only): `filters={"label":["key"]}` returns containers with that label key regardless of value
6. Filter by id: `filters={"id":["<id-prefix>"]}` returns containers whose ID starts with the given prefix
7. Filter by name: `filters={"name":["<name>"]}` returns containers whose name matches
8. Filter by status: `filters={"status":["running"]}` returns only containers in that state
9. Multiple filters are ANDed: `filters={"id":["abc"],"status":["running"]}` requires both match
10. Multiple values within a filter are ORed: `filters={"status":["running","exited"]}` matches either
11. Empty result set returns `[]` (empty array), not `null`
12. `Names` field includes the leading `/` prefix (e.g., `["/mycontainer"]`)
13. `Created` field is a Unix timestamp (integer seconds), not an RFC3339 string
14. `Command` field is a string representation of the command (e.g., `"sh -c 'echo hello'"`)
15. `Status` field is a human-readable string (e.g., `"Up 5 minutes"`, `"Exited (0) 2 minutes ago"`)

### Example Requests

```bash
# List running containers (default)
curl -s --unix-socket /var/run/sockerless.sock \
  "http://localhost/v1.44/containers/json" | jq '.[].Names'
# ["/mycontainer"]

# List all containers (including stopped)
curl -s --unix-socket /var/run/sockerless.sock \
  "http://localhost/v1.44/containers/json?all=true" | jq '.[].State'
# "running"
# "exited"
# "created"

# Filter by label (GitLab Runner pattern)
curl -s --unix-socket /var/run/sockerless.sock \
  "http://localhost/v1.44/containers/json?all=true&filters=%7B%22label%22%3A%5B%22com.gitlab.gitlab-runner.managed%3Dtrue%22%5D%7D" | jq length
# 3

# Filter by id and status (GitHub Actions Runner pattern)
curl -s --unix-socket /var/run/sockerless.sock \
  "http://localhost/v1.44/containers/json?filters=%7B%22id%22%3A%5B%22a1b2c3%22%5D%2C%22status%22%3A%5B%22running%22%5D%7D" | jq '.[].Id'
# "a1b2c3d4e5f6..."

# Filter by name
curl -s --unix-socket /var/run/sockerless.sock \
  "http://localhost/v1.44/containers/json?all=true&filters=%7B%22name%22%3A%5B%22mycontainer%22%5D%7D" | jq '.[].Names'
# ["/mycontainer"]

# No matching containers
curl -s --unix-socket /var/run/sockerless.sock \
  "http://localhost/v1.44/containers/json?filters=%7B%22label%22%3A%5B%22nonexistent%22%5D%7D"
# []
```

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] New black-box REST tests written for new/changed behavior (in `tests/` module)
- [ ] Tests run against memory backend by default
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Custom error types used for all domain errors (not bare `errors.New`)
- [ ] Errors wrapped with context: `fmt.Errorf("operation: %w", err)`
- [ ] Zerolog structured logging on all error paths
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` created or updated (if this task creates or modifies a module)

### Integration
- [ ] No breaking changes to the internal API contract (unless the task explicitly requires it)
- [ ] Capability model updated if new backend capabilities are added

### Task-Specific
- [ ] Filter parsing handles URL-encoded JSON correctly
- [ ] AND/OR filter logic tested with multi-value filters
- [ ] `all` flag correctly controls visibility of stopped containers
- [ ] Empty array returned (not null) when no containers match

## Suggested File Paths

```
frontends/docker/
├── handler_container_list.go   # GET /containers/json handler
└── filters.go                  # Docker filter parsing (shared utility)
```

## Notes

- The `filters` query parameter is URL-encoded JSON. It must be parsed with `url.QueryUnescape` first, then `json.Unmarshal`. The structure is `map[string][]string`.
- Docker's filter semantics: multiple values within one filter key are ORed (e.g., `status=["running","exited"]` matches either). Multiple filter keys are ANDed (e.g., `id=["abc"]` AND `status=["running"]` requires both).
- The `label` filter supports two forms: `"key=value"` (exact match) and `"key"` (key existence, any value). Both must be supported.
- The `name` filter in Docker does substring matching, not exact matching. `name=["test"]` matches containers named `"test"`, `"test1"`, `"my-test"`, etc.
- The `id` filter does prefix matching, not exact matching. `id=["a1b2"]` matches any container whose ID starts with `a1b2`.
- The `Status` string field is human-readable and varies by state:
  - Created: `"Created"`
  - Running: `"Up X minutes"` or `"Up X hours"`
  - Exited: `"Exited (0) X minutes ago"` or `"Exited (1) X hours ago"`
- The `Command` field truncates long commands (Docker truncates to ~44 chars with `...`). Match this behavior for compatibility.
- The `Created` field is Unix timestamp in seconds (integer), unlike the inspect endpoint which uses RFC3339.
