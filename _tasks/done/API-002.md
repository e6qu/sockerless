# API-002: Backend interface and capability model

**Component:** API (Shared internal API types)
**Phase:** 1
**Depends on:** API-001
**Estimated effort:** M

---

## Description

Define the Go interface that every backend must implement and the capability model that backends use to declare which features they support. These types live in the `api/` module alongside the data models from API-001.

The backend interface is the contract between the frontend and any backend. Each method corresponds to one internal API endpoint. The capability model lets the frontend discover at startup what the connected backend supports, so it can return `501 Not Implemented` for unsupported Docker API operations instead of forwarding requests that will fail.

---

## Context

### Architecture (Spec Section 6.2, 6.4)

> Each backend is a **stateful** daemon that:
> 1. Listens on a Unix socket (or TCP) for internal API calls from the frontend
> 2. Owns all persistent state (containers, networks, volumes, images) in a local database
> 3. Translates internal API calls into cloud provider operations using the provider's native SDK and types
> 4. Reports its capabilities so the frontend can return `501 Not Implemented` for unsupported operations

The `api/` module has zero external dependencies. Backends import `api/` for the interface and types, then implement the interface using their cloud SDK.

### Internal API endpoints (Spec Section 7.3)

These are the operations the backend must handle:

**System:**
| Method | Path | Operation |
|--------|------|-----------|
| `GET` | `/internal/v1/capabilities` | GetCapabilities |
| `GET` | `/internal/v1/info` | SystemInfo |
| `GET` | `/internal/v1/version` | SystemVersion |

**Containers:**
| Method | Path | Operation |
|--------|------|-----------|
| `POST` | `/internal/v1/containers` | ContainerCreate |
| `GET` | `/internal/v1/containers` | ContainerList |
| `GET` | `/internal/v1/containers/{id}` | ContainerInspect |
| `POST` | `/internal/v1/containers/{id}/start` | ContainerStart |
| `POST` | `/internal/v1/containers/{id}/stop` | ContainerStop |
| `POST` | `/internal/v1/containers/{id}/kill` | ContainerKill |
| `DELETE` | `/internal/v1/containers/{id}` | ContainerRemove |
| `GET` | `/internal/v1/containers/{id}/logs` | ContainerLogs |
| `WS` | `/internal/v1/containers/{id}/wait` | ContainerWait |
| `POST` | `/internal/v1/containers/{id}/attach` | ContainerAttach |

**Exec:**
| Method | Path | Operation |
|--------|------|-----------|
| `POST` | `/internal/v1/containers/{id}/exec` | ExecCreate |
| `GET` | `/internal/v1/exec/{id}` | ExecInspect |

Note: `POST /exec/{id}/start` is handled by the frontend directly (it connects to the agent). The backend only stores exec metadata. However, the interface should include `ExecStart` for backends like Docker that handle exec natively.

**Images:**
| Method | Path | Operation |
|--------|------|-----------|
| `POST` | `/internal/v1/images/pull` | ImagePull |
| `GET` | `/internal/v1/images/{name}` | ImageInspect |
| `POST` | `/internal/v1/images/load` | ImageLoad |
| `POST` | `/internal/v1/images/{name}/tag` | ImageTag |
| `POST` | `/internal/v1/auth` | AuthCheck |

**Networks:**
| Method | Path | Operation |
|--------|------|-----------|
| `POST` | `/internal/v1/networks` | NetworkCreate |
| `GET` | `/internal/v1/networks` | NetworkList |
| `GET` | `/internal/v1/networks/{id}` | NetworkInspect |
| `POST` | `/internal/v1/networks/{id}/disconnect` | NetworkDisconnect |
| `DELETE` | `/internal/v1/networks/{id}` | NetworkRemove |
| `POST` | `/internal/v1/networks/prune` | NetworkPrune |

**Volumes:**
| Method | Path | Operation |
|--------|------|-----------|
| `POST` | `/internal/v1/volumes` | VolumeCreate |
| `GET` | `/internal/v1/volumes` | VolumeList |
| `GET` | `/internal/v1/volumes/{name}` | VolumeInspect |
| `DELETE` | `/internal/v1/volumes/{name}` | VolumeRemove |

### Capability reporting (Spec Section 7.4)

> `GET /internal/v1/capabilities` returns the backend's supported features:
>
> ```json
> {
>   "backend": "ecs",
>   "version": "0.1.0",
>   "capabilities": {
>     "exec": true,
>     "attach": true,
>     "logs": true,
>     "logs_follow": true,
>     "volumes": true,
>     "networks": true,
>     "health_checks": true,
>     "image_pull": true,
>     "image_load": false,
>     "max_timeout_seconds": 0,
>     "agent_required": true
>   }
> }
> ```
>
> The frontend calls this once at startup (and caches it). When a Docker API request maps to an unsupported capability, the frontend returns `501 Not Implemented` with `{"message":"This backend (lambda) does not support exec"}`.

### Backend comparison matrix (Spec Section 9.5)

| Capability | Docker | Memory | ECS | Cloud Run | ACA | Lambda | CR Func | Az Func |
|---|:---:|:---:|:---:|:---:|:---:|:---:|:---:|:---:|
| Long-running | Yes | Sim | Yes | Yes (24h) | Yes | No (15m) | No (60m) | No (10m) |
| Exec | Yes | Sim | Yes* | Yes* | Yes* | **No** | **No** | **No** |
| Attach | Yes | Sim | Yes* | Yes* | Yes* | **No** | **No** | **No** |
| Log stream | Yes | Sim | Yes | Yes | Yes | Yes | Yes | Yes |
| Log follow | Yes | Sim | Yes | Yes | Yes | No | No | No |
| Volumes | Yes | Sim | Yes | Partial | Yes | No | No | No |
| Networks | Yes | Sim | Yes | Yes | Yes | No | No | No |
| Health checks | Yes | Sim | Yes | Yes | Yes | No | No | No |
| Agent needed | No | No | Yes | Yes | Yes | No | No | No |

\* Via sockerless-agent

### System ping response (Spec Section 4.1)

The `SystemPing` operation returns a simple OK; it is handled by the frontend without calling the backend, but the backend interface should include it for completeness.

---

## Acceptance Criteria

1. A `Backend` interface is defined with all of the following methods:
   - `ContainerCreate(ctx context.Context, req ContainerCreateRequest) (ContainerCreateResponse, error)`
   - `ContainerStart(ctx context.Context, id string) error`
   - `ContainerInspect(ctx context.Context, id string) (Container, error)`
   - `ContainerList(ctx context.Context, opts ContainerListOptions) ([]ContainerListEntry, error)`
   - `ContainerLogs(ctx context.Context, id string, opts ContainerLogOptions) (io.ReadCloser, error)`
   - `ContainerStop(ctx context.Context, id string, timeout *int) error`
   - `ContainerKill(ctx context.Context, id string, signal string) error`
   - `ContainerRemove(ctx context.Context, id string, opts ContainerRemoveOptions) error`
   - `ContainerWait(ctx context.Context, id string, condition string) (WaitResponse, error)`
   - `ContainerAttach(ctx context.Context, id string, opts ContainerAttachOptions) (io.ReadWriteCloser, error)`
   - `ExecCreate(ctx context.Context, containerID string, req ExecCreateRequest) (ExecCreateResponse, error)`
   - `ExecStart(ctx context.Context, id string, opts ExecStartOptions) (io.ReadWriteCloser, error)`
   - `ExecInspect(ctx context.Context, id string) (ExecInstance, error)`
   - `ImagePull(ctx context.Context, ref string, opts ImagePullOptions) (io.ReadCloser, error)`
   - `ImageInspect(ctx context.Context, name string) (Image, error)`
   - `ImageLoad(ctx context.Context, input io.Reader) error`
   - `ImageTag(ctx context.Context, source string, repo string, tag string) error`
   - `AuthCheck(ctx context.Context, creds AuthConfig) (AuthResponse, error)`
   - `NetworkCreate(ctx context.Context, req NetworkCreateRequest) (NetworkCreateResponse, error)`
   - `NetworkList(ctx context.Context, opts NetworkListOptions) ([]Network, error)`
   - `NetworkInspect(ctx context.Context, id string) (Network, error)`
   - `NetworkDisconnect(ctx context.Context, networkID string, containerID string, force bool) error`
   - `NetworkRemove(ctx context.Context, id string) error`
   - `NetworkPrune(ctx context.Context, filters map[string][]string) (NetworkPruneResponse, error)`
   - `VolumeCreate(ctx context.Context, req VolumeCreateRequest) (Volume, error)`
   - `VolumeList(ctx context.Context, opts VolumeListOptions) (VolumeListResponse, error)`
   - `VolumeInspect(ctx context.Context, name string) (Volume, error)`
   - `VolumeRemove(ctx context.Context, name string, force bool) error`
   - `SystemInfo(ctx context.Context) (SystemInfoResponse, error)`
   - `SystemVersion(ctx context.Context) (SystemVersionResponse, error)`
   - `SystemPing(ctx context.Context) error`
2. A `Capabilities` struct is defined with bool/int fields matching the JSON shape: `Exec`, `Attach`, `Logs`, `LogsFollow`, `Volumes`, `Networks`, `HealthChecks`, `ImagePull`, `ImageLoad`, `MaxTimeoutSeconds` (int), `AgentRequired` (bool). All fields have `json` tags.
3. A `BackendInfo` struct is defined with: `Backend` (string), `Version` (string), `Capabilities` (Capabilities). JSON tags match the capability reporting format.
4. The `Backend` interface includes a `GetCapabilities() BackendInfo` method (no context needed, returns static data).
5. All option/request/response types referenced in the interface methods are defined (e.g., `ContainerListOptions`, `ContainerLogOptions`, `ContainerRemoveOptions`, `ContainerAttachOptions`, `ExecCreateRequest`, `ExecCreateResponse`, `ExecStartOptions`, `ImagePullOptions`, `AuthConfig`, `AuthResponse`, `NetworkCreateRequest`, `NetworkCreateResponse`, `NetworkListOptions`, `NetworkPruneResponse`, `VolumeCreateRequest`, `VolumeListOptions`, `VolumeListResponse`, `WaitResponse`, `ContainerCreateResponse`, `SystemInfoResponse`, `SystemVersionResponse`).
6. `ContainerListOptions` includes `All bool` and `Filters map[string][]string`.
7. `ContainerLogOptions` includes `Stdout`, `Stderr`, `Follow`, `Timestamps` (bool), `Tail` (string), `Details` (bool).
8. `ContainerRemoveOptions` includes `RemoveVolumes bool` and `Force bool`.
9. All exported types and fields have GoDoc comments.
10. The module compiles with `go build ./...` and has zero external dependencies beyond stdlib (`context`, `io`).

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] No new lint warnings introduced

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` updated with interface overview

### Integration
- [ ] No breaking changes to the internal API contract
- [ ] All types from API-001 are referenced correctly
- [ ] Zero external dependencies in `go.mod`

---

## Suggested File Paths

```
api/
├── backend.go        # Backend interface definition with all method signatures
├── capabilities.go   # Capabilities struct, BackendInfo struct
├── options.go        # ContainerListOptions, ContainerLogOptions, ContainerRemoveOptions,
│                     # ContainerAttachOptions, ExecStartOptions, ImagePullOptions,
│                     # NetworkListOptions, VolumeListOptions, and other option types
└── responses.go      # ContainerCreateResponse, ExecCreateResponse, NetworkCreateResponse,
                      # NetworkPruneResponse, WaitResponse, AuthConfig, AuthResponse,
                      # SystemInfoResponse, SystemVersionResponse
```

---

## Notes

- The `Backend` interface should use `context.Context` as the first parameter on every method to support cancellation and timeouts. This is idiomatic Go for service interfaces.
- Methods that return streaming data (`ContainerLogs`, `ContainerAttach`, `ExecStart`, `ImagePull`) return `io.ReadCloser` or `io.ReadWriteCloser`. The caller is responsible for closing the stream.
- `ContainerWait` blocks until the container exits. Implementations should respect context cancellation.
- `ContainerAttach` returns a bidirectional stream. For backends that use the agent (ECS, Cloud Run, ACA), this may return `NotImplementedError` because the frontend handles attach via WebSocket directly. For the Docker backend, this returns the Docker attach stream.
- The interface is intentionally large (31 methods). A backend that does not support an operation should return `NotImplementedError` from the `api/errors.go` types (defined in API-003). The frontend checks capabilities before calling, but the error serves as a safety net.
- Consider defining a `ContainerCreateResponse` struct with `Id string` and `Warnings []string` to match Docker's create response shape.
- `WaitResponse` should have `StatusCode int64` and `Error *WaitError` where `WaitError` has a `Message string`.
- `SystemInfoResponse` and `SystemVersionResponse` should contain the fields listed in Spec Section 4.1 (OSType, Architecture, NCPU, MemTotal, ServerVersion, etc.).
- The `Filters` field in list options uses `map[string][]string` which matches Docker's filter encoding: `{"label": ["key=value"], "status": ["running"]}`.
