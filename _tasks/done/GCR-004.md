# GCR-004: Cloud Run network and volume operations

**Component:** GCR (Google Cloud Run backend)
**Phase:** 3
**Depends on:** GCR-001
**Estimated effort:** L

---

## Description

Implement network and volume operations for the Cloud Run backend. Networks map to VPC networking with Cloud DNS private zones for service discovery aliases. Volumes map to GCS buckets mounted via Cloud Storage FUSE. CI runners rely on networks for inter-container DNS resolution (e.g., service container `postgres` reachable by name) and volumes for data sharing between helper and build containers.

---

## Context

### Network emulation (Spec Section 11.2)

> | Cloud Backend | Network Emulation |
> |---|---|
> | Google Cloud Run | VPC network with tags; Cloud DNS private zone for aliases |

> Each sockerless network maps to an isolated cloud networking construct.
>
> For DNS-based service discovery (which is what CI runners actually rely on), the container aliases (e.g., `postgres`, `redis`) are registered in the cloud's DNS service so they resolve to the actual cloud IPs.

### Network DNS resolution (Spec Section 13.3, Gap 10)

> **Cloud Run:** Cloud DNS private zone. Create A records for each container's aliases pointing to the container's internal IP.

### Volume emulation (Spec Section 10.3)

> #### Google Cloud Run + GCS
> 1. Create a GCS bucket (or use a pre-provisioned one) per sockerless instance
> 2. Mount via Cloud Storage FUSE in the container
> 3. Shared access via the same bucket/path prefix

### Volume types (Spec Section 10.2)

> | Volume Type | Cloud Emulation | Used For |
> |---|---|---|
> | Named volumes (Docker `VolumeCreate`) | Cloud shared filesystem (EFS, GCS, Azure Files) | Caches |
> | Bind mounts (from `HostConfig.Binds`) | Cloud shared filesystem mounted at specified path | Build data sharing |
> | `VolumesFrom` (inherit from another container) | Same shared filesystem mount applied to multiple tasks | Helper-Build sharing |
> | Anonymous volumes | Ephemeral task storage | Temp data |

### IP address assignment (Spec Section 11.3)

> Sockerless assigns virtual IPs from a private subnet (e.g., `172.18.0.0/16`) to each container on a network. These IPs are returned in inspect responses. Actual cloud networking may use different IPs, but the sockerless-level IPs provide the correct inspect output for CI runners.

### Cloud Run networking model

Cloud Run Jobs with VPC Connector or Direct VPC Egress can communicate with other resources on the same VPC. Each execution gets an internal IP within the VPC. Cloud DNS private zones attached to the VPC enable custom DNS resolution for service aliases.

---

## Acceptance Criteria

### Network Operations

1. `NetworkCreate` creates a Cloud DNS private zone within the configured GCP project and VPC network. The zone name is derived from the network ID (e.g., `sockerless-net-<id-prefix>`).
2. The DNS zone is associated with the VPC network used by Cloud Run Jobs (configured VPC or default VPC).
3. `NetworkCreate` assigns a virtual subnet from the `172.18.0.0/16` range for the network. The subnet and gateway IP are stored in local state.
4. `NetworkInspect` returns network metadata including: ID, Name, Driver ("bridge" for Docker compat), IPAM config (subnet, gateway), Labels, and connected containers with their virtual IPs.
5. `NetworkList` returns all networks matching the provided filters (label, id, name, driver). Filters match Docker's exact semantics.
6. `NetworkConnect` (implicit at container create time via `EndpointsConfig`) assigns a virtual IP to the container on the network, and creates DNS A records in the Cloud DNS zone for the container's name and aliases.
7. DNS A records point to the container's actual Cloud Run internal IP (resolved from the execution's VPC IP). If the actual IP is not yet known (container not started), the record is created/updated at `ContainerStart` time.
8. `NetworkDisconnect` removes the container's DNS A records from the Cloud DNS zone and removes the container from the network's state.
9. `NetworkRemove` deletes the Cloud DNS private zone and removes the network from local state. Returns an error if containers are still connected.
10. `NetworkPrune` removes all networks with no connected containers. Accepts label filters.

### Volume Operations

11. `VolumeCreate` creates a logical directory path within the configured GCS bucket. The path prefix is `volumes/<volume-name>/`. Volume metadata (name, labels, mount point, creation time) is stored in local state.
12. `VolumeInspect` returns volume metadata including: Name, Driver ("local" for Docker compat), Mountpoint, Labels, CreatedAt, and usage info.
13. `VolumeList` returns all volumes matching the provided filters (label, name, dangling).
14. `VolumeRemove` deletes the GCS path prefix (`volumes/<volume-name>/`) and removes the volume from local state. Returns an error if the volume is in use by a running container (unless force flag is set).
15. When a container is created with `HostConfig.Binds` or `HostConfig.Mounts`, the volume mount is recorded in the container's state. At `ContainerStart` time (in GCR-002), the GCS FUSE mount is applied to the Cloud Run Job spec.
16. GCS FUSE mounts in the Cloud Run Job spec use the `volumes` and `volumeMounts` fields: a volume of type `gcs` referencing the bucket and path, mounted at the container's specified mount point.
17. `VolumesFrom` support: when a container specifies `HostConfig.VolumesFrom`, the backend copies the mount list from the referenced container's state and applies the same GCS FUSE mounts to the new container.
18. Anonymous volumes (declared in `Dockerfile VOLUME` directive) are mapped to ephemeral in-memory tmpfs mounts in the Cloud Run Job spec. They are not backed by GCS.

### Example SDK Calls

```go
// Create Cloud DNS private zone
dnsService.ManagedZones.Create(project, &dns.ManagedZone{
    Name:        "sockerless-net-" + networkID[:12],
    DnsName:     networkID[:12] + ".sockerless.internal.",
    Description: "Sockerless network " + networkID,
    Visibility:  "private",
    PrivateVisibilityConfig: &dns.ManagedZonePrivateVisibilityConfig{
        Networks: []*dns.ManagedZonePrivateVisibilityConfigNetwork{{
            NetworkUrl: "projects/PROJECT/global/networks/VPC_NAME",
        }},
    },
}).Do()

// Create DNS A record for container alias
dnsService.ResourceRecordSets.Create(project, zoneName, &dns.ResourceRecordSet{
    Name:    "postgres." + dnsSuffix,
    Type:    "A",
    Ttl:     10,
    Rrdatas: []string{containerIP},
}).Do()

// Cloud Run Job with GCS FUSE volume
&runpb.TaskTemplate{
    Volumes: []*runpb.Volume{{
        Name: "vol-builds",
        VolumeType: &runpb.Volume_Gcs{
            Gcs: &runpb.GCSVolumeSource{
                Bucket:   "sockerless-volumes",
                ReadOnly: false,
            },
        },
    }},
    Containers: []*runpb.Container{{
        VolumeMounts: []*runpb.VolumeMount{{
            Name:      "vol-builds",
            MountPath: "/builds",
        }},
    }},
}
```

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] Unit tests with mock GCP clients for: DNS zone creation/deletion, A record CRUD, virtual IP assignment, GCS path operations, volume mount generation in job spec, VolumesFrom mount copying, network prune with filters
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Cloud DNS API errors wrapped with context: `fmt.Errorf("cloudrun: network create: %w", err)`
- [ ] GCS errors wrapped with context: `fmt.Errorf("cloudrun: volume create: %w", err)`
- [ ] Conflict errors for duplicate network/volume names
- [ ] In-use errors for removing networks with connected containers or volumes mounted by running containers
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` updated with network and volume operation details

### Integration
- [ ] Network state integrates with ContainerCreate/Start (GCR-002) for DNS record management
- [ ] Volume mounts integrate with Cloud Run Job spec generation (GCR-002) for GCS FUSE
- [ ] Virtual IP assignment produces correct output in ContainerInspect NetworkSettings
- [ ] DNS aliases work for CI runner service discovery (e.g., `postgres` resolves to service container)

---

## Suggested File Paths

```
backends/cloudrun/
├── network_create.go           # NetworkCreate: Cloud DNS zone creation, state management
├── network_ops.go              # NetworkInspect, List, Disconnect, Remove, Prune
├── network_dns.go              # DNS A record CRUD in Cloud DNS private zones
├── network_ip.go               # Virtual IP assignment from 172.18.0.0/16 pool
├── volume_create.go            # VolumeCreate: GCS path provisioning, state management
├── volume_ops.go               # VolumeInspect, List, Remove
├── volume_mount.go             # GCS FUSE mount spec generation, VolumesFrom resolution
└── store.go                    # (update) Network and volume state with GCP resource mappings
```

---

## Notes

- Cloud DNS private zones provide DNS resolution only within the associated VPC network. Cloud Run Jobs must use a VPC Connector or Direct VPC Egress to access the VPC and resolve private DNS names. Ensure the VPC connector is configured in GCR-001's config.
- DNS TTL should be low (10 seconds) since containers are short-lived and IPs change. Consider using 0 TTL if Cloud DNS supports it, otherwise the minimum allowed value.
- The virtual IP assignment is purely for Docker API compatibility in inspect responses. Actual inter-container communication uses Cloud DNS names resolving to real VPC IPs. The virtual IPs do not need to be routable.
- GCS FUSE has higher latency than local filesystems (10-50ms per operation). This is acceptable for CI workloads (git clone, build artifacts) but should be documented. GCS FUSE is eventually consistent for metadata operations but strongly consistent for data after writes complete.
- GCS FUSE mounts in Cloud Run Jobs require the Cloud Run service account to have `roles/storage.objectAdmin` on the bucket. This is a deployment prerequisite.
- For volume sharing between containers, both containers mount the same GCS bucket with the same path prefix. GCS FUSE ensures both see the same data, though there may be a brief propagation delay for metadata operations.
- Cloud Run supports in-memory volumes (tmpfs) via `emptyDir` with `medium: "Memory"`. Use this for anonymous volumes declared in Dockerfiles.
- The Cloud DNS API uses the `google.golang.org/api/dns/v1` package. Managed zones and resource record sets are the primary resources.
- Network prune should be careful to only delete zones that sockerless created (identifiable by the `sockerless-net-` prefix in the zone name).
