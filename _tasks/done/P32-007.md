# P32-007: Split sandbox/shell.go into 3 files

**Phase:** 32B (Code Splitting)
**Depends on:** —
**Estimated effort:** M

---

## Description

Split `sandbox/shell.go` (602 lines) into three files organized by responsibility. The main concern is the 150-line `wasmExecHandler` closure nested two levels deep — extracting it improves readability significantly.

## File Split Plan

### `shell.go` — Core Execution Pipeline (~200 lines)

Keep the main API surface and runner construction:
- `RunShell()` — runs a shell command string
- `RunSimpleCommand()` — handles `sh -c`, `sh -e`, script execution
- `RunInteractiveShell()` — interactive shell session
- `newRunner()` — constructs the mvdan.cc/sh interpreter
- `runShellInDir()` — helper wrapping command with PWD assignment

### `shell_exec.go` — WASM Exec Handler & Command Resolution (~250 lines)

Move the complex exec dispatch logic:
- `wasmExecHandler()` — the closure factory (return `interp.ExecHandlerFunc`). Refactor to call named helpers instead of inline logic.
- `dispatchBuiltin()` — extracted from the switch statement in wasmExecHandler
- `dispatchWASMApplet()` — extracted from the bottom half (PATH search + WASM exec)
- `findInPATH()` — PATH directory search for scripts
- `rewriteArgsForCWD()` — CWD-relative path rewriting for non-absolute args

### `shell_helpers.go` — Utility Functions (~100 lines)

Move standalone helpers:
- `mvFallback()` — fallback `mv` implementation (~50 lines)
- `resolveContainerPath()` — maps host paths back to container paths (~12 lines)
- `shellQuote()` — safe shell quoting
- `isShellBinary()` — checks if command is a shell
- `isBashBinary()` — checks if command is bash
- `injectBashEnv()` — bash compatibility shim

## Key Refactoring in shell_exec.go

The current `wasmExecHandler` is a single closure with:
1. A 20+ case switch for builtins (delegate to `builtinCommands` map)
2. PATH search logic
3. WASM applet dispatch
4. CWD rewriting for relative paths

Extract named functions that `wasmExecHandler` calls, reducing it from ~150 lines to ~50 lines of dispatch logic.

## Acceptance Criteria

1. `shell.go` ≤ 250 lines
2. `shell_exec.go` exists with exec handler and command resolution
3. `shell_helpers.go` exists with utility functions
4. All tests pass: `cd sandbox && go test -v ./...` (46 tests), `make lint`
5. No behavior changes

## After Completing

Update `_tasks/done/P32-007.md`. Update `STATUS.md` progress line.
