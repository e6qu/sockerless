# TST-006: Image endpoint tests

**Component:** Test Infrastructure and Suites
**Phase:** 1
**Depends on:** TST-001, FE-014, FE-015, FE-016, FE-017
**Estimated effort:** M

---

## Description

Black-box tests for image endpoints: pull (`POST /images/create`), inspect (`GET /images/{name}/json`), load (`POST /images/load`), tag (`POST /images/{name}/tag`), and auth (`POST /auth`). Tests verify streaming JSON progress for pull, image metadata in inspect, tar handling for load, and credential validation for auth.

---

## Context

### Image pull (Spec Section 4.2)

`POST /images/create?fromImage=nginx&tag=latest`

Headers: `X-Registry-Auth: <base64-encoded-json>` (optional)

Response: Streaming JSON, one object per line:
```json
{"status":"Pulling from library/nginx","id":"latest"}
{"status":"Pulling fs layer","progressDetail":{},"id":"abc123"}
{"status":"Download complete","progressDetail":{},"id":"abc123"}
{"status":"Pull complete","progressDetail":{},"id":"abc123"}
{"status":"Digest: sha256:..."}
{"status":"Status: Downloaded newer image for nginx:latest"}
```

### Image inspect (Spec Section 4.2)

`GET /images/{name}/json`

```json
{
  "Id": "sha256:<digest>",
  "RepoTags": ["nginx:latest"],
  "RepoDigests": ["nginx@sha256:..."],
  "Created": "2026-01-01T00:00:00Z",
  "Size": 0,
  "VirtualSize": 0,
  "Config": {
    "Env": ["PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"],
    "Cmd": ["nginx", "-g", "daemon off;"],
    "Entrypoint": null,
    "ExposedPorts": {"80/tcp": {}},
    "Labels": {},
    "WorkingDir": ""
  },
  "Os": "linux",
  "Architecture": "amd64"
}
```

### Image load (Spec Section 4.2)

`POST /images/load` -- accepts a tar stream containing a Docker image.

### Image tag (Spec Section 4.2)

`POST /images/{name}/tag?repo=myrepo&tag=v1` -- records a new tag for an existing image.

### Registry auth (Spec Section 4.2)

`POST /auth`

Request: `{"username":"user","password":"pass","serveraddress":"https://index.docker.io/v1/"}`
Response: `{"Status": "Login Succeeded"}`

---

## Acceptance Criteria

### Pull

1. `POST /images/create?fromImage=alpine&tag=latest` returns `200` with a streaming JSON body.
2. The response body contains multiple JSON objects, each on its own line, each with a `status` field.
3. At least one JSON line contains `"status"` with a value indicating completion (e.g., contains "Downloaded" or "Pull complete" or "up to date").
4. After pull, the image is available for container creation (tested by creating a container with the pulled image).

### Inspect

5. `GET /images/alpine:latest/json` after pull returns `200` with valid JSON.
6. Response includes `Id` (string starting with `sha256:`).
7. Response includes `RepoTags` array containing the pulled tag.
8. Response includes `Config.Env` as a non-empty array (CI runners read PATH from this).
9. Response includes `Config.Cmd` as an array or null.
10. Response includes `Os` and `Architecture` fields.
11. `GET /images/nonexistent:latest/json` returns `404` with `{"message": "No such image: nonexistent:latest"}`.

### Load

12. `POST /images/load` with a valid tar stream returns `200`.
13. After load, the image can be inspected by its name.

### Tag

14. `POST /images/alpine:latest/tag?repo=myrepo&tag=v1` on an existing image returns `201`.
15. After tagging, `GET /images/myrepo:v1/json` returns the same image metadata.
16. `POST /images/nonexistent:latest/tag?repo=myrepo&tag=v1` returns `404`.

### Auth

17. `POST /auth` with `username`, `password`, and `serveraddress` returns `200` with `{"Status": "Login Succeeded"}`.
18. `POST /auth` with missing fields returns `400` or an error response.

### Example Requests

```bash
# Pull image
curl --unix-socket /var/run/sockerless.sock \
  -X POST "http://localhost/images/create?fromImage=alpine&tag=latest"
# Expected: 200 (streaming JSON lines)
# {"status":"Pulling from library/alpine","id":"latest"}
# {"status":"Status: Downloaded newer image for alpine:latest"}

# Inspect image
curl --unix-socket /var/run/sockerless.sock \
  http://localhost/images/alpine:latest/json | jq '{Id, RepoTags, Config: {Env: .Config.Env, Cmd: .Config.Cmd}}'
# Expected: 200
# {
#   "Id": "sha256:abc...",
#   "RepoTags": ["alpine:latest"],
#   "Config": {
#     "Env": ["PATH=/usr/local/sbin:..."],
#     "Cmd": ["/bin/sh"]
#   }
# }

# Inspect non-existent image
curl --unix-socket /var/run/sockerless.sock \
  http://localhost/images/nonexistent:latest/json
# Expected: 404 {"message": "No such image: nonexistent:latest"}

# Tag image
curl --unix-socket /var/run/sockerless.sock \
  -X POST "http://localhost/images/alpine:latest/tag?repo=myrepo&tag=v1"
# Expected: 201

# Auth
curl --unix-socket /var/run/sockerless.sock \
  -X POST http://localhost/auth \
  -H "Content-Type: application/json" \
  -d '{"username":"user","password":"pass","serveraddress":"https://index.docker.io/v1/"}'
# Expected: 200 {"Status": "Login Succeeded"}
```

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] New black-box REST tests written for new/changed behavior (in `tests/` module)
- [ ] Tests run against memory backend by default
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Custom error types used for all domain errors (not bare `errors.New`)
- [ ] Errors wrapped with context: `fmt.Errorf("operation: %w", err)`
- [ ] Zerolog structured logging on all error paths
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` created or updated (if this task creates or modifies a module)

### Integration
- [ ] No breaking changes to the internal API contract
- [ ] Capability model updated if new backend capabilities are added

### Task-Specific
- [ ] All 18 acceptance criteria pass
- [ ] Pull test parses streaming JSON correctly (line-delimited)
- [ ] Tests pass against memory backend (synthetic pull) and Docker backend (real pull)
- [ ] Image load test creates a minimal valid tar for testing

---

## Suggested File Paths

```
tests/
├── image_test.go                  # TestImagePull, TestImageInspect, TestImageLoad, TestImageTag, TestAuth
└── helpers/
    ├── image.go                   # pullImage, inspectImage, tagImage, loadImage helpers
    └── tar.go                     # createMinimalImageTar helper for load tests
```

---

## Notes

- The pull response is streaming JSON (one JSON object per line, `\n` delimited). Use `json.NewDecoder` with a loop calling `Decode` to parse each line.
- For image load tests, create a minimal tar file with a `manifest.json` entry. The memory backend only needs to read the manifest to extract the image name. Full Docker-format tar creation is complex; start with the simplest case.
- The memory backend generates synthetic image metadata on pull (default Env, Cmd, etc.). Tests against the Docker backend will get real image metadata. Write assertions that work for both: check that `Config.Env` is non-empty, not that it contains a specific value.
- Image names can include tags (`alpine:latest`), digests (`alpine@sha256:...`), or registry prefixes (`docker.io/library/alpine:latest`). Test with the simplest form first.
- For the auth test, the memory backend validates field presence only (it does not contact a real registry). The Docker backend calls `client.RegistryLogin` which may fail if credentials are invalid. Use test-specific logic or skip the Docker backend auth test.
- `X-Registry-Auth` header is base64-encoded JSON. Construct it in the test helper for pull-with-auth scenarios.
