# TST-007: Network endpoint tests

**Component:** Test Infrastructure and Suites
**Phase:** 1
**Depends on:** TST-001, FE-018
**Estimated effort:** M

---

## Description

Black-box tests for network endpoints: create, list, inspect, disconnect, remove, and prune. Tests verify CRUD operations, label-based filtering, container membership tracking, and prune behavior. Each test is independent and cleans up after itself.

---

## Context

### Network create (Spec Section 4.5)

`POST /networks/create`

Request:
```json
{
  "Name": "test-network",
  "Labels": {"env": "test", "com.gitlab.gitlab-runner.managed": "true"},
  "EnableIPv6": false,
  "Driver": "bridge",
  "Options": {"com.docker.network.driver.mtu": "1500"}
}
```

Response: `201 Created`
```json
{"Id": "<64-char-hex>", "Warning": ""}
```

### Network list (Spec Section 4.5)

`GET /networks?filters={"label":["key=value"]}`

Returns array of network objects.

Filter formats: `{"label":["key=value"]}`, `{"name":["name"]}`

### Network inspect (Spec Section 4.5)

`GET /networks/{id}`

```json
{
  "Name": "test-network",
  "Id": "<hex>",
  "Created": "2026-02-15T12:00:00Z",
  "Scope": "local",
  "Driver": "bridge",
  "EnableIPv6": false,
  "IPAM": {
    "Driver": "default",
    "Config": [{"Subnet": "172.18.0.0/16", "Gateway": "172.18.0.1"}]
  },
  "Containers": {
    "<container-id>": {
      "Name": "postgres",
      "IPv4Address": "172.18.0.2/16"
    }
  },
  "Labels": {"env": "test"}
}
```

### Network disconnect (Spec Section 4.5)

`POST /networks/{id}/disconnect`

Request: `{"Container": "<container-id>", "Force": true}`

### Network remove (Spec Section 4.5)

`DELETE /networks/{id}` -- Response: `204 No Content`

### Network prune (Spec Section 4.5)

`POST /networks/prune?filters={"label":["key"]}`

Response: `{"NetworksDeleted": ["net1", "net2"]}`

### Network emulation (Spec Section 11)

Sockerless assigns virtual IPs from a private subnet to each container on a network. These IPs are returned in inspect responses.

---

## Acceptance Criteria

### Create

1. `POST /networks/create` with `Name` and `Labels` returns `201` with `{"Id": "<hex>", "Warning": ""}`.
2. The returned ID is a non-empty hex string.
3. Created network is visible in `GET /networks` list.

### Inspect

4. `GET /networks/{id}` returns the full network object with `Name`, `Id`, `Created`, `Scope`, `Driver`, `IPAM`, `Containers`, `Labels`.
5. `GET /networks/{id}` returns the labels that were set at creation.
6. `GET /networks/{id}` for a non-existent network returns `404` with `{"message": "network <id> not found"}`.
7. When a container is connected to the network, `Containers` map includes the container with its name and IP address.

### List

8. `GET /networks` returns all networks as an array.
9. `GET /networks?filters={"label":["env=test"]}` returns only networks with the matching label.
10. `GET /networks?filters={"name":["test-network"]}` returns networks with matching name.
11. `GET /networks` with no filters returns at least the networks created in the test.

### Disconnect

12. `POST /networks/{id}/disconnect` with a valid container ID removes the container from the network's `Containers` map.
13. After disconnect, inspecting the network shows the container is no longer in the `Containers` map.
14. `POST /networks/{id}/disconnect` with a non-existent network returns `404`.
15. `POST /networks/{id}/disconnect` with a non-existent container returns `404`.

### Remove

16. `DELETE /networks/{id}` removes the network. Returns `204`.
17. After remove, `GET /networks/{id}` returns `404`.
18. `DELETE /networks/{nonexistent}` returns `404`.

### Prune

19. `POST /networks/prune` removes networks that have no connected containers. Returns `{"NetworksDeleted": [...]}`.
20. `POST /networks/prune` does NOT remove networks that have connected containers.
21. `POST /networks/prune?filters={"label":["prune-me"]}` only prunes networks with the matching label.

### Example Requests

```bash
# Create network
curl --unix-socket /var/run/sockerless.sock \
  -X POST http://localhost/networks/create \
  -H "Content-Type: application/json" \
  -d '{"Name":"test-net","Labels":{"env":"test"}}'
# Expected: 201 {"Id":"abc123...","Warning":""}

# List networks
curl --unix-socket /var/run/sockerless.sock \
  http://localhost/networks | jq '.[].Name'
# Expected: includes "test-net"

# List with label filter
curl --unix-socket /var/run/sockerless.sock \
  'http://localhost/networks?filters={"label":["env=test"]}' | jq '.[].Name'
# Expected: ["test-net"]

# Inspect network
curl --unix-socket /var/run/sockerless.sock \
  http://localhost/networks/abc123 | jq '{Name, Labels, Containers}'
# Expected: {"Name":"test-net","Labels":{"env":"test"},"Containers":{}}

# Disconnect container
curl --unix-socket /var/run/sockerless.sock \
  -X POST http://localhost/networks/abc123/disconnect \
  -H "Content-Type: application/json" \
  -d '{"Container":"container123","Force":true}'
# Expected: 200

# Remove network
curl --unix-socket /var/run/sockerless.sock \
  -X DELETE http://localhost/networks/abc123
# Expected: 204

# Remove non-existent network
curl --unix-socket /var/run/sockerless.sock \
  -X DELETE http://localhost/networks/nonexistent
# Expected: 404 {"message":"network nonexistent not found"}

# Prune
curl --unix-socket /var/run/sockerless.sock \
  -X POST http://localhost/networks/prune
# Expected: 200 {"NetworksDeleted":["net1","net2"]}
```

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] New black-box REST tests written for new/changed behavior (in `tests/` module)
- [ ] Tests run against memory backend by default
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Custom error types used for all domain errors (not bare `errors.New`)
- [ ] Errors wrapped with context: `fmt.Errorf("operation: %w", err)`
- [ ] Zerolog structured logging on all error paths
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` created or updated (if this task creates or modifies a module)

### Integration
- [ ] No breaking changes to the internal API contract
- [ ] Capability model updated if new backend capabilities are added

### Task-Specific
- [ ] All 21 acceptance criteria pass
- [ ] Each test creates its own networks and cleans up via `defer removeNetwork(t, id)`
- [ ] Container membership tests create a container connected to the network
- [ ] Tests pass against both memory and Docker backends

---

## Suggested File Paths

```
tests/
├── network_test.go                # TestNetworkCreate, TestNetworkInspect, TestNetworkList, TestNetworkDisconnect, TestNetworkRemove, TestNetworkPrune
└── helpers/
    └── network.go                 # createNetwork, inspectNetwork, listNetworks, removeNetwork, disconnectContainer helpers
```

---

## Notes

- To test container membership in network inspect, create a container with `NetworkingConfig.EndpointsConfig` that references the test network. After start, the network's `Containers` map should include the container.
- Network names must be unique. Use `t.Name()` + random suffix for network names.
- The `filters` query parameter is URL-encoded JSON. Encode properly in test helpers: `url.QueryEscape(jsonString)`.
- Docker returns some built-in networks (bridge, host, none). The Docker backend will return these in list results. Tests should filter or account for them.
- Prune tests should create at least 2 networks: one with a container and one without. Verify that prune removes only the empty one.
- The IPAM configuration in the inspect response should have at least one subnet config. The memory backend assigns synthetic subnets.
- Network `Scope` is `"local"` for Sockerless (no multi-host networking).
