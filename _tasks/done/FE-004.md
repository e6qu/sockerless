# FE-004: POST /containers/create

**Component:** Docker REST API Frontend
**Phase:** 1
**Depends on:** FE-001, MEM-002
**Estimated effort:** L

---

## Description

Implement the `POST /containers/create` endpoint, which is the most complex endpoint in the Docker API. This endpoint parses the full Docker container creation request body, generates a unique 64-character hex container ID, stores the configuration in the backend via the internal API, and returns the ID. No container is started at this stage.

## Context

### Container Create (spec Section 4.3)

Query parameter: `name` (optional container name, without leading `/`).

**Request body structure** (fields actually used by CI runners):

```json
{
  "Image": "nginx:latest",
  "Hostname": "runner-abc-project-1-concurrent-0",
  "Cmd": ["sh", "-c", "echo hello"],
  "Entrypoint": ["/bin/sh"],
  "Env": ["CI=true", "GITLAB_CI=true"],
  "Labels": {
    "com.gitlab.gitlab-runner.managed": "true",
    "com.docker.compose.project": "myapp"
  },
  "User": "",
  "Tty": false,
  "AttachStdin": true,
  "AttachStdout": true,
  "AttachStderr": true,
  "OpenStdin": true,
  "StdinOnce": true,
  "ExposedPorts": {"80/tcp": {}},
  "WorkingDir": "/app",
  "HostConfig": {
    "Binds": ["/builds:/builds", "/cache:/cache"],
    "Memory": 536870912,
    "NanoCPUs": 1000000000,
    "NetworkMode": "<network-id>",
    "PortBindings": {"80/tcp": [{"HostPort": "8080"}]},
    "RestartPolicy": {"Name": "no"},
    "ExtraHosts": ["service:10.0.0.2"],
    "Dns": ["8.8.8.8"],
    "Privileged": false,
    "VolumesFrom": [],
    "Tmpfs": {}
  },
  "NetworkingConfig": {
    "EndpointsConfig": {
      "<network-name>": {
        "Aliases": ["postgres", "db"],
        "MacAddress": "02:42:ac:11:00:02"
      }
    }
  }
}
```

**Response:**
```json
{
  "Id": "<64-char-hex-id>",
  "Warnings": []
}
```

### Fields That Must Be Preserved in State

Read back by inspect (`GET /containers/{id}/json`):
- `Image`, `Hostname`, `Cmd`, `Entrypoint`, `Env`, `Labels`, `User`, `Tty`
- `ExposedPorts`, `WorkingDir`
- `HostConfig.*` (all fields listed above)
- `NetworkingConfig.*`
- `AttachStdin`, `AttachStdout`, `AttachStderr`, `OpenStdin`, `StdinOnce`

### Fields That Can Be Silently Ignored

Not relevant to cloud backends, but should still be stored and returned in inspect for client compatibility:
- `MacAddress` (v1.44 location: inside `EndpointsConfig`)
- `CgroupParent`, `DeviceCgroupRules`, `PidMode`, `UTSMode`
- `SecurityOpt`, `CapAdd`, `CapDrop`, `UsernsMode`
- `ShmSize`, `Sysctls`, `OomKillDisable`, `OomScoreAdj`
- `Runtime`, `Isolation`, `Init`

### Sockerless Behavior (spec Section 4.3)

1. Generate a unique 64-character hex container ID
2. Store the full container configuration in internal state
3. Resolve `Binds` to cloud volume mappings
4. Resolve `NetworkMode` and `NetworkingConfig` to cloud network mappings
5. Do NOT start the cloud backend task yet (that happens on `POST /containers/{id}/start`)

### Internal API (spec Section 7.3)

Frontend sends: `POST /internal/v1/containers` with the container configuration.

## Acceptance Criteria

1. `POST /containers/create` accepts a JSON body with at minimum the `Image` field
2. Returns `201 Created` with `{"Id": "<64-char-hex>", "Warnings": []}`
3. The `Id` is exactly 64 hexadecimal characters (lowercase)
4. Query parameter `?name=mycontainer` sets the container's name
5. Returns `404 Not Found` with `{"message": "No such image: <image>"}` if the image has not been pulled
6. Returns `409 Conflict` with `{"message": "Conflict. The container name \"/<name>\" is already in use..."}` if a container with the same name already exists
7. Returns `400 Bad Request` for invalid JSON or missing `Image` field
8. All fields from the request body are stored and retrievable via `GET /containers/{id}/json`
9. The created container appears in `GET /containers/json?all=true` with state `"created"`
10. Container state is `"created"` (not `"running"`) after create
11. Silently-ignored fields (e.g., `SecurityOpt`, `CapAdd`) are stored and returned in inspect but do not affect behavior
12. Multiple containers can be created from the same image
13. Container names must be unique; container IDs are always unique

### Example Requests

```bash
# Basic create
curl -s --unix-socket /var/run/sockerless.sock \
  -X POST -H "Content-Type: application/json" \
  -d '{"Image":"alpine:latest","Cmd":["echo","hello"]}' \
  "http://localhost/v1.44/containers/create?name=test1"
# 201 {"Id":"a1b2c3...64chars...","Warnings":[]}

# Create with full CI runner config
curl -s --unix-socket /var/run/sockerless.sock \
  -X POST -H "Content-Type: application/json" \
  -d '{
    "Image": "alpine:latest",
    "Cmd": ["sh", "-c", "echo hello"],
    "Env": ["CI=true"],
    "Labels": {"com.gitlab.gitlab-runner.managed": "true"},
    "Tty": false,
    "OpenStdin": true,
    "AttachStdin": true,
    "AttachStdout": true,
    "AttachStderr": true,
    "HostConfig": {
      "Binds": ["/builds:/builds"],
      "NetworkMode": "bridge"
    }
  }' \
  "http://localhost/v1.44/containers/create?name=runner-build"
# 201 {"Id":"...","Warnings":[]}

# Error: image not found
curl -s --unix-socket /var/run/sockerless.sock \
  -X POST -H "Content-Type: application/json" \
  -d '{"Image":"nonexistent:latest"}' \
  "http://localhost/v1.44/containers/create"
# 404 {"message":"No such image: nonexistent:latest"}

# Error: name conflict
curl -s --unix-socket /var/run/sockerless.sock \
  -X POST -H "Content-Type: application/json" \
  -d '{"Image":"alpine:latest"}' \
  "http://localhost/v1.44/containers/create?name=test1"
# 409 {"message":"Conflict. The container name \"/test1\" is already in use..."}

# Error: invalid body
curl -s --unix-socket /var/run/sockerless.sock \
  -X POST -H "Content-Type: application/json" \
  -d '{"not_valid"}' \
  "http://localhost/v1.44/containers/create"
# 400 {"message":"invalid JSON: ..."}
```

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] New black-box REST tests written for new/changed behavior (in `tests/` module)
- [ ] Tests run against memory backend by default
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Custom error types used for all domain errors (not bare `errors.New`)
- [ ] Errors wrapped with context: `fmt.Errorf("operation: %w", err)`
- [ ] Zerolog structured logging on all error paths
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` created or updated (if this task creates or modifies a module)

### Integration
- [ ] No breaking changes to the internal API contract (unless the task explicitly requires it)
- [ ] Capability model updated if new backend capabilities are added

### Task-Specific
- [ ] Container ID is exactly 64 lowercase hex characters (verified by regex `^[0-9a-f]{64}$`)
- [ ] All Docker create body fields from the spec are parsed (no unknown field errors)
- [ ] Full round-trip: create then inspect returns all stored fields

## Suggested File Paths

```
frontends/docker/
├── handler_container_create.go   # POST /containers/create handler
├── types_container.go            # Docker container create request/response types
└── id.go                         # Container ID generation (crypto/rand hex)
```

## Notes

- Generate IDs with `crypto/rand` and `encoding/hex`: 32 random bytes = 64 hex chars. Never use `math/rand` for IDs.
- The Docker create body has many fields. Use a permissive approach: decode into a struct with known fields, use `json.RawMessage` or a map for unknown fields, and store everything. This ensures forward compatibility.
- Container names must start with `/` when stored (Docker convention), but the `?name=` query param does not include the `/` prefix.
- The `Image` field is required. If it references an image not in the backend's image store, return 404. The image must have been previously pulled via `POST /images/create`.
- `HostConfig.NetworkMode` defaults to `"bridge"` if not specified, matching Docker behavior.
- The response status code is `201 Created`, not `200 OK`. Docker SDK clients check for this.
