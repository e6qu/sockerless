# TST-001: Black-box test harness scaffold

**Component:** TST (Test infrastructure)
**Phase:** 1
**Depends on:** API-001
**Estimated effort:** M

---

## Description

Create the `tests/` module (`github.com/sockerless/tests`) containing a reusable test harness for black-box REST testing of the Sockerless Docker API. The harness starts a frontend + memory backend in-process, exposes them on a random Unix socket, and provides an HTTP client and helper functions for creating/cleaning up Docker resources.

All Sockerless tests are black-box: they hit the HTTP endpoint via Unix socket (or TCP), never import frontend or backend code, and use the Docker client SDK or raw HTTP as the test client. The harness supports targeting an external daemon via a `--socket` flag for testing against real Docker or cloud backends.

---

## Context

### Testing strategy (CONVENTIONS.md)

> - **Black-box REST tests only** -- all tests in the `tests/` module
> - Tests hit the HTTP endpoint (via Unix socket or TCP)
> - Test binary accepts a `--socket` or `--addr` flag to target any backend
> - Default: run against memory backend for speed
> - Use `testing.T` with subtests (`t.Run`)
> - Table-driven style for parameterized scenarios
> - Each test creates its own resources and cleans up (no shared state between tests)
> - Test helpers in `tests/helpers/` for common operations

### Project structure (Spec Section 6.2)

> ```
> tests/                             # Module: black-box API tests
>     go.mod                         #   Deps: Docker client SDK (as test client)
> ```
>
> | # | Module | Binary Name | External Dependencies |
> |---|--------|-------------|----------------------|
> | 12 | `tests/` | *(test binary -- `go test`)* | Docker client SDK |

The tests module uses the Docker client SDK (`github.com/docker/docker/client`) as the HTTP client, which ensures the test is exercising the API from a real Docker client's perspective. Raw HTTP (`net/http`) can also be used for protocol-level tests.

### Shared test binary approach (CONVENTIONS.md)

The test binary is compiled once and can be pointed at different sockets:

```bash
# Default: start memory backend in-process, test against it
go test ./...

# Test against an external Sockerless instance (e.g., with ECS backend)
go test ./... --socket /tmp/sockerless-ecs.sock

# Test against a real Docker daemon
go test ./... --socket /var/run/docker.sock
```

This single binary validates behavior consistency across all backends.

### Module dependency rules (Spec Section 6.6)

> ```
> tests ----imports----> Docker SDK (as test client, not api/)
> ```
>
> The tests module does NOT import `api/`, `frontend/`, or any backend module. It communicates only via HTTP.

### Endpoint summary for helpers (Spec Section 3.1)

The harness needs helpers for the most common operations:

| Helper | Docker API Call | Purpose |
|--------|----------------|---------|
| `PullImage` | `POST /images/create?fromImage=...` | Pull an image before creating containers |
| `CreateContainer` | `POST /containers/create` | Create a container with sensible defaults |
| `StartContainer` | `POST /containers/{id}/start` | Start a created container |
| `RemoveContainer` | `DELETE /containers/{id}?force=true&v=true` | Force-remove container and volumes |
| `CreateNetwork` | `POST /networks/create` | Create a network |
| `RemoveNetwork` | `DELETE /networks/{id}` | Remove a network |
| `CreateVolume` | `POST /volumes/create` | Create a volume |
| `RemoveVolume` | `DELETE /volumes/{name}?force=true` | Remove a volume |

### Docker error format for assertions (Spec Section 5.4)

> ```json
> {"message": "No such container: abc123"}
> ```
>
> Standard HTTP status codes: 200/201/204 (success), 304 (not modified), 400 (bad request), 404 (not found), 409 (conflict), 500 (server error), 501 (not implemented).

---

## Acceptance Criteria

1. A `tests/go.mod` exists with module path `github.com/sockerless/tests` and Go 1.23+. It depends on `github.com/docker/docker` (client SDK) and the standard `testing` package.
2. A `TestMain(m *testing.M)` function in `tests/main_test.go`:
   - Parses `--socket` flag (string, default empty)
   - If `--socket` is empty, starts the frontend + memory backend in-process on a random Unix socket in `os.TempDir()` and sets the socket path
   - If `--socket` is provided, uses that socket path (does not start any server)
   - Runs `m.Run()` and exits with the result code
   - Cleans up the Unix socket file on exit (if it started the server)
3. A `Harness` struct (or equivalent) is available to test functions with:
   - `Client() *client.Client` -- returns a Docker SDK client configured for the test socket
   - `HTTPClient() *http.Client` -- returns a raw HTTP client configured for the Unix socket transport
   - `BaseURL() string` -- returns the base URL for raw HTTP requests (e.g., `http://localhost/v1.44`)
   - `SocketPath() string` -- returns the Unix socket path
4. Helper function `PullImage(t *testing.T, ref string)` that calls `POST /images/create?fromImage=<ref>` and fails the test on error.
5. Helper function `CreateContainer(t *testing.T, name string, image string, cmd []string) string` that calls `POST /containers/create` with the given parameters and returns the container ID. Registers cleanup with `t.Cleanup` to force-remove the container after the test.
6. Helper function `StartContainer(t *testing.T, id string)` that calls `POST /containers/{id}/start` and fails on error.
7. Helper function `RemoveContainer(t *testing.T, id string)` that calls `DELETE /containers/{id}?force=true&v=true`. Does not fail if the container is already removed (ignores 404).
8. Helper function `CreateNetwork(t *testing.T, name string) string` that calls `POST /networks/create` and returns the network ID. Registers `t.Cleanup` to remove the network.
9. Helper function `RemoveNetwork(t *testing.T, id string)` that calls `DELETE /networks/{id}`. Ignores 404.
10. Helper function `CreateVolume(t *testing.T, name string) string` that calls `POST /volumes/create` and returns the volume name. Registers `t.Cleanup` to remove the volume.
11. Helper function `RemoveVolume(t *testing.T, name string)` that calls `DELETE /volumes/{name}?force=true`. Ignores 404.
12. Assertion helper `AssertStatus(t *testing.T, resp *http.Response, expected int)` that checks the HTTP status code and produces a clear failure message including the response body on mismatch.
13. Assertion helper `AssertJSON(t *testing.T, resp *http.Response, key string, expected interface{})` that parses the response body as JSON, extracts the value at `key` (supports dot notation for nested keys, e.g., `"State.Status"`), and compares it to `expected`.
14. All resources created by helpers are cleaned up after each test via `t.Cleanup` registrations. Tests are isolated and leave no state behind.
15. A smoke test `TestPing(t *testing.T)` exists in `tests/main_test.go` that calls `GET /_ping` and asserts a 200 response. This validates the harness itself works.

### Example Test Using the Harness

```go
func TestContainerCreateAndInspect(t *testing.T) {
    h := GetHarness(t)

    // Pull the image first
    PullImage(t, "alpine:latest")

    // Create a container (auto-cleaned up)
    id := CreateContainer(t, "test-inspect", "alpine:latest", []string{"echo", "hello"})

    // Inspect via raw HTTP
    resp, err := h.HTTPClient().Get(h.BaseURL() + "/containers/" + id + "/json")
    require.NoError(t, err)
    defer resp.Body.Close()

    AssertStatus(t, resp, 200)
    AssertJSON(t, resp, "Id", id)
    AssertJSON(t, resp, "State.Status", "created")
    AssertJSON(t, resp, "Config.Image", "alpine:latest")
}
```

### Example: Running Against Different Backends

```bash
# Memory backend (default, fast, no external deps)
cd tests && go test -v ./...

# External Sockerless with ECS backend
cd tests && go test -v ./... --socket /tmp/sockerless-ecs.sock

# Real Docker daemon
cd tests && go test -v ./... --socket /var/run/docker.sock

# With race detector
cd tests && go test -race -v ./...
```

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] `TestPing` smoke test passes against the in-process memory backend
- [ ] Tests are deterministic (no flaky tests)
- [ ] Each helper cleans up after itself via `t.Cleanup`

### Error Handling
- [ ] Helpers use `t.Helper()` so failures report the caller's line number
- [ ] Helpers use `t.Fatalf` for unrecoverable errors (cannot create test fixture)
- [ ] Cleanup functions tolerate already-removed resources (ignore 404)

### Documentation
- [ ] GoDoc comments on all exported types, functions, and methods
- [ ] Module `README.md` created with usage instructions and examples for `--socket` flag

### Integration
- [ ] Module does NOT import `api/`, `frontend/`, or any backend module
- [ ] Uses Docker client SDK as the test client
- [ ] `--socket` flag works for targeting external daemons

---

## Suggested File Paths

```
tests/
├── go.mod            # module github.com/sockerless/tests, go 1.23
├── go.sum
├── README.md         # Usage: go test ./..., --socket flag, etc.
├── main_test.go      # TestMain, --socket flag parsing, in-process server startup, TestPing
├── harness.go        # Harness struct, GetHarness(t), Client(), HTTPClient(), BaseURL()
├── helpers.go        # PullImage, CreateContainer, StartContainer, RemoveContainer,
│                     # CreateNetwork, RemoveNetwork, CreateVolume, RemoveVolume
└── assert.go         # AssertStatus, AssertJSON
```

---

## Notes

- **In-process server startup:** For the default (no `--socket` flag) case, the test binary needs to start the frontend and memory backend. This creates a temporary coupling at the binary level, but NOT at the import level. Options:
  - Import the frontend and memory backend packages directly (simplest, but breaks the "no cross-module imports" rule)
  - Build and exec the frontend+memory binary as a subprocess, wait for the socket to appear
  - The recommended approach is the subprocess model: `TestMain` builds and starts `sockerless-docker-frontend` + `sockerless-backend-memory` as child processes. This keeps the import rule clean.
  - For early development (before binaries exist), a stub server that returns canned responses may be needed. Mark this with a `TODO` comment.

- **Docker client SDK configuration for Unix socket:**
  ```go
  cli, err := client.NewClientWithOpts(
      client.WithHost("unix:///tmp/sockerless-test.sock"),
      client.WithVersion("1.44"),
  )
  ```

- **Raw HTTP client for Unix socket:**
  ```go
  httpClient := &http.Client{
      Transport: &http.Transport{
          DialContext: func(ctx context.Context, _, _ string) (net.Conn, error) {
              return net.Dial("unix", socketPath)
          },
      },
  }
  ```

- **Random socket path:** Use `filepath.Join(os.TempDir(), fmt.Sprintf("sockerless-test-%d.sock", os.Getpid()))` to avoid conflicts between parallel test runs.

- **Cleanup ordering:** `t.Cleanup` functions run in LIFO order. Helpers should register cleanup in the order that makes sense: container removal before network removal (since a container may be connected to the network).

- **`AssertJSON` dot notation:** For a key like `"State.Status"`, split on `.` and walk the parsed JSON map. Example: `parsed["State"].(map[string]interface{})["Status"]`. If any intermediate key is missing, fail with a descriptive message.

- **Test timeout:** Set a default test timeout of 30 seconds for memory backend tests. External backend tests may need longer timeouts (configurable via `go test -timeout`).

- **Test parallelism:** Tests CAN run in parallel (`t.Parallel()`) because each test creates its own named resources. However, do not mark tests parallel until the harness is proven stable.
