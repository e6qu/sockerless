# FE-003: System Endpoints

**Component:** Docker REST API Frontend
**Phase:** 1
**Depends on:** FE-001
**Estimated effort:** S

---

## Description

Implement the four system endpoints: `GET /_ping`, `HEAD /_ping`, `GET /version`, and `GET /info`. These are the first endpoints any Docker client calls. The `_ping` endpoints must respond instantly without contacting the backend (used for API version negotiation and health checks). The `/version` and `/info` endpoints delegate to the backend for dynamic values like backend name and resource information.

## Context

### System Endpoints (spec Section 4.1)

#### `GET /_ping` / `HEAD /_ping`

Returns `OK` (plain text). Headers:
```
API-Version: 1.44
Docker-Experimental: false
Ostype: linux
Builder-Version: 0
```

Used by Docker SDK for API version negotiation. Must respond fast (no backend calls).

#### `GET /version`

```json
{
  "Platform": { "Name": "Sockerless" },
  "Version": "0.1.0",
  "ApiVersion": "1.44",
  "MinAPIVersion": "1.44",
  "Os": "linux",
  "Arch": "amd64",
  "KernelVersion": "",
  "BuildTime": "2026-02-15T00:00:00.000000000+00:00",
  "Components": [
    {
      "Name": "Sockerless",
      "Version": "0.1.0",
      "Details": {
        "Backend": "<configured-backend-name>"
      }
    }
  ]
}
```

The `Backend` field in `Components[0].Details` is dynamic and comes from the backend's version/info endpoint.

#### `GET /info`

Returns system information. Key fields that CI runners read:

| Field | Sockerless Value | Why |
|-------|-----------------|-----|
| `OSType` | `"linux"` | GitLab Runner uses this to detect container OS type |
| `Architecture` | `"x86_64"` | Informational |
| `NCPU` | Backend-dependent | |
| `MemTotal` | Backend-dependent | |
| `ServerVersion` | `"0.1.0"` | |
| `Swarm.LocalNodeState` | `"inactive"` | No Swarm support |
| `Runtimes` | `{"sockerless": {"path": "sockerless"}}` | |
| `DefaultRuntime` | `"sockerless"` | |
| `SecurityOptions` | `[]` | |

### API Versioning (spec Section 3.3)

Sockerless targets Docker API v1.44. The `GET /_ping` response includes `API-Version: 1.44` and `Docker-Experimental: false`.

## Acceptance Criteria

1. `GET /_ping` returns status `200` with body `OK` (plain text, `Content-Type: text/plain`)
2. `HEAD /_ping` returns status `200` with no body, same headers as GET
3. Both `_ping` endpoints include all four headers: `API-Version: 1.44`, `Docker-Experimental: false`, `Ostype: linux`, `Builder-Version: 0`
4. `_ping` does NOT contact the backend (must be fast, <1ms)
5. `GET /version` returns `200` with JSON body matching the Docker version response format
6. `GET /version` includes `ApiVersion: "1.44"`, `MinAPIVersion: "1.44"`, `Os: "linux"`
7. `GET /version` delegates to the backend for the backend name in `Components[0].Details.Backend`
8. `GET /info` returns `200` with JSON body including all fields listed in the spec
9. `GET /info` includes `OSType: "linux"`, `Swarm.LocalNodeState: "inactive"`, `SecurityOptions: []`
10. `GET /info` delegates to the backend for dynamic values (`NCPU`, `MemTotal`)
11. All endpoints work with both versioned (`/v1.44/_ping`) and unversioned (`/_ping`) paths
12. `_ping` endpoints are registered outside the version prefix (Docker clients call `/_ping` without version prefix during negotiation)

### Example Requests

```bash
# Ping (GET)
curl -i --unix-socket /var/run/sockerless.sock http://localhost/_ping
# HTTP/1.1 200 OK
# API-Version: 1.44
# Docker-Experimental: false
# Ostype: linux
# Builder-Version: 0
# Content-Type: text/plain; charset=utf-8
#
# OK

# Ping (HEAD)
curl -I --unix-socket /var/run/sockerless.sock http://localhost/_ping
# HTTP/1.1 200 OK
# API-Version: 1.44
# Docker-Experimental: false
# Ostype: linux
# Builder-Version: 0
# Content-Type: text/plain; charset=utf-8

# Ping with version prefix
curl --unix-socket /var/run/sockerless.sock http://localhost/v1.44/_ping
# OK

# Version
curl -s --unix-socket /var/run/sockerless.sock http://localhost/version | jq .
# {
#   "Platform": { "Name": "Sockerless" },
#   "Version": "0.1.0",
#   "ApiVersion": "1.44",
#   ...
# }

# Info
curl -s --unix-socket /var/run/sockerless.sock http://localhost/info | jq '.OSType, .ServerVersion'
# "linux"
# "0.1.0"
```

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] New black-box REST tests written for new/changed behavior (in `tests/` module)
- [ ] Tests run against memory backend by default
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Custom error types used for all domain errors (not bare `errors.New`)
- [ ] Errors wrapped with context: `fmt.Errorf("operation: %w", err)`
- [ ] Zerolog structured logging on all error paths
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` created or updated (if this task creates or modifies a module)

### Integration
- [ ] No breaking changes to the internal API contract (unless the task explicitly requires it)
- [ ] Capability model updated if new backend capabilities are added

### Task-Specific
- [ ] `_ping` response time verified <1ms (no backend call)
- [ ] All four required headers present on ping responses
- [ ] JSON response shapes match Docker's format exactly (PascalCase fields)

## Suggested File Paths

```
frontends/docker/
├── handler_system.go      # Handlers for /_ping, /version, /info
└── handler_system_test.go # Unit tests (optional, black-box tests preferred)
```

## Notes

- `/_ping` is special: Docker clients call it WITHOUT a version prefix during API negotiation. Register it at both `/_ping` and `/v1.44/_ping`.
- The `HEAD /_ping` must return the same headers as `GET /_ping` but with no body. Use the same handler and let `net/http` handle the HEAD method automatically (it suppresses the body).
- For `/version` and `/info`, the frontend can hardcode most fields and only call the backend for dynamic values. If the backend is unreachable, consider returning a degraded response (with zeros for backend-specific fields) rather than a 500 error — `_ping` must always work.
- `GET /info` has a very large response body in real Docker (100+ fields). Sockerless only needs to include the fields CI runners actually read plus a reasonable set of common fields. Unknown fields can be omitted or set to zero values.
- The `Runtimes` field should be `{"sockerless": {"path": "sockerless"}}` and `DefaultRuntime` should be `"sockerless"`.
