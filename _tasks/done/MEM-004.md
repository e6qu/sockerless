# MEM-004: Memory backend images, networks, volumes

**Component:** In-memory Backend
**Phase:** 1
**Depends on:** MEM-001
**Estimated effort:** M

---

## Description

Implement image, network, and volume operations in the memory backend. All three resource types are stored in-memory maps with full CRUD support. Images support pull (synthetic), inspect, load, and tag. Networks support create, list, inspect, disconnect, remove, and prune with container membership tracking. Volumes support create, list, inspect, and remove with labels.

---

## Context

### Image operations (Spec Section 4.2)

**Pull (`POST /images/create`):** Records the image reference in the internal state store. Does NOT actually pull the image locally. The progress output is synthetic (immediate "Pull complete").

```json
{"status":"Pulling from library/nginx","id":"latest"}
{"status":"Pull complete","progressDetail":{},"id":"latest"}
{"status":"Digest: sha256:abc123..."}
{"status":"Status: Downloaded newer image for nginx:latest"}
```

**Inspect (`GET /images/{name}/json`):**
```json
{
  "Id": "sha256:<digest>",
  "RepoTags": ["nginx:latest"],
  "RepoDigests": ["nginx@sha256:..."],
  "Created": "2026-01-01T00:00:00Z",
  "Size": 0,
  "VirtualSize": 0,
  "Config": {
    "Env": ["PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"],
    "Cmd": ["nginx", "-g", "daemon off;"],
    "Entrypoint": null,
    "ExposedPorts": {"80/tcp": {}},
    "Labels": {},
    "WorkingDir": ""
  },
  "Os": "linux",
  "Architecture": "amd64"
}
```

**Load (`POST /images/load`):** Parse tar header for image name, record in images map.

**Tag (`POST /images/{name}/tag`):** Add new tag to existing image.

**Auth (`POST /auth`):** Validate credentials format, return `{"Status": "Login Succeeded"}`.

### Network operations (Spec Section 4.5)

**Create:** `POST /networks/create`
```json
{
  "Name": "github_network_abc123",
  "Labels": {"com.gitlab.gitlab-runner.managed": "true"},
  "Driver": "bridge"
}
```
Response: `{"Id": "<64-char-hex>", "Warning": ""}`

**List:** `GET /networks` with filter support: `{"label":["key=value"]}`, `{"name":["name"]}`

**Inspect:** `GET /networks/{id}` returns network details including connected containers:
```json
{
  "Name": "build-network",
  "Id": "<hex>",
  "Created": "2026-02-15T12:00:00Z",
  "Scope": "local",
  "Driver": "bridge",
  "IPAM": {
    "Driver": "default",
    "Config": [{"Subnet": "172.18.0.0/16", "Gateway": "172.18.0.1"}]
  },
  "Containers": {
    "<container-id>": { "Name": "postgres", "IPv4Address": "172.18.0.2/16" }
  },
  "Labels": {}
}
```

**Disconnect:** `POST /networks/{id}/disconnect` with `{"Container": "<id>", "Force": true}`

**Remove:** `DELETE /networks/{id}` returns `204`.

**Prune:** `POST /networks/prune` with label filter. Response: `{"NetworksDeleted": ["net1", "net2"]}`

### Volume operations (Spec Section 4.6)

**Create:** `POST /volumes/create`
```json
{
  "Name": "runner-cache",
  "Driver": "local",
  "Labels": {"com.gitlab.gitlab-runner.managed": "true"}
}
```
Response: volume object with `Name`, `Driver`, `Mountpoint`, `Labels`, `Scope`, `CreatedAt`.

**List:** `GET /volumes` returns `{"Volumes": [...], "Warnings": []}`

**Inspect:** `GET /volumes/{name}` returns volume metadata.

**Remove:** `DELETE /volumes/{name}` with optional `force` param. Returns `204`.

### Internal API endpoints (Spec Section 7.3)

| Method | Path | Operation |
|--------|------|-----------|
| `POST` | `/internal/v1/images/pull` | Pull image |
| `GET` | `/internal/v1/images/{name}` | Inspect image |
| `POST` | `/internal/v1/images/load` | Load image from tar |
| `POST` | `/internal/v1/images/{name}/tag` | Tag image |
| `POST` | `/internal/v1/auth` | Registry auth |
| `POST` | `/internal/v1/networks` | Create network |
| `GET` | `/internal/v1/networks` | List networks |
| `GET` | `/internal/v1/networks/{id}` | Inspect network |
| `POST` | `/internal/v1/networks/{id}/disconnect` | Disconnect container |
| `DELETE` | `/internal/v1/networks/{id}` | Remove network |
| `POST` | `/internal/v1/networks/prune` | Prune networks |
| `POST` | `/internal/v1/volumes` | Create volume |
| `GET` | `/internal/v1/volumes` | List volumes |
| `GET` | `/internal/v1/volumes/{name}` | Inspect volume |
| `DELETE` | `/internal/v1/volumes/{name}` | Remove volume |

---

## Acceptance Criteria

### Images

1. `POST /internal/v1/images/pull` with `fromImage` query param records the image in the store and returns a streaming JSON progress response (synthetic, immediate completion).
2. `GET /internal/v1/images/{name}` returns image metadata with `Id`, `RepoTags`, `Config` (Env, Cmd, Entrypoint, ExposedPorts, Labels, WorkingDir), `Os`, `Architecture`.
3. `GET /internal/v1/images/{name}` returns `404` if the image is not in the store.
4. `POST /internal/v1/images/load` parses the tar stream (at minimum, reads the manifest to extract image name) and records the image in the store.
5. `POST /internal/v1/images/{name}/tag` with `repo` and `tag` query params adds a new tag to an existing image. Returns `201`. Returns `404` if image not found.
6. `POST /internal/v1/auth` validates that `username`, `password`, and `serveraddress` are present in the request body. Returns `{"Status": "Login Succeeded"}`.

### Networks

7. `POST /internal/v1/networks` creates a network with `Name`, `Labels`, `Driver`, generates a 64-char hex ID, and returns `{"Id": "<id>", "Warning": ""}`.
8. `GET /internal/v1/networks` lists all networks; supports `filters` query param with `label` and `name` filters.
9. `GET /internal/v1/networks/{id}` returns network details including a `Containers` map of connected containers with their IPs and names.
10. `POST /internal/v1/networks/{id}/disconnect` removes a container from the network's membership. Returns `200`. Returns `404` if network or container not found.
11. `DELETE /internal/v1/networks/{id}` removes the network. Returns `204`. Returns `404` if not found.
12. `POST /internal/v1/networks/prune` removes networks with no connected containers, optionally filtered by label. Returns `{"NetworksDeleted": [...]}`.

### Volumes

13. `POST /internal/v1/volumes` creates a volume with `Name`, `Driver`, `Labels`. If `Name` is empty, generate a random name. Returns the full volume object with `Mountpoint` set to `/var/lib/docker/volumes/<name>/_data`.
14. `GET /internal/v1/volumes` returns `{"Volumes": [...], "Warnings": []}`.
15. `GET /internal/v1/volumes/{name}` returns volume metadata. Returns `404` if not found.
16. `DELETE /internal/v1/volumes/{name}` removes the volume. Returns `204`. Returns `404` if not found. Supports `force` query param.

### Example Requests

```bash
# Pull an image
curl --unix-socket /var/run/sockerless-backend.sock \
  -X POST "http://localhost/internal/v1/images/pull?fromImage=nginx&tag=latest"
# Expected: 200 (streaming JSON lines)
# {"status":"Pulling from library/nginx","id":"latest"}
# {"status":"Status: Downloaded newer image for nginx:latest"}

# Inspect image
curl --unix-socket /var/run/sockerless-backend.sock \
  http://localhost/internal/v1/images/nginx:latest
# Expected: 200 with image metadata JSON

# Create network
curl --unix-socket /var/run/sockerless-backend.sock \
  -X POST http://localhost/internal/v1/networks \
  -H "Content-Type: application/json" \
  -d '{"Name":"test-net","Labels":{"env":"test"}}'
# Expected: 201 {"Id":"<hex>","Warning":""}

# Create volume
curl --unix-socket /var/run/sockerless-backend.sock \
  -X POST http://localhost/internal/v1/volumes \
  -H "Content-Type: application/json" \
  -d '{"Name":"test-vol","Labels":{"env":"test"}}'
# Expected: 201 {"Name":"test-vol","Driver":"local","Mountpoint":"/var/lib/docker/volumes/test-vol/_data",...}

# Auth check
curl --unix-socket /var/run/sockerless-backend.sock \
  -X POST http://localhost/internal/v1/auth \
  -H "Content-Type: application/json" \
  -d '{"username":"user","password":"pass","serveraddress":"https://index.docker.io/v1/"}'
# Expected: 200 {"Status":"Login Succeeded"}
```

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] New black-box REST tests written for new/changed behavior (in `tests/` module)
- [ ] Tests run against memory backend by default
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Custom error types used for all domain errors (not bare `errors.New`)
- [ ] Errors wrapped with context: `fmt.Errorf("operation: %w", err)`
- [ ] Zerolog structured logging on all error paths
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` updated

### Integration
- [ ] No breaking changes to the internal API contract
- [ ] Capability model updated if new backend capabilities are added

### Task-Specific
- [ ] Image pull/inspect/load/tag lifecycle works end to end
- [ ] Network CRUD with container membership tracking works
- [ ] Volume CRUD with labels works
- [ ] Network prune correctly identifies unused networks

---

## Suggested File Paths

```
backends/memory/
├── images.go                  # ImagePull, ImageInspect, ImageLoad, ImageTag, AuthCheck handlers
├── networks.go                # NetworkCreate, NetworkList, NetworkInspect, NetworkDisconnect, NetworkRemove, NetworkPrune
├── volumes.go                 # VolumeCreate, VolumeList, VolumeInspect, VolumeRemove
└── store.go                   # (extended) image, network, volume store methods
```

---

## Notes

- For image pull, generate a synthetic `sha256` digest from the image reference (e.g., `sha256:` + hex(sha256(reference))). This gives a deterministic, unique ID for testing.
- Image config (Env, Cmd, Entrypoint) for the memory backend should be populated with sensible defaults (e.g., `Cmd: ["/bin/sh"]`, `Env: ["PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"]`). CI runners read these from image inspect.
- Network container membership: when a container is created with `NetworkingConfig.EndpointsConfig`, the container should be added to the network's `Containers` map. Use a method like `store.ConnectContainerToNetwork(networkID, containerID, aliases)`. This will be called from MEM-002's container create handler.
- Network IPAM: assign subnets from a pool (e.g., `172.18.0.0/16`, `172.19.0.0/16`, ...). Each network gets its own subnet. Container IPs are assigned sequentially within the subnet.
- Volume `Mountpoint` is a synthetic path (`/var/lib/docker/volumes/<name>/_data`) since no real filesystem is involved.
- Image load from tar: at minimum, read the `manifest.json` entry from the tar to extract image reference. For the memory backend, full layer extraction is not needed.
- The `CreatedAt` field on volumes should be RFC3339 format.
