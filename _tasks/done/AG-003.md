# AG-003: Agent attach handler

**Component:** Agent (Container agent)
**Phase:** 2
**Depends on:** AG-001
**Estimated effort:** L

---

## Description

Implement the attach handler in the sockerless agent. Attach connects to the stdio of the main process -- the original container entrypoint that the agent launched as a child. Unlike exec (which forks a new process), attach pipes the WebSocket to an already-running (or about-to-start) process. This is the primary execution mechanism for GitLab Runner, which pipes build scripts through stdin of the attached container process. The handler must support attach-before-start: the frontend may send the attach request before the main process has started, and the agent must buffer until the process is ready.

---

## Context

### Attach flow -- GitLab Runner pattern (Spec Section 8.4)

> GitLab Runner attaches BEFORE starting the container. The frontend buffers the attach until the container starts and the agent becomes reachable:
>
> ```
> GitLab Runner                Frontend                    Backend              Agent
>     |                            |                          |                   |
>     |-- POST /containers/create ->| -- POST /internal/... ->|                   |
>     | <-- {Id: "abc"} ---------- | <-- {id: "abc"} -------- |                   |
>     |                            |                          |                   |
>     |-- POST /containers/abc/    |                          |                   |
>     |   attach -----------------> | (buffer hijacked conn)  |                   |
>     |   (hijacked connection)    |                          |                   |
>     |                            |                          |                   |
>     |-- POST /containers/abc/    |                          |                   |
>     |   start ------------------>| -- POST .../start ----->| -- launch task -->|
>     |                            |                          |                   |
>     |                            | <-- {agent_address} ---- |                   |
>     |                            |                          |                   |
>     |                            | -- ws://agent:9111 ---------------------------->|
>     |                            | -- {"type":"attach"} --------------------------->|
>     |                            |                          |                   |
>     | <-- mux stdout ----------- | <-- {"type":"stdout"} ------------------------- |
>     | ---- stdin --------------->| ---- {"type":"stdin"} --------------------------->|
>     |                            |                          |                   |
>     | (connection closes on exit)|                          |                   |
> ```
>
> The frontend is responsible for:
> - Buffering the attach request until the agent is reachable
> - Translating between Docker's multiplexed stream protocol (8-byte header framing) and the agent's WebSocket JSON messages
> - Bridging the hijacked HTTP connection to the WebSocket connection

### GitLab Runner attach usage (Spec Section 13.1.3)

> **Build script execution via attach (NOT exec):**
> In the normal flow, the runner pipes the build script through the attach stdin connection. The container's `Cmd` is set to the shell command, and the script is streamed as stdin. This means **attach is the primary execution mechanism**, not exec.

### Agent entrypoint wrapping (Spec Section 8.6)

> The backend modifies the container's entrypoint to: `["/sockerless-agent", "--", <original-entrypoint>]`
>
> The agent starts the original command as a child process and serves WebSocket connections for exec/attach.

---

## Acceptance Criteria

1. When the agent receives `{"type":"attach", "id":"<id>"}`, it connects the WebSocket session to the main child process's stdin/stdout/stderr.
2. The "main child process" is the original entrypoint command that the agent started as a child (from `SOCKERLESS_ORIGINAL_ENTRYPOINT` / `SOCKERLESS_ORIGINAL_CMD` or the `--` CLI args).
3. Stdout from the main process is sent as `{"type":"stdout", "id":"<id>", "data":"<base64>"}` messages.
4. Stderr from the main process is sent as `{"type":"stderr", "id":"<id>", "data":"<base64>"}` messages.
5. When the frontend sends `{"type":"stdin", "id":"<id>", "data":"<base64>"}`, the agent writes the decoded bytes to the main process's stdin.
6. When the frontend sends `{"type":"close_stdin", "id":"<id>"}`, the agent closes the main process's stdin pipe.
7. When the main process exits, the agent sends `{"type":"exit", "id":"<id>", "code":<exit-code>}`.
8. If the attach request arrives before the main process has started (e.g., agent is in keep-alive mode or the entrypoint hasn't been exec'd yet), the agent buffers the attach session and connects it once the process starts. No error is returned for early attach.
9. If the attach request arrives after the main process has already exited, the agent sends `{"type":"exit", "id":"<id>", "code":<exit-code>}` immediately.
10. Multiple attach sessions to the same main process are supported. All attached sessions receive the same stdout/stderr output (fan-out). Stdin from any attached session is written to the process stdin (merged).
11. The `signal` message type (`{"type":"signal", "id":"<id>", "signal":"SIGTERM"}`) works on attach sessions, delivering the signal to the main process.
12. The agent starts the main child process with stdin connected to a pipe (not closed), so that the runner can write build scripts to it.
13. The agent captures stdout/stderr from the main process from the very beginning -- no output is lost between process start and attach connection.

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing tests continue to pass
- [ ] Unit tests for: attach to running process (receive stdout), attach with stdin piping, attach close_stdin triggers EOF, attach before process starts (buffered), exit code propagation from main process, multiple concurrent attach sessions (fan-out), signal delivery to main process via attach session
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Attach to nonexistent process in non-keep-alive mode returns error message
- [ ] Errors wrapped with context: `fmt.Errorf("attach session %s: %w", id, err)`
- [ ] Zerolog structured logging with session ID on all attach operations

### Documentation
- [ ] GoDoc comments on all exported types and functions
- [ ] Module `README.md` updated with attach handler details

### Integration
- [ ] Attach handler registered in the message router from AG-001
- [ ] Works correctly with the keep-alive mode from AG-005 (attach before process start)
- [ ] Main process stdout/stderr buffered from start so no output is lost

---

## Suggested File Paths

```
agent/
├── attach.go                # Attach session: connect to main process stdio
├── attach_test.go           # Unit tests for attach handler
├── process.go               # Main process management (start, track, buffer output)
├── session.go               # (update) Register attach session type in session registry
└── message.go               # (update) Add attach-related message structs if needed
```

---

## Notes

- The main process should be started with `os/exec.Command` with `Stdin`, `Stdout`, `Stderr` all set to pipes. The agent reads stdout/stderr in goroutines from the moment the process starts, buffering output in a ring buffer. When an attach session connects, it replays the buffer and then streams live output.
- The ring buffer for early output should have a configurable max size (e.g., 1MB). If the process produces more output than the buffer can hold before any attach connects, the oldest output is discarded. This prevents unbounded memory growth for long-running processes that nobody attaches to.
- Fan-out for multiple attach sessions: use a broadcast pattern. Each stdout/stderr chunk is sent to all active attach sessions. Consider using channels per session to decouple write speed from the slowest consumer.
- For the GitLab Runner pattern, the sequence is: (1) agent starts with `sockerless-agent -- sh` (shell as entrypoint), (2) frontend sends `attach` over WebSocket, (3) agent connects the attach session to the shell's stdin/stdout/stderr, (4) frontend pipes the build script through `stdin` messages, (5) shell executes the script, (6) output flows back through `stdout`/`stderr` messages, (7) shell exits, agent sends `exit` message.
- When the main process exits, the agent should continue running (to serve exec requests and health checks). Only when the agent itself receives SIGTERM should it shut down. The `--keep-alive` flag (AG-005) is the explicit version of this, but even without it, the agent stays alive after the main process exits.
- Stdin merging from multiple attach sessions is inherently racy. In practice, only one client attaches at a time (the CI runner). Document this limitation but implement simple interleaving.
