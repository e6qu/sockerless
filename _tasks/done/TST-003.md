# TST-003: Container lifecycle tests

**Component:** Test Infrastructure and Suites
**Phase:** 1
**Depends on:** TST-001, FE-004, FE-005, FE-006, FE-007, FE-011
**Estimated effort:** L

---

## Description

Comprehensive black-box tests for the container lifecycle: create, inspect, start, list, stop, kill, remove, and wait. Tests cover the happy path (full lifecycle from create to remove), error cases (duplicate names, missing images, invalid state transitions), and filtering (by label, ID, name, status). Each test is independent and cleans up after itself.

---

## Context

### Container create (Spec Section 4.3)

Request: `POST /containers/create?name=<optional>`

```json
{
  "Image": "nginx:latest",
  "Cmd": ["sh", "-c", "echo hello"],
  "Env": ["CI=true"],
  "Labels": {"test": "true"},
  "HostConfig": { "NetworkMode": "bridge" }
}
```

Response: `201 Created`
```json
{"Id": "<64-char-hex>", "Warnings": []}
```

Errors:
- `404` if image not pulled: `{"message": "No such image: nginx:latest"}`
- `409` if name in use: `{"message": "Conflict. The container name \"/myname\" is already in use"}`

### Container inspect (Spec Section 4.3)

Response includes `State` with `Status` ("created", "running", "exited"), `Running` (bool), `ExitCode` (int), `StartedAt`, `FinishedAt`.

### Container list (Spec Section 4.3)

`GET /containers/json?all=true&filters={"label":["key=value"]}`

- `all=false` (default): only running containers
- `all=true`: all containers including stopped
- Filters: `label`, `id`, `name`, `status`

### Container stop (Spec Section 4.3)

`POST /containers/{id}/stop?t=10` -- Response: `204 No Content`

### Container kill (Spec Section 4.3)

`POST /containers/{id}/kill` -- Response: `204 No Content`

### Container remove (Spec Section 4.3)

`DELETE /containers/{id}?force=true` -- Response: `204 No Content`

### Container start (Spec Section 4.3)

`POST /containers/{id}/start` -- Response: `204 No Content`
- `304 Not Modified` if already running

### Container wait (Spec Section 4.3)

`POST /containers/{id}/wait?condition=not-running`

Response (when container exits): `{"StatusCode": 0, "Error": null}`

---

## Acceptance Criteria

### Full Lifecycle

1. Test full lifecycle: create container -> inspect (state=`created`) -> start -> inspect (state=`running`, `Running: true`) -> stop -> inspect (state=`exited`, `ExitCode: 0`) -> remove -> inspect returns `404`.
2. Test that `Created` timestamp is set on create and `StartedAt` is set on start.
3. Test that `FinishedAt` is set after stop, and is after `StartedAt`.

### Create

4. Test create with a name: the name appears in inspect response prefixed with `/`.
5. Test create with duplicate name returns `409` with message containing the name.
6. Test create with an image that has not been pulled returns `404`.
7. Test create returns a 64-character hex ID.
8. Test create stores `Cmd`, `Env`, `Labels`, `WorkingDir` -- all readable via inspect.

### Start

9. Test start on a created container returns `204`.
10. Test start on an already running container returns `304 Not Modified`.
11. Test start on a non-existent container returns `404`.

### List

12. Test list with `all=false` returns only running containers (not created or exited).
13. Test list with `all=true` returns all containers including created and exited.
14. Test list with `filters={"label":["testkey=testvalue"]}` returns only matching containers.
15. Test list with `filters={"status":["running"]}` returns only running containers.
16. Test list with `filters={"name":["mycontainer"]}` returns containers with matching name prefix.
17. Test list with `filters={"id":["<prefix>"]}` returns containers with matching ID prefix.

### Stop and Kill

18. Test stop transitions container to `exited` with `ExitCode: 0`.
19. Test stop with `t=0` returns immediately.
20. Test kill transitions container to `exited` with `ExitCode: 137`.
21. Test stop on a non-running container returns `304`.
22. Test kill on a non-existent container returns `404`.

### Remove

23. Test remove on a stopped container returns `204` and container no longer appears in list.
24. Test remove on a running container without `force` returns `409`.
25. Test remove on a running container with `force=true` returns `204` (stop + remove).
26. Test remove on a non-existent container returns `404`.

### Wait

27. Test wait blocks until container stops, then returns `{"StatusCode": 0}`.
28. Test wait on a killed container returns `{"StatusCode": 137}`.

### Example Requests

```bash
# Prerequisites: pull an image first
curl --unix-socket /var/run/sockerless.sock \
  -X POST "http://localhost/images/create?fromImage=alpine&tag=latest"

# Create
curl --unix-socket /var/run/sockerless.sock \
  -X POST "http://localhost/containers/create?name=test-lifecycle" \
  -H "Content-Type: application/json" \
  -d '{"Image":"alpine:latest","Cmd":["echo","hello"],"Labels":{"test":"true"}}'
# Expected: 201 {"Id":"abc123...","Warnings":[]}

# Inspect (created)
curl --unix-socket /var/run/sockerless.sock \
  http://localhost/containers/test-lifecycle/json | jq '.State.Status'
# Expected: "created"

# Start
curl --unix-socket /var/run/sockerless.sock \
  -X POST http://localhost/containers/test-lifecycle/start
# Expected: 204

# Inspect (running)
curl --unix-socket /var/run/sockerless.sock \
  http://localhost/containers/test-lifecycle/json | jq '.State'
# Expected: {"Status":"running","Running":true,...}

# List running
curl --unix-socket /var/run/sockerless.sock \
  http://localhost/containers/json | jq '.[].Names'
# Expected: includes ["/test-lifecycle"]

# Stop
curl --unix-socket /var/run/sockerless.sock \
  -X POST "http://localhost/containers/test-lifecycle/stop?t=0"
# Expected: 204

# Remove
curl --unix-socket /var/run/sockerless.sock \
  -X DELETE http://localhost/containers/test-lifecycle
# Expected: 204

# Inspect after remove
curl --unix-socket /var/run/sockerless.sock \
  http://localhost/containers/test-lifecycle/json
# Expected: 404 {"message":"No such container: test-lifecycle"}
```

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] New black-box REST tests written for new/changed behavior (in `tests/` module)
- [ ] Tests run against memory backend by default
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Custom error types used for all domain errors (not bare `errors.New`)
- [ ] Errors wrapped with context: `fmt.Errorf("operation: %w", err)`
- [ ] Zerolog structured logging on all error paths
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` created or updated (if this task creates or modifies a module)

### Integration
- [ ] No breaking changes to the internal API contract
- [ ] Capability model updated if new backend capabilities are added

### Task-Specific
- [ ] All 28 acceptance criteria pass
- [ ] Each test creates its own containers and cleans up via `defer removeContainer(t, id)`
- [ ] Tests pass against both memory and Docker backends
- [ ] No test depends on another test's state

---

## Suggested File Paths

```
tests/
├── container_lifecycle_test.go    # TestContainerFullLifecycle, TestContainerCreate*, TestContainerStart*
├── container_list_test.go         # TestContainerList*, TestContainerListFilter*
├── container_stop_kill_test.go    # TestContainerStop*, TestContainerKill*, TestContainerRemove*
├── container_wait_test.go         # TestContainerWait*
└── helpers/
    ├── container.go               # createContainer, startContainer, stopContainer, removeContainer helpers
    └── image.go                   # pullImage helper (prerequisite for container tests)
```

---

## Notes

- Every container test needs an image to exist first. Use a test helper `pullImage(t, "alpine:latest")` at the start of each test (or in `TestMain`). The memory backend accepts any image reference; the Docker backend needs a real pull.
- Use unique container names per test (e.g., `t.Name()` + random suffix) to avoid conflicts when tests run in parallel.
- For the wait test, start a container in a goroutine, call wait in the main goroutine, then stop the container. Verify that wait unblocks with the correct exit code.
- Filter tests should create multiple containers with different labels/names, then verify the filter returns only the expected subset.
- The `all` parameter defaults to `false`. A common mistake is asserting stopped containers appear without `all=true`.
- Docker returns `304 Not Modified` for start-when-running and stop-when-stopped. Test this explicitly.
- Container IDs in Docker are 64-character hex strings. Validate the format in the create response.
