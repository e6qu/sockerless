# FE-015: Image inspect

**Component:** FE (Docker REST API frontend)
**Phase:** 1
**Depends on:** FE-014
**Estimated effort:** S

---

## Description

Implement the image inspect endpoint (`GET /images/{name}/json`). Returns image metadata from the backend's image state, which was populated during image pull (FE-014). The most critical fields are those in `Config` -- specifically `Env`, `Cmd`, `Entrypoint`, `ExposedPorts`, `Labels`, `WorkingDir`, and `Healthcheck`. GitHub Actions Runner reads `Config.Env` to extract the PATH variable for step execution, and checks `Config.Healthcheck` to determine if health polling is needed. GitLab Runner reads `Config.Env` and `Config.Cmd` for container setup.

---

## Context

### Image inspect response (Spec Section 4.2)

> `GET /images/{name}/json` -- Inspect Image
>
> Returns image metadata. For sockerless, this will be a **minimal response** constructed from the registry manifest (or cached from a previous pull):
>
> ```json
> {
>   "Id": "sha256:<digest>",
>   "RepoTags": ["nginx:latest"],
>   "RepoDigests": ["nginx@sha256:..."],
>   "Created": "2026-01-01T00:00:00Z",
>   "Size": 0,
>   "VirtualSize": 0,
>   "Config": {
>     "Env": ["PATH=/usr/local/sbin:..."],
>     "Cmd": ["nginx", "-g", "daemon off;"],
>     "Entrypoint": null,
>     "ExposedPorts": {"80/tcp": {}},
>     "Labels": {},
>     "WorkingDir": ""
>   },
>   "Os": "linux",
>   "Architecture": "amd64"
> }
> ```
>
> GitLab Runner reads `Config.Env` and `Config.Cmd` from this. If registry metadata retrieval is not available, return a minimal valid response. Image config can be fetched from the registry's manifest API without pulling layers.

### PATH extraction by GitHub Runner (Spec Section 13.2.4)

> **PATH extraction from `Config.Env`:**
> After starting a container, the runner calls `docker inspect` and reads `Config.Env` -- an array of `KEY=VALUE` strings. It iterates through the array looking for entries starting with `PATH=`. This PATH is used when constructing `docker exec` commands to find binaries inside the container. If `Config.Env` is empty or missing `PATH`, the runner may fail to locate executables.

### Health check presence detection (Spec Section 13.2.4)

> **Health check polling:**
> Uses `docker inspect --format '{{if .Config.Healthcheck}}{{print .State.Health.Status}}{{end}}'`. If `.Config.Healthcheck` is absent (no HEALTHCHECK instruction), the template outputs empty string and the runner skips health polling -- container is considered ready immediately.

### Image config from registry (Spec Section 13.3, Gap 3)

> When `POST /images/create` (pull) is called, the backend fetches the image's manifest and config blob from the registry API WITHOUT downloading any layers. The image config contains `Env`, `Cmd`, `Entrypoint`, `ExposedPorts`, `WorkingDir`, `Labels`, and `Healthcheck`. These are stored in the backend's image table.
>
> **Registry API calls needed:** `GET /v2/<name>/manifests/<tag>` -> `GET /v2/<name>/blobs/<config-digest>`. These are lightweight (config blob is typically <10KB).

---

## Acceptance Criteria

1. `GET /images/{name}/json` returns `200 OK` with the full image metadata JSON body.
2. The response includes `Id` (string, `"sha256:<hex-digest>"`), `RepoTags` (string array), `RepoDigests` (string array).
3. The response includes `Config` object with fields: `Env` (string array), `Cmd` (string array or null), `Entrypoint` (string array or null), `ExposedPorts` (object or null), `Labels` (object), `WorkingDir` (string), `Healthcheck` (object or null).
4. The `Config.Env` array contains the image's environment variables (including `PATH`) as `KEY=VALUE` strings.
5. The `Config.Healthcheck` field is present when the image defines a HEALTHCHECK instruction, and absent/null when it does not.
6. `GET /images/{name}/json` returns `404` with `{"message": "No such image: <name>"}` if the image has not been pulled.
7. The `{name}` path parameter accepts image references in multiple formats: `nginx`, `nginx:latest`, `library/nginx:latest`, `docker.io/library/nginx:latest`, `sha256:<digest>`.
8. The response includes `Created` (RFC3339 timestamp), `Size` (int64), `VirtualSize` (int64), `Os` (string), `Architecture` (string).
9. Multiple tags for the same image are all listed in `RepoTags`.
10. The `Config.Env` field is populated from the registry image config blob fetched during pull.

### Example Requests

```bash
# Inspect a pulled image
curl -s --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/images/nginx:latest/json
# Response: 200 OK
# {
#   "Id": "sha256:a1b2c3d4e5f6...",
#   "RepoTags": ["nginx:latest"],
#   "RepoDigests": ["nginx@sha256:abc123..."],
#   "Created": "2026-01-15T00:00:00Z",
#   "Size": 0,
#   "VirtualSize": 0,
#   "Config": {
#     "Env": [
#       "PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin",
#       "NGINX_VERSION=1.25.3"
#     ],
#     "Cmd": ["nginx", "-g", "daemon off;"],
#     "Entrypoint": ["/docker-entrypoint.sh"],
#     "ExposedPorts": {"80/tcp": {}},
#     "Labels": {"maintainer": "NGINX Docker Maintainers"},
#     "WorkingDir": "",
#     "Healthcheck": null
#   },
#   "Os": "linux",
#   "Architecture": "amd64"
# }

# Inspect by short name (no tag defaults to :latest)
curl -s --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/images/nginx/json
# Response: 200 OK (same as above if nginx:latest was pulled)

# Inspect an image that has not been pulled
curl -s --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/images/nonexistent:v1/json
# Response: 404
# {"message":"No such image: nonexistent:v1"}

# Inspect by digest
curl -s --unix-socket /var/run/sockerless.sock \
  http://localhost/v1.44/images/sha256:a1b2c3d4e5f6/json
# Response: 200 OK
```

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] All existing black-box REST tests continue to pass
- [ ] New black-box REST tests written for: inspect after pull (verify Config fields), inspect not found, inspect by short name, inspect by digest, multiple tags on same image
- [ ] Tests run against memory backend by default
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Custom error types used for all domain errors (NotFound)
- [ ] Errors wrapped with context: `fmt.Errorf("image inspect: %w", err)`
- [ ] Zerolog structured logging on all error paths
- [ ] HTTP error responses use Docker's format: `{"message": "..."}`

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` updated if new public API is added

### Integration
- [ ] No breaking changes to the internal API contract
- [ ] Image state from FE-014 (pull) is correctly read
- [ ] Config fields are usable by FE-004 (container create) for Env merging

---

## Suggested File Paths

```
frontends/docker/
├── handler_image_inspect.go  # GET /images/{name}/json handler
└── routes.go                 # Register new route (update existing)
```

---

## Notes

- The `{name}` path parameter in the route must handle slashes in the image name (e.g., `registry.example.com/org/repo:tag`). Use a catch-all or greedy route segment in the router.
- Docker returns `Size` and `VirtualSize` as byte counts. Sockerless can return `0` for both since it does not download layers locally. This is acceptable -- no CI runner depends on these values.
- The `Config.Healthcheck` object, when present, has the shape: `{"Test": ["CMD-SHELL", "curl -f http://localhost/"], "Interval": 30000000000, "Timeout": 10000000000, "StartPeriod": 0, "Retries": 3}`. The `Interval`, `Timeout`, and `StartPeriod` are in nanoseconds.
- GitLab Runner uses `ImageInspectWithRaw`, which returns both the parsed struct and raw JSON bytes. Sockerless only needs to return valid JSON -- the SDK handles parsing.
- If the image was pulled without registry config fetch (e.g., memory backend), `Config.Env` should default to a minimal array including a standard `PATH`. This prevents GitHub Runner from failing due to missing PATH.
- Image name lookup must be case-insensitive for the registry and repository portions (Docker registries are case-insensitive), but tag comparison is case-sensitive.
