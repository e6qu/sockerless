# SIM-002: AWS service simulator

**Component:** Simulator
**Phase:** 2
**Depends on:** SIM-001
**Estimated effort:** XL

---

## Description

Implement a simulator for the AWS services used by the Sockerless ECS and Lambda backends. The simulator must be compatible with AWS SDK Go v2 and the AWS CLI by setting `AWS_ENDPOINT_URL` or per-service endpoint overrides. Authentication accepts any valid-format AWS Signature V4 credentials without real validation.

The AWS simulator implements only the API actions that Sockerless backends actually call, across seven services: ECS, ECR, CloudWatch Logs, EFS, Cloud Map (Service Discovery), Lambda, and S3. Each service handler parses requests routed by the `X-Amz-Target` header (for JSON-based services) or by URL path (for REST-based services like EFS and S3), performs the operation against the in-memory state store, and returns responses in the exact JSON/XML format the real AWS API returns.

---

## Context

### AWS services used by Sockerless ECS backend

From ECS-001 through ECS-008, the ECS backend initializes SDK clients for and calls APIs on:

- **ECS** (from ECS-001, ECS-002): `RegisterTaskDefinition`, `RunTask`, `DescribeTasks`, `StopTask`, `ListTasks`, `CreateCluster`, `DescribeClusters`, `DeleteCluster`, `DeregisterTaskDefinition`, `DescribeTaskDefinition`
- **ECR** (from ECS-001): `GetAuthorizationToken`, `CreateRepository`, `DescribeRepositories`, `DeleteRepository`, `BatchGetImage`, `PutImage`, `DescribeImages`
- **CloudWatch Logs** (from ECS-004): `CreateLogGroup`, `DeleteLogGroup`, `DescribeLogGroups`, `CreateLogStream`, `PutLogEvents`, `GetLogEvents`, `FilterLogEvents`
- **EFS** (from ECS-008): `CreateFileSystem`, `DescribeFileSystems`, `DeleteFileSystem`, `CreateMountTarget`, `DescribeMountTargets`, `DeleteMountTarget`, `CreateAccessPoint`, `DescribeAccessPoints`, `DeleteAccessPoint`
- **Cloud Map** (from ECS-007): `CreatePrivateDnsNamespace`, `GetNamespace`, `DeleteNamespace`, `CreateService`, `GetService`, `DeleteService`, `RegisterInstance`, `DeregisterInstance`, `DiscoverInstances`

### AWS services used by Sockerless Lambda backend

- **Lambda**: `CreateFunction`, `GetFunction`, `DeleteFunction`, `UpdateFunctionCode`, `Invoke`
- **S3** (for terraform state and function code): `CreateBucket`, `HeadBucket`, `PutObject`, `GetObject`, `DeleteObject`, `ListObjectsV2`

### AWS API format details

ECS, ECR, Lambda, and CloudWatch Logs use JSON with `X-Amz-Target` header routing:
- `X-Amz-Target: AmazonEC2ContainerServiceV20141113.RunTask`
- `X-Amz-Target: AmazonEC2ContainerRegistry.GetAuthorizationToken`
- `X-Amz-Target: Logs_20140328.CreateLogGroup`
- `X-Amz-Target: AWSLambda_20150331.CreateFunction`

EFS uses REST-style paths: `POST /2015-02-01/file-systems`, `GET /2015-02-01/file-systems/{id}`.

Cloud Map uses JSON with `X-Amz-Target` header: `X-Amz-Target: Route53AutoNaming_v20170314.CreatePrivateDnsNamespace`.

S3 uses path-style (or virtual-hosted-style) with XML responses: `PUT /bucket-name`, `GET /bucket-name?list-type=2`.

All AWS responses include `x-amzn-RequestId` header with a UUID.

### ECS task state machine (from ECS-002)

Tasks transition through states: PROVISIONING -> PENDING -> RUNNING -> DEPROVISIONING -> STOPPED. The simulator must implement this state machine with configurable timers to simulate realistic startup latency.

---

## Acceptance Criteria

### ECS service
1. `CreateCluster` creates a cluster in the state store and returns it with ARN, status `ACTIVE`, and default capacity providers.
2. `DescribeClusters` returns cluster details by name or ARN. Returns `failures` array for clusters not found (not an error response).
3. `DeleteCluster` marks a cluster as `INACTIVE` and removes it from state.
4. `RegisterTaskDefinition` stores a task definition with an auto-incrementing revision number and generated ARN. Returns the full task definition with all container definitions, volumes, and network mode.
5. `DeregisterTaskDefinition` marks a task definition revision as `INACTIVE`.
6. `DescribeTaskDefinition` returns a task definition by family, family:revision, or ARN.
7. `RunTask` creates a task in `PROVISIONING` state. The task transitions PROVISIONING -> PENDING -> RUNNING on a timer (configurable, default 2s per transition). Each task gets a unique ARN, a simulated ENI attachment with a private IPv4 address from a configurable subnet.
8. `DescribeTasks` returns task details including current status, attachments (with ENI details and `privateIPv4Address`), containers, and stop reason (if stopped).
9. `StopTask` transitions a task to `DEPROVISIONING` -> `STOPPED` with the provided stop reason.
10. `ListTasks` returns task ARNs filtered by cluster, family, service, container instance, and desired status.

### ECR service
11. `GetAuthorizationToken` returns a base64-encoded dummy authorization token (`AWS:password`) with a proxy endpoint and expiration time.
12. `CreateRepository` creates a repository in state with a generated ARN and registry ID.
13. `DescribeRepositories` returns repositories filtered by names or registry ID.
14. `DeleteRepository` removes a repository from state. If `force=false` and images exist, returns `RepositoryNotEmptyException`.
15. `BatchGetImage` returns image manifests and metadata for the requested image IDs.
16. `PutImage` stores an image manifest in a repository. Returns `ImageAlreadyExistsException` if the tag already exists with a different digest.
17. `DescribeImages` returns image details for a repository, filtered by image IDs.

### CloudWatch Logs service
18. `CreateLogGroup` creates a log group in state with the specified name, tags, and retention policy.
19. `DeleteLogGroup` removes a log group and all its streams from state.
20. `DescribeLogGroups` returns log groups filtered by prefix.
21. `CreateLogStream` creates a log stream within a log group.
22. `PutLogEvents` appends log events (timestamp + message) to a log stream. Returns a `nextSequenceToken`.
23. `GetLogEvents` returns log events from a stream with forward/backward pagination tokens. Supports `startTime`, `endTime`, `limit`, and `startFromHead` parameters.
24. `FilterLogEvents` returns events matching a filter pattern across one or more log streams. Supports `filterPattern`, `startTime`, `endTime`, and `limit`.

### EFS service
25. `CreateFileSystem` creates a filesystem in state with a generated ID (`fs-XXXXXXXX`), lifecycle state `creating` -> `available` (timer-based).
26. `DescribeFileSystems` returns filesystems filtered by ID or creation token.
27. `DeleteFileSystem` removes a filesystem (fails if mount targets exist).
28. `CreateMountTarget` creates a mount target for a filesystem in a specified subnet.
29. `DescribeMountTargets` returns mount targets filtered by filesystem ID or mount target ID.
30. `DeleteMountTarget` removes a mount target.
31. `CreateAccessPoint` creates an access point with root directory path, POSIX user, and creation info. Returns an access point ID (`fsap-XXXXXXXX`).
32. `DescribeAccessPoints` returns access points filtered by filesystem ID or access point ID.
33. `DeleteAccessPoint` removes an access point from state.

### Cloud Map service
34. `CreatePrivateDnsNamespace` creates a namespace in state with an operation ID. The operation transitions to `SUBMITTED` -> `SUCCESS` on a timer.
35. `GetNamespace` returns namespace details by ID.
36. `DeleteNamespace` removes a namespace (fails if services exist).
37. `CreateService` creates a service within a namespace with DNS configuration.
38. `GetService` returns service details by ID.
39. `DeleteService` removes a service (fails if instances exist).
40. `RegisterInstance` registers a service instance with attributes (e.g., `AWS_INSTANCE_IPV4`).
41. `DeregisterInstance` removes a service instance.
42. `DiscoverInstances` returns healthy instances for a namespace and service, filtered by query parameters and optional health status.

### Lambda service
43. `CreateFunction` creates a function in state with a generated ARN, status `Pending` -> `Active`.
44. `GetFunction` returns function configuration and code location.
45. `DeleteFunction` removes a function from state.
46. `UpdateFunctionCode` updates the function's code reference and transitions status to `Pending` -> `Active`.
47. `Invoke` executes a simulated invocation: accepts a JSON payload, returns a configurable response (default `{"statusCode": 200}`), and stores the invocation in a log for test assertions.

### S3 service (minimal)
48. `CreateBucket` (PUT /{bucket}) creates a bucket in state. Returns 200 with `Location` header.
49. `HeadBucket` returns 200 if bucket exists, 404 if not.
50. `PutObject` stores an object (key + body + metadata) in state under the specified bucket.
51. `GetObject` returns an object's body and metadata. Returns 404 (`NoSuchKey`) if not found.
52. `DeleteObject` removes an object from state. Returns 204 (even if object did not exist, matching S3 behavior).
53. `ListObjectsV2` returns objects in a bucket with prefix filtering, delimiter support, and continuation tokens.

### General
54. All responses include `x-amzn-RequestId` header with a generated UUID.
55. Error responses use the AWS JSON error format: `{"__type": "ErrorCode", "message": "..."}` with appropriate HTTP status codes.
56. The task state machine advances automatically via background goroutines with configurable transition delays.
57. Resource ARNs follow the real AWS format: `arn:aws:<service>:<region>:<account>:<resource-type>/<resource-id>`.

---

## Definition of Done

### Code Quality
- [ ] Code compiles: `go build ./...` passes with zero errors
- [ ] Lint passes: `golangci-lint run ./...` with zero warnings
- [ ] Vet passes: `go vet ./...` with zero warnings
- [ ] Race detector: `go test -race ./...` passes
- [ ] No new lint warnings introduced

### Testing
- [ ] Unit tests for each service: CRUD operations, state machine transitions, error cases (not found, already exists, conflicts), pagination, filtering
- [ ] Tests use AWS SDK Go v2 as the client (proving SDK compatibility)
- [ ] Tests verify exact response format (JSON field names, nesting, types)
- [ ] Tests for ECS task state machine: transitions happen on schedule, DescribeTasks reflects current state
- [ ] Tests for CloudWatch log pagination and filtering
- [ ] Tests for S3 ListObjectsV2 prefix/delimiter behavior
- [ ] Tests are deterministic (no flaky tests)

### Error Handling
- [ ] Unknown actions return `UnknownOperationException` with 400 status
- [ ] Missing required fields return `ValidationException` with descriptive message
- [ ] Resource not found returns the service-specific exception (e.g., `ClusterNotFoundException`, `ResourceNotFoundException`)
- [ ] Errors wrapped with context: `fmt.Errorf("aws-sim: ecs: %w", err)`
- [ ] Zerolog structured logging on all error paths

### Documentation
- [ ] GoDoc comments on all exported types, functions, methods, and constants
- [ ] Module `README.md` with supported API actions, SDK configuration, and limitations

### Integration
- [ ] All services accessible via a single HTTP server (routed by `X-Amz-Target` or URL path)
- [ ] State store shared across services where appropriate (e.g., ECS tasks reference ECR images)
- [ ] Configurable state machine timers for CI speed (set to 0 for instant transitions in tests)

---

## Suggested File Paths

```
simulators/aws/
├── go.mod
├── go.sum
├── README.md
├── router.go              # X-Amz-Target and path-based routing to service handlers
├── ecs.go                 # ECS service: clusters, task definitions, tasks
├── ecs_state.go           # ECS task state machine (background goroutines)
├── ecr.go                 # ECR service: repositories, images, auth tokens
├── cloudwatch.go          # CloudWatch Logs: log groups, streams, events
├── efs.go                 # EFS: filesystems, mount targets, access points
├── cloudmap.go            # Cloud Map: namespaces, services, instances
├── lambda.go              # Lambda: functions, invocations
├── s3.go                  # S3: buckets, objects (XML responses)
├── arn.go                 # ARN generation helpers
├── cmd/
│   └── main.go            # AWS simulator binary entrypoint
└── *_test.go              # Tests per service using AWS SDK Go v2
```

---

## Notes

- ARN format: `arn:aws:ecs:us-east-1:123456789012:task/cluster-name/task-id`. Use a configurable default account ID (e.g., `123456789012`) and region (e.g., `us-east-1`).
- ECS task ENI simulation: when a task is created via `RunTask`, generate a random private IP from a configurable subnet (e.g., `10.0.0.0/16`). Store this in the task's attachments so `DescribeTasks` returns the correct `privateIPv4Address` in the ENI attachment details. This is critical for the ECS backend's agent address resolution.
- S3 is the only service that uses XML responses. Use `encoding/xml` for S3 responses and `encoding/json` for all other services.
- CloudWatch `GetLogEvents` pagination: the `nextForwardToken` should be the timestamp of the last event returned. If no new events exist, the token is the same as the request token (this is how the real API signals "no more data").
- Cloud Map `CreatePrivateDnsNamespace` is async. Return an operation ID and implement `GetOperation` to poll for completion. Use a short timer (default 100ms in test mode) for the operation to complete.
- Lambda `Invoke` does not execute real code. It stores the invocation payload and returns a configurable response. Tests can pre-configure responses per function or use a default response.
- The ECS task state machine should be configurable per-test: a test can set transition delays to 0 for instant state changes, or to realistic values for testing polling behavior.
- Consider implementing `SIM_AWS_REGION` and `SIM_AWS_ACCOUNT_ID` environment variables to configure the simulated region and account ID used in ARNs.
