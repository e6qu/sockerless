# TF-002: ECS Terraform module

**Component:** Terraform
**Phase:** 2
**Depends on:** TF-001
**Estimated effort:** L

---

## Description

Create the Terraform module that provisions all AWS infrastructure required by the ECS Fargate backend. This module is used by the `ecs-test` environment (TF-003) and any production ECS deployments. The module creates the complete networking stack (VPC, subnets, NAT), compute infrastructure (ECS Fargate cluster), shared storage (EFS), logging (CloudWatch), service discovery (Cloud Map), IAM roles, and security groups. Every resource the ECS backend binary (ECS-001 through ECS-008) expects to exist at runtime is created by this module.

---

## Context

### ECS backend infrastructure requirements

The ECS backend (see ECS-001) requires these AWS resources to be pre-provisioned:

```yaml
ecs:
  region: us-east-1
  cluster: sockerless                    # ECS Fargate cluster
  subnets: ["subnet-abc123"]            # Private subnets for Fargate tasks
  security_groups: ["sg-abc123"]        # Default task security group
  task_role_arn: "arn:aws:iam::..."     # IAM role assumed by running tasks
  execution_role_arn: "arn:aws:iam::..."# IAM role for ECS agent (pull images, write logs)
  efs_filesystem_id: "fs-abc123"        # EFS for shared volumes
  log_group: /sockerless/containers     # CloudWatch log group
```

### Networking requirements (ECS-007)

- VPC with private subnets for Fargate tasks (tasks get private IPs via ENI in `awsvpc` mode)
- NAT Gateway for outbound internet access (image pulls from Docker Hub, registry auth)
- Security group with self-referencing ingress rule for inter-container communication
- Security group allowing inbound TCP port 9111 from frontend for agent connectivity
- AWS Cloud Map private DNS namespace for service discovery (DNS alias resolution)

### Volume requirements (ECS-008)

- EFS filesystem with mount targets in every private subnet where Fargate tasks run
- Security group for EFS mount targets allowing NFS (port 2049) from task security group
- Transit encryption enabled for EFS

### Container operations requirements (ECS-002)

- ECS Fargate cluster (no EC2 instances to manage)
- IAM execution role with permissions to pull images from ECR and write to CloudWatch Logs
- IAM task role with permissions for EFS access (if tasks need to access EFS directly)
- CloudWatch Logs log group with configurable retention

### Image operations requirements (ECS-006)

- ECR repository for storing the sockerless-agent image and any loaded images
- ECR lifecycle policy for cleanup of untagged images

### Agent connectivity (Spec Section 9.1)

> Fargate tasks get private IPs in the configured VPC. The frontend must be able to reach these IPs (same VPC, VPC peering, or transit gateway). Agent listens on port 9111 -- security group must allow inbound from frontend.

---

## Acceptance Criteria

### VPC and Networking
1. The module creates a VPC with a configurable CIDR block (default `10.0.0.0/16`).
2. Public subnets are created in each configured AZ (default 2 AZs) with auto-assigned public IPs for NAT Gateway placement.
3. Private subnets are created in each configured AZ. Fargate tasks run in these subnets.
4. A NAT Gateway is created in one public subnet (configurable: one per AZ for HA, or single for cost savings). Private subnet route tables route `0.0.0.0/0` through the NAT Gateway.
5. An Internet Gateway is attached to the VPC for public subnet internet access.
6. The number of AZs, subnet CIDR blocks, and NAT Gateway count are configurable via variables.

### ECS Cluster
7. An ECS Fargate cluster is created with a configurable name (default `sockerless`).
8. Container Insights is enabled on the cluster for monitoring (configurable, default enabled).

### EFS Filesystem
9. An EFS filesystem is created with configurable performance mode (default `generalPurpose`) and throughput mode (default `bursting`).
10. EFS mount targets are created in every private subnet so Fargate tasks in any AZ can mount volumes.
11. A dedicated security group for EFS mount targets allows inbound NFS (TCP port 2049) only from the task security group.
12. EFS encryption at rest is enabled (default `true`, configurable).

### CloudWatch Logs
13. A CloudWatch Logs log group is created with a configurable name (default `/sockerless/containers`) and configurable retention period (default 30 days).

### Cloud Map
14. A Cloud Map private DNS namespace is created and associated with the VPC. The namespace name is configurable (default `sockerless.local`).

### IAM Roles
15. An ECS task execution role is created with the `AmazonECSTaskExecutionRolePolicy` managed policy and permissions to pull from ECR and write to the configured CloudWatch log group.
16. An ECS task role is created with least-privilege permissions: EFS client mount (`elasticfilesystem:ClientMount`, `elasticfilesystem:ClientWrite`, `elasticfilesystem:DescribeMountTargets`), CloudWatch Logs write access for the log group, and Cloud Map instance registration (`servicediscovery:RegisterInstance`, `servicediscovery:DeregisterInstance`).
17. Both IAM roles use `ecs-tasks.amazonaws.com` as the trusted principal in their assume role policy.
18. IAM policies follow the principle of least privilege: resource ARNs are scoped to the specific resources created by this module (not wildcard `*`).

### Security Groups
19. A task security group is created allowing: (a) all inbound traffic from itself (self-referencing rule for inter-container communication), (b) inbound TCP port 9111 from a configurable CIDR or security group (for agent connectivity from the frontend), (c) all outbound traffic.
20. The EFS security group (AC #11) and the task security group are separate resources with clearly scoped rules.

### ECR Repository
21. An ECR repository is created (optional, default enabled) for storing the sockerless-agent image and loaded container images.
22. An ECR lifecycle policy is configured to expire untagged images after a configurable number of days (default 7).

### Module Interface
23. All configurable parameters are exposed as variables with `description`, `type`, `default`, and `validation` blocks where appropriate.
24. Key outputs are exported: `vpc_id`, `private_subnet_ids`, `public_subnet_ids`, `ecs_cluster_arn`, `ecs_cluster_name`, `efs_filesystem_id`, `log_group_name`, `log_group_arn`, `cloud_map_namespace_id`, `cloud_map_namespace_arn`, `execution_role_arn`, `task_role_arn`, `task_security_group_id`, `efs_security_group_id`, `ecr_repository_url`.
25. `terraform plan` produces no errors when run against the module with default variable values.
26. All resources are tagged with the standard Sockerless tags: `project`, `environment`, `component = "ecs"`, `managed-by = "terraform"`.

---

## Definition of Done

### Code Quality
- [ ] `terraform fmt -check` passes with zero formatting differences on all module files
- [ ] `terraform validate` passes with zero errors
- [ ] No deprecated resource types or attributes used
- [ ] HCL follows HashiCorp style conventions (2-space indent, sorted arguments)

### Testing
- [ ] `terraform init` and `terraform validate` succeed in the module directory
- [ ] `terraform plan` with default variable values produces no errors (requires AWS credentials or `-target` scoping)
- [ ] Variable validation blocks reject invalid inputs (e.g., invalid CIDR, retention < 1 day)
- [ ] Module can be instantiated multiple times in the same AWS account with different names (no hard-coded resource names)

### Documentation
- [ ] All variables have `description` fields
- [ ] All outputs have `description` fields
- [ ] Module header comment in `main.tf` describes purpose, usage, and prerequisites
- [ ] README section in `terraform/README.md` updated with ECS module usage example

### Integration
- [ ] Output values match the configuration keys expected by the ECS backend (ECS-001): `cluster`, `subnets`, `security_groups`, `execution_role_arn`, `task_role_arn`, `efs_filesystem_id`, `log_group`
- [ ] Security group rules allow the connectivity patterns required by ECS-002 (agent on port 9111), ECS-007 (inter-container via self-referencing SG), and ECS-008 (EFS via NFS port 2049)
- [ ] Cloud Map namespace can be used by ECS-007 for service discovery
- [ ] No breaking changes to the TF-001 scaffold structure

---

## Suggested File Paths

```
terraform/modules/ecs/
├── main.tf              # VPC, subnets, IGW, NAT, route tables, ECS cluster
├── variables.tf         # All input variables with descriptions and defaults
├── outputs.tf           # All exported outputs with descriptions
├── versions.tf          # Terraform >= 1.5, AWS provider ~> 5.0
├── efs.tf               # EFS filesystem, mount targets, security group
├── iam.tf               # Execution role, task role, policies
├── security_groups.tf   # Task security group, EFS security group
├── cloudwatch.tf        # Log group with retention
├── cloudmap.tf          # Private DNS namespace
├── ecr.tf               # ECR repository and lifecycle policy
└── locals.tf            # Merged tags, computed values
```

---

## Notes

- NAT Gateway pricing is significant (~$32/month per gateway + data transfer). For test environments, a single NAT Gateway is sufficient. For production, one per AZ provides high availability. The variable `nat_gateway_count` controls this: `1` for cost savings, or match the AZ count for HA.
- EFS mount targets must exist in each private subnet before Fargate tasks can mount volumes. If a task runs in a subnet without a mount target, it will fail to start with a mount timeout error.
- The self-referencing security group rule is critical: it allows all containers on the same "network" (security group) to communicate on any port. This emulates Docker's bridge network behavior where containers on the same network can reach each other.
- The execution role needs `ecr:GetAuthorizationToken`, `ecr:BatchCheckLayerAvailability`, `ecr:GetDownloadUrlForLayer`, `ecr:BatchGetImage`, `logs:CreateLogStream`, and `logs:PutLogEvents`. The AWS-managed `AmazonECSTaskExecutionRolePolicy` provides these, but scoping to specific ECR repos and log groups is more secure.
- Consider using `aws_ecs_cluster_capacity_providers` to configure Fargate and Fargate Spot capacity providers. Spot can reduce costs for CI workloads that tolerate interruption.
- Cloud Map namespace creation in Terraform is synchronous (unlike the Cloud Map API which is async). Terraform handles polling internally.
- The VPC CIDR should be large enough for the expected number of concurrent Fargate tasks. Each task consumes one private IP. A `/16` VPC with two `/20` private subnets provides ~8,190 IPs -- sufficient for most CI workloads.
- EFS throughput scales with filesystem size in bursting mode. New filesystems start with a burst credit balance. For CI workloads with heavy initial I/O, consider provisioned throughput mode if burst credits are exhausted quickly.
- IAM policy conditions can further restrict access. For example, the task role's EFS permissions can include a condition on `elasticfilesystem:AccessPointArn` to limit which access points a task can mount. This is an advanced hardening step that can be added later.
