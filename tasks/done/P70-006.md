# P70-006: AWS — Smoke Test (ECS + Lambda Against Simulator)

**Component:** SIM (simulators/aws)
**Phase:** 70 — Milestone 1 (AWS Fidelity)
**Depends on:** P70-001, P70-002, P70-003, P70-005
**Estimated effort:** L

---

## Description

End-to-end integration test that starts the AWS simulator, exercises the ECS
backend's handler chain (create → start → logs → stop → remove), and verifies
that logs are retrievable via CloudWatch. Same for the Lambda backend. This
validates the full path: backend SDK calls → simulator API → state → log query.

## Context

- ECS backend calls: RegisterTaskDefinition, RunTask, DescribeTasks, GetLogEvents, StopTask, DeregisterTaskDefinition
- Lambda backend calls: CreateFunction, Invoke, DescribeLogStreams, GetLogEvents, DeleteFunction
- All simulator fixes from P70-001 through P70-005 should be in place

## Acceptance Criteria

1. Test starts AWS simulator on a free port
2. ECS flow: RegisterTaskDefinition → RunTask → wait for RUNNING → GetLogEvents
   (verify at least one log entry) → StopTask → DescribeTasks (verify STOPPED
   with ExitCode and StopCode) → DeregisterTaskDefinition
3. Lambda flow: CreateFunction → Invoke → DescribeLogStreams (verify stream
   exists) → GetLogEvents (verify log entries) → DeleteFunction
4. ECR flow: GetAuthorizationToken (verify base64 token returned)
5. All assertions pass
6. Test is self-contained (no external dependencies beyond the simulator binary)

## Definition of Done

- [ ] `go build ./...` passes
- [ ] All existing SDK tests pass
- [ ] New integration test passes
- [ ] PR created via `gh pr create`, CI passes, merged via `gh pr merge`

## Suggested File Paths

- `simulators/aws/sdk-tests/integration_test.go` — new file
- Or extend existing test files with `TestIntegration_` prefix

## Notes

- Use the same TestMain pattern (build binary, find port, start server)
- The test doesn't need a real ECS/Lambda backend — it calls the simulator
  directly using AWS SDK, simulating what the backend would do
- Set reasonable timeouts (the simulator auto-stops tasks after 3s)
