# P70-013: Azure — KQL Query Parser for Backend Patterns

**Component:** SIM (simulators/azure)
**Phase:** 70 — Milestone 3 (Azure Fidelity)
**Depends on:** —
**Estimated effort:** L

---

## Description

Extend the Azure simulator's `monitor.go` KQL parser to handle the exact
query patterns the ACA and Azure Functions backends send:

```kql
ContainerAppConsoleLogs_CL | where ContainerGroupName_s == 'myjob' | where TimeGenerated > datetime(2024-01-01T00:00:00Z) | take 100
```

```kql
AppTraces | where AppRoleName == 'my-function' | take 50
```

The current parser only handles basic `where field == 'value'` and `take N`.
It needs to additionally handle `datetime()` function, `>` operator, and
multiple piped `where` clauses.

## Context

- `simulators/azure/monitor.go`: simplified KQL parser
- ACA backend `backends/aca/logs.go:91`: sends query for `ContainerAppConsoleLogs_CL`
- Azure Functions backend `backends/azure-functions/logs.go:57`: sends query for `AppTraces`

## Acceptance Criteria

1. Parser handles pipe-separated stages: `Table | where ... | where ... | take N`
2. Parser handles `where Field == 'value'` (string equality)
3. Parser handles `where Field > datetime(RFC3339)` (timestamp comparison)
4. Parser handles `where Field >= datetime(RFC3339)`
5. Parser handles `take N` and `limit N`
6. Table name extracted correctly (used to look up log store)
7. Multiple `where` clauses are AND'd together
8. Returns rows matching all criteria, limited by take/limit
9. Column names in response match the table schema (TimeGenerated,
   ContainerGroupName_s, Log_s for ContainerAppConsoleLogs_CL; TimeGenerated,
   Message, AppRoleName for AppTraces)
10. Existing CLI tests pass unchanged
11. New SDK test verifies KQL parsing

## Definition of Done

- [ ] `go build ./...` passes
- [ ] `go vet ./...` passes
- [ ] All existing tests pass
- [ ] New SDK test passes
- [ ] PR created via `gh pr create`, CI passes, merged via `gh pr merge`

## Suggested File Paths

- `simulators/azure/monitor.go` — extend KQL parser (or extract to `kql.go`
  if >100 lines)
- `simulators/azure/sdk-tests/monitor_test.go` — new test

## Notes

- Only need to support patterns the backends actually send — not full KQL
- `datetime()` can be parsed by stripping the function wrapper and parsing
  the inner string as RFC3339
- Consider table-specific schemas stored as maps for column validation
