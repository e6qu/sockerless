# P70-007: GCP — Cloud Logging Structured Filter Parser

**Component:** SIM (simulators/gcp)
**Phase:** 70 — Milestone 2 (GCP Fidelity)
**Depends on:** —
**Estimated effort:** L

---

## Description

Replace the substring-based filter matching in `logging.go:161-169` with a
proper structured filter parser. The Cloud Run and Cloud Functions backends
send filters like:

```
resource.type="cloud_run_job" AND resource.labels.job_name="my-job" AND timestamp>"2024-01-01T00:00:00Z"
```

The current `strings.Contains` approach cannot parse field paths, equality
operators, or timestamp comparisons.

## Context

- `simulators/gcp/logging.go:161-169`: `filterMatch` uses `strings.Contains`
  on `logName`, `severity`, `textPayload` — does not parse structured filters
- Cloud Run backend `logs.go:103`: sends `resource.type="cloud_run_job" AND
  resource.labels.job_name="{name}" [AND timestamp>"{time}"]`
- Cloud Functions backend `logs.go:59`: sends `resource.type="cloud_run_revision"
  AND resource.labels.service_name="{name}"`
- Real GCP filter syntax: https://cloud.google.com/logging/docs/view/logging-query-language

## Acceptance Criteria

1. Filter parser handles `field="value"` equality (string comparison)
2. Filter parser handles `AND` conjunction (all clauses must match)
3. Filter parser handles `field>"value"` for timestamp comparisons
4. Filter parser handles `field>="value"` for timestamp comparisons
5. Dot-notation field paths resolve correctly:
   - `resource.type` → entry's ResourceType field
   - `resource.labels.job_name` → entry's ResourceLabels["job_name"]
   - `timestamp` → entry's Timestamp
6. Unrecognized fields are ignored (no error, clause treated as non-matching)
7. Empty filter returns all entries (backward compatible)
8. Existing CLI tests pass unchanged
9. New SDK test verifies structured filter matching

## Definition of Done

- [ ] `go build ./...` passes
- [ ] `go vet ./...` passes
- [ ] All existing tests pass
- [ ] New SDK test passes
- [ ] PR created via `gh pr create`, CI passes, merged via `gh pr merge`

## Suggested File Paths

- `simulators/gcp/logging.go` — rewrite `filterMatch`; add filter parser
  (if >100 lines, extract to `simulators/gcp/logfilter.go`)
- `simulators/gcp/sdk-tests/logging_test.go` — new test

## Notes

- Only need to support the patterns the backends actually send — not the full
  GCP filter language. AND, field="value", field>"value", dot paths.
- LogEntry struct may need `ResourceType`, `ResourceLabels` fields added if
  not already present
- Consider storing entries with resource metadata so filter can match on it
