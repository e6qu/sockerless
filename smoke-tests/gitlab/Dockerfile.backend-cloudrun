FROM golang:1.25 AS builder

# Build simulator
WORKDIR /sim
COPY simulators/gcp/ /sim/
RUN GOWORK=off go build -o /simulator-gcp .

# Build backend
WORKDIR /src
COPY api/ api/
COPY agent/ agent/
COPY sandbox/ sandbox/
COPY backends/core/ backends/core/
COPY backends/cloudrun/ backends/cloudrun/
RUN cd backends/cloudrun && GOWORK=off go mod download && GOWORK=off go build -tags noui -o /sockerless-backend-cloudrun ./cmd/sockerless-backend-cloudrun

FROM debian:bookworm-slim
RUN apt-get update && apt-get install -y --no-install-recommends curl && rm -rf /var/lib/apt/lists/*
COPY --from=builder /simulator-gcp /usr/local/bin/simulator-gcp
COPY --from=builder /sockerless-backend-cloudrun /usr/local/bin/sockerless-backend-cloudrun
COPY smoke-tests/gitlab/start-with-sim.sh /start-with-sim.sh
RUN chmod +x /start-with-sim.sh
ENTRYPOINT ["/start-with-sim.sh"]
