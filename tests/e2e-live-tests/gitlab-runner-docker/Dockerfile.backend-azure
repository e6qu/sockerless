FROM golang:1.24 AS builder

# --- Build Azure simulator ---
WORKDIR /sim-azure
COPY simulators/azure/ /sim-azure/
RUN GOWORK=off go build -o /out/simulator-azure .

# --- Copy shared source for backends ---
WORKDIR /src
COPY api/ api/
COPY agent/ agent/
COPY sandbox/ sandbox/
COPY backends/core/ backends/core/

# --- Build Azure backends (aca + azf) ---
COPY backends/aca/ backends/aca/
RUN cd backends/aca && GOWORK=off go mod download && \
    GOWORK=off go build -o /out/sockerless-backend-aca ./cmd/sockerless-backend-aca

COPY backends/azure-functions/ backends/azure-functions/
RUN cd backends/azure-functions && GOWORK=off go mod download && \
    GOWORK=off go build -o /out/sockerless-backend-azf ./cmd/sockerless-backend-azf

# --- Build frontend ---
COPY frontends/docker/ frontends/docker/
RUN cd frontends/docker && GOWORK=off go mod download && \
    GOWORK=off go build -o /out/sockerless-frontend-docker ./cmd

# --- Build agent ---
RUN cd agent && GOWORK=off go mod download && \
    GOWORK=off go build -o /out/sockerless-agent ./cmd/sockerless-agent

# --- Runtime stage ---
FROM debian:bookworm-slim
RUN apt-get update && apt-get install -y --no-install-recommends curl && rm -rf /var/lib/apt/lists/*

COPY --from=builder /out/ /usr/local/bin/
COPY tests/e2e-live-tests/lib.sh /app/lib.sh
COPY tests/e2e-live-tests/start-backend.sh /app/start-backend.sh
RUN chmod +x /app/*.sh

ENTRYPOINT ["/app/start-backend.sh"]
