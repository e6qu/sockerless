name: shell-features
on: push
jobs:
  test:
    runs-on: ubuntu-latest
    container:
      image: alpine:latest
    steps:
      - name: Variable expansion
        env:
          MY_VAR: "hello"
        run: |
          test "$MY_VAR" = "hello"
          test "${MY_VAR}" = "hello"
          test "${UNSET_VAR:-default_val}" = "default_val"
          test "${MY_VAR:+alt_val}" = "alt_val"
          test -z "${UNSET_VAR:+alt_val}"

      - name: Command substitution
        run: |
          RESULT=$(echo "computed")
          test "$RESULT" = "computed"
          NESTED=$(echo "$(echo "deep")")
          test "$NESTED" = "deep"

      - name: Pipes and redirects
        run: |
          echo "line1" > /tmp/sf-pipe.txt
          echo "line2" >> /tmp/sf-pipe.txt
          COUNT=$(cat /tmp/sf-pipe.txt | wc -l | tr -d ' ')
          test "$COUNT" = "2"
          echo "stderr-test" 2>&1 | grep -q "stderr-test"

      - name: Conditionals
        run: |
          echo "marker" > /tmp/sf-cond.txt
          if [ -f /tmp/sf-cond.txt ]; then
            RESULT="exists"
          else
            RESULT="missing"
          fi
          test "$RESULT" = "exists"
          if [ ! -f /tmp/sf-nonexistent.txt ]; then
            RESULT="correct"
          fi
          test "$RESULT" = "correct"

      - name: Loops
        run: |
          CONCAT=""
          for i in a b c; do
            CONCAT="${CONCAT}${i}"
          done
          test "$CONCAT" = "abc"

      - name: Arithmetic expansion
        run: |
          X=5
          Y=$((X + 3))
          test "$Y" = "8"
          Z=$((Y * 2))
          test "$Z" = "16"

      - name: set -e behavior
        run: |
          set -e
          true
          echo "set-e-ok" > /tmp/sf-sete.txt
          test "$(cat /tmp/sf-sete.txt)" = "set-e-ok"
