FROM golang:1.24 AS builder

# --- Copy shared source for backends ---
WORKDIR /src
COPY api/ api/
COPY sandbox/ sandbox/
COPY backends/core/ backends/core/

# --- Build memory backend only ---
COPY backends/memory/ backends/memory/
RUN cd backends/memory && GOWORK=off go mod download && \
    GOWORK=off go build -o /out/sockerless-backend-memory ./cmd

# --- Build frontend ---
COPY frontends/docker/ frontends/docker/
RUN cd frontends/docker && GOWORK=off go mod download && \
    GOWORK=off go build -o /out/sockerless-frontend-docker ./cmd

# --- Runtime stage ---
FROM golang:1.24

RUN apt-get update && apt-get install -y --no-install-recommends curl && rm -rf /var/lib/apt/lists/*
RUN go install github.com/nektos/act@latest

# Copy all binaries
COPY --from=builder /out/ /usr/local/bin/

# Copy test scripts and workflows
COPY tests/e2e-live-tests/lib.sh /test/lib.sh
COPY tests/e2e-live-tests/start-backend.sh /test/start-backend.sh
COPY tests/e2e-live-tests/github-runner/run.sh /test/run.sh
COPY tests/e2e-live-tests/github-runner/workflows/ /test/workflows/
RUN chmod +x /test/*.sh

WORKDIR /test
ENTRYPOINT ["/test/run.sh"]
