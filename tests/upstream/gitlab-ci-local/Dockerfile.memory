FROM golang:1.24 AS builder

# --- Copy shared source for backends ---
WORKDIR /src
COPY api/ api/
COPY sandbox/ sandbox/
COPY backends/core/ backends/core/

# --- Build memory backend only ---
COPY backends/memory/ backends/memory/
RUN cd backends/memory && GOWORK=off go mod download && \
    GOWORK=off go build -o /out/sockerless-backend-memory ./cmd

# --- Build frontend ---
COPY frontends/docker/ frontends/docker/
RUN cd frontends/docker && GOWORK=off go mod download && \
    GOWORK=off go build -o /out/sockerless-frontend-docker ./cmd

# --- Runtime stage ---
FROM node:22-bookworm-slim

# Install git, rsync, curl + build tools (for node-gyp/re2)
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl git ca-certificates rsync bash python3 make g++ unzip && \
    rm -rf /var/lib/apt/lists/*

# Install Docker CLI only (no daemon)
RUN ARCH=$(dpkg --print-architecture) && \
    case "$ARCH" in \
      amd64) DOCKER_ARCH=x86_64 ;; \
      arm64) DOCKER_ARCH=aarch64 ;; \
      *) echo "Unsupported arch: $ARCH" && exit 1 ;; \
    esac && \
    curl -fsSL "https://download.docker.com/linux/static/stable/${DOCKER_ARCH}/docker-27.5.1.tgz" | \
    tar xz --strip-components=1 -C /usr/local/bin docker/docker

# Install Bun (for package management)
RUN curl -fsSL https://bun.sh/install | BUN_INSTALL=/usr/local bash -s "bun-v1.1.45"

# Install gitlab-ci-local via bun (re2 native module compiled against Node.js)
ENV PATH="/root/.bun/bin:$PATH"
RUN bun install -g --trust gitlab-ci-local@4.57.0

# Build re2 native module explicitly
RUN cd /root/.bun/install/global/node_modules/re2 && \
    npm rebuild re2

# Copy Sockerless binaries
COPY --from=builder /out/ /usr/local/bin/

# Copy shared E2E libs and test runner
COPY tests/e2e-live-tests/lib.sh /test/lib.sh
COPY tests/e2e-live-tests/start-backend.sh /test/start-backend.sh
COPY tests/upstream/gitlab-ci-local/run.sh /test/run.sh
RUN chmod +x /test/*.sh

# Results volume
RUN mkdir -p /results

ENTRYPOINT ["/test/run.sh"]
